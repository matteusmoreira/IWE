[{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\admins\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[282,285],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[282,285],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1076,1079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1076,1079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1331,1334],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1331,1334],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2845,2848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2845,2848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":149,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4465,4468],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4465,4468],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4717,4720],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4717,4720],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":229,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6944,6947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6944,6947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\n\r\n// GET /api/admins/[id] - Buscar admin por ID\r\nexport async function GET(\r\n  _req: NextRequest,\r\n  context: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    const { id } = context.params;\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const { data: admin, error } = await supabase\r\n      .from('users')\r\n      .select(`\r\n        *,\r\n        admin_tenants (\r\n          tenant_id,\r\n          tenants (\r\n            id,\r\n            name,\r\n            slug\r\n          )\r\n        )\r\n      `)\r\n      .eq('id', id)\r\n      .single();\r\n\r\n    if (error) {\r\n      return NextResponse.json({ error: error.message }, { status: 404 });\r\n    }\r\n\r\n    return NextResponse.json({ admin });\r\n  } catch (error: any) {\r\n    console.error('Error fetching admin:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// PATCH /api/admins/[id] - Atualizar admin\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const adminClient = createAdminClient();\r\n\r\n    const { id } = context.params;\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Verificar se é superadmin\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError || userData?.role !== 'superadmin') {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n\r\n    // Parse do body\r\n    const body = await request.json();\r\n    const { name, phone, role, is_active, tenant_ids } = body;\r\n\r\n    // Buscar admin antigo\r\n    // Buscar admin antigo (usar Service Role para evitar bloqueios de RLS)\r\n    const { data: oldAdmin } = await adminClient\r\n      .from('users')\r\n      .select('*')\r\n      .eq('id', id)\r\n      .single();\r\n\r\n    // Atualizar admin\r\n    const { data: adminRows, error: updateError } = await adminClient\r\n      .from('users')\r\n      .update({\r\n        ...(name && { name }),\r\n        ...(phone !== undefined && { phone }),\r\n        ...(role && { role }),\r\n        ...(is_active !== undefined && { is_active }),\r\n      })\r\n      .eq('id', id)\r\n      .select();\r\n\r\n    const admin = Array.isArray(adminRows) ? adminRows[0] : adminRows as any;\r\n\r\n    if (updateError) {\r\n      console.error('Error updating users row:', updateError);\r\n      return NextResponse.json({ error: updateError.message }, { status: 500 });\r\n    }\r\n\r\n    // Atualizar vinculação com tenants se fornecido\r\n    if (tenant_ids !== undefined) {\r\n      // Remover vinculações antigas\r\n      const { error: delLinkError } = await adminClient\r\n        .from('admin_tenants')\r\n        .delete()\r\n        .eq('user_id', id);\r\n      if (delLinkError) {\r\n        console.error('Error deleting admin_tenants links:', delLinkError);\r\n        return NextResponse.json({ error: delLinkError.message }, { status: 500 });\r\n      }\r\n\r\n      // Criar novas vinculações\r\n      if (Array.isArray(tenant_ids) && tenant_ids.length > 0) {\r\n        const adminTenants = tenant_ids.map((tenant_id: string) => ({\r\n          user_id: id,\r\n          tenant_id,\r\n        }));\r\n\r\n        const { error: insertLinkError } = await adminClient\r\n          .from('admin_tenants')\r\n          .insert(adminTenants);\r\n        if (insertLinkError) {\r\n          console.error('Error inserting admin_tenants links:', insertLinkError);\r\n          return NextResponse.json({ error: insertLinkError.message }, { status: 500 });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await adminClient.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'UPDATE',\r\n      resource_type: 'admin',\r\n      resource_id: id,\r\n      changes: {\r\n        old: oldAdmin,\r\n        new: { name, phone, role, is_active, tenant_ids },\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({ admin });\r\n  } catch (error: any) {\r\n    console.error('Error updating admin:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// DELETE /api/admins/[id] - Deletar admin\r\nexport async function DELETE(\r\n  _req: NextRequest,\r\n  context: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const adminClient = createAdminClient();\r\n\r\n    const { id } = context.params;\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Verificar se é superadmin\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError || userData?.role !== 'superadmin') {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n\r\n    // Buscar admin para auditoria\r\n    const { data: admin } = await supabase\r\n      .from('users')\r\n      .select('*, auth_user_id')\r\n      .eq('id', id)\r\n      .single();\r\n\r\n    if (!admin) {\r\n      return NextResponse.json({ error: 'Admin not found' }, { status: 404 });\r\n    }\r\n\r\n    // Não permitir deletar a si mesmo\r\n    if (admin.auth_user_id === user.id) {\r\n      return NextResponse.json({ error: 'Cannot delete yourself' }, { status: 400 });\r\n    }\r\n\r\n    // Deletar do auth.users (cascade vai deletar da tabela users)\r\n    if (admin.auth_user_id) {\r\n      const { error: deleteAuthError } = await adminClient.auth.admin.deleteUser(admin.auth_user_id);\r\n      if (deleteAuthError) {\r\n        console.error('Error deleting auth user:', deleteAuthError);\r\n      }\r\n    }\r\n\r\n    // Deletar da tabela users (se ainda não foi deletado por cascade)\r\n    const { error: deleteUserError } = await adminClient\r\n      .from('users')\r\n      .delete()\r\n      .eq('id', id);\r\n    if (deleteUserError) {\r\n      console.error('Error deleting users row:', deleteUserError);\r\n    }\r\n\r\n    // Registrar auditoria\r\n    const { error: auditError } = await adminClient.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'DELETE',\r\n      resource_type: 'admin',\r\n      resource_id: id,\r\n      changes: { deleted: admin },\r\n    });\r\n    if (auditError) {\r\n      console.error('Error writing audit log:', auditError);\r\n    }\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error: any) {\r\n    console.error('Error deleting admin:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\admins\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":6,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1617,1620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1617,1620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4768,4771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4768,4771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\n\r\n// GET /api/admins - Listar todos os admins\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const adminClient = createAdminClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Verificar se é superadmin\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError || userData?.role !== 'superadmin') {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n\r\n    // Buscar admins com seus tenants\r\n    // Usar adminClient (service role) para ler admin_tenants, evitando bloqueios de RLS\r\n    const { data: admins, error: adminsError } = await adminClient\r\n      .from('users')\r\n      .select(`\r\n        *,\r\n        admin_tenants (\r\n          tenant_id,\r\n          tenants (\r\n            id,\r\n            name,\r\n            slug\r\n          )\r\n        )\r\n      `)\r\n      .in('role', ['admin', 'superadmin'])\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (adminsError) {\r\n      return NextResponse.json({ error: adminsError.message }, { status: 500 });\r\n    }\r\n\r\n    return NextResponse.json({ admins });\r\n  } catch (error: any) {\r\n    console.error('Error fetching admins:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// POST /api/admins - Criar novo admin\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const adminClient = createAdminClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Verificar se é superadmin\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError || userData?.role !== 'superadmin') {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n\r\n    // Parse do body\r\n    const body = await request.json();\r\n    const { email, name, phone, role, password, tenant_ids } = body;\r\n\r\n    // Validações\r\n    if (!email || !name || !password) {\r\n      return NextResponse.json({ error: 'Email, name and password are required' }, { status: 400 });\r\n    }\r\n\r\n    if (password.length < 6) {\r\n      return NextResponse.json({ error: 'Password must be at least 6 characters' }, { status: 400 });\r\n    }\r\n\r\n    // Criar usuário no auth.users usando admin API (service role)\r\n    const { data: authUser, error: createAuthError } = await adminClient.auth.admin.createUser({\r\n      email,\r\n      password,\r\n      email_confirm: true,\r\n      user_metadata: {\r\n        name,\r\n      },\r\n    });\r\n\r\n    if (createAuthError) {\r\n      return NextResponse.json({ error: createAuthError.message }, { status: 500 });\r\n    }\r\n\r\n    // Criar registro na tabela users\r\n    const { data: newUser, error: createUserError } = await adminClient\r\n      .from('users')\r\n      .insert({\r\n        auth_user_id: authUser.user.id,\r\n        email,\r\n        name,\r\n        phone: phone || null,\r\n        role: role || 'admin',\r\n        is_active: true,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (createUserError) {\r\n      // Se falhar, deletar o usuário do auth\r\n      await adminClient.auth.admin.deleteUser(authUser.user.id);\r\n      return NextResponse.json({ error: createUserError.message }, { status: 500 });\r\n    }\r\n\r\n    // Vincular a tenants se fornecido\r\n    if (tenant_ids && tenant_ids.length > 0) {\r\n      const adminTenants = tenant_ids.map((tenant_id: string) => ({\r\n        user_id: newUser.id,\r\n        tenant_id,\r\n      }));\r\n\r\n      const { error: linkError } = await adminClient\r\n        .from('admin_tenants')\r\n        .insert(adminTenants);\r\n\r\n      if (linkError) {\r\n        console.error('Error linking tenants:', linkError);\r\n      }\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await adminClient.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'CREATE',\r\n      resource_type: 'admin',\r\n      resource_id: newUser.id,\r\n      changes: { email, name, role, tenant_ids },\r\n    });\r\n\r\n    return NextResponse.json({ admin: newUser }, { status: 201 });\r\n  } catch (error: any) {\r\n    console.error('Error creating admin:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\diagnostics\\supabase-auth\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_req' is defined but never used.","line":5,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1189,1192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1189,1192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest } from 'next/server'\r\n\r\n// Pequeno diagnóstico para validar a ANON KEY do Supabase sem expor segredos.\r\n// Faz um GET em /auth/v1/settings usando o apikey do ambiente e retorna apenas o status.\r\nexport async function GET(_req: NextRequest) {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n  if (!url || !anon) {\r\n    return Response.json(\r\n      {\r\n        ok: false,\r\n        status: 500,\r\n        error: 'Variáveis de ambiente ausentes: NEXT_PUBLIC_SUPABASE_URL / NEXT_PUBLIC_SUPABASE_ANON_KEY',\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n\r\n  try {\r\n    const authSettingsUrl = `${url}/auth/v1/settings`\r\n    const resp = await fetch(authSettingsUrl, {\r\n      headers: {\r\n        apikey: anon,\r\n        'X-Client-Info': 'diagnostics',\r\n      },\r\n    })\r\n\r\n    // Não retornamos o payload bruto para não vazar informações.\r\n    return Response.json(\r\n      {\r\n        ok: resp.ok,\r\n        status: resp.status,\r\n        note: 'Se ok=false e status=401/403, normalmente a ANON KEY está inválida ou não corresponde ao projeto.',\r\n      },\r\n      { status: resp.ok ? 200 : 200 }\r\n    )\r\n  } catch (e: any) {\r\n    return Response.json(\r\n      {\r\n        ok: false,\r\n        status: 500,\r\n        error: e?.message || 'Falha ao contatar Supabase Auth',\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\emails\\send\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1937,1940],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1937,1940],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3089,3092],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3089,3092],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":105,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3915,3918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3915,3918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3974,3977],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3974,3977],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { sendEmail } from '@/lib/resend';\r\nimport { parseTemplateVariables } from '@/lib/utils';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  // Body esperado:\r\n  // {\r\n  //   tenant_id: string,\r\n  //   to: string | string[],\r\n  //   subject?: string,\r\n  //   html?: string,\r\n  //   template_key?: string, // ex.: 'payment_approved_email' ou 'manual'\r\n  //   variables?: Record<string,string>,\r\n  //   submission_id?: string, // opcional para preencher variáveis com dados da submissão\r\n  // }\r\n  const body = await request.json();\r\n  const { tenant_id, to, subject, html, template_key, variables = {}, submission_id, reply_to, bcc } = body;\r\n\r\n  if (!tenant_id || !to) {\r\n    return NextResponse.json({ error: 'tenant_id e to são obrigatórios' }, { status: 400 });\r\n  }\r\n\r\n  // Verificar permissão do admin\r\n  const { data: adminData, error: adminError } = await supabase\r\n    .from('admins')\r\n    .select('tenant_id')\r\n    .eq('user_id', user.id)\r\n    .eq('tenant_id', tenant_id)\r\n    .single();\r\n\r\n  if (adminError || !adminData) {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Validar envs Resend\r\n  if (!process.env.RESEND_API_KEY || !process.env.RESEND_FROM) {\r\n    return NextResponse.json({ error: 'Resend não configurado (RESEND_API_KEY/RESEND_FROM)' }, { status: 500 });\r\n  }\r\n\r\n  // Renderizar HTML\r\n  let finalHtml = html as string | undefined;\r\n  let finalSubject = subject as string | undefined;\r\n  let usedTemplateId: string | null = null;\r\n\r\n  // Se tiver submission_id, buscar para enriquecer variáveis\r\n  let submission: any = null;\r\n  if (submission_id) {\r\n    const { data: sub } = await supabase\r\n      .from('submissions')\r\n      .select('*')\r\n      .eq('id', submission_id)\r\n      .single();\r\n    submission = sub;\r\n  }\r\n\r\n  // Se template_key informado, buscar template\r\n  if (template_key) {\r\n    const { data: template, error: tmplError } = await supabase\r\n      .from('message_templates')\r\n      .select('*')\r\n      .is('tenant_id', null)\r\n      .eq('key', template_key)\r\n      .eq('is_active', true)\r\n      .single();\r\n    if (tmplError || !template) {\r\n      return NextResponse.json({ error: 'Template global não encontrado ou inativo' }, { status: 404 });\r\n    }\r\n    usedTemplateId = template.id;\r\n    // Preparar variáveis: combinar corpo + submissão\r\n    const v = {\r\n      nome_completo: submission?.data?.nome_completo || submission?.data?.nome || submission?.data?.name,\r\n      curso: submission?.data?.curso || submission?.data?.course,\r\n      polo: submission?.tenant_name || '',\r\n      valor: submission?.payment_amount != null ? String(submission.payment_amount) : undefined,\r\n      ...submission?.data,\r\n      ...variables,\r\n    } as Record<string, any>;\r\n    finalHtml = parseTemplateVariables(template.content, v);\r\n    finalSubject = finalSubject || template.title;\r\n  }\r\n\r\n  if (!finalHtml || !finalSubject) {\r\n    return NextResponse.json({ error: 'Informe html+subject ou um template_key válido' }, { status: 400 });\r\n  }\r\n\r\n  try {\r\n    const result = await sendEmail({ to, subject: finalSubject, html: finalHtml, replyTo: reply_to, bcc });\r\n    // Registrar auditoria (sem expor segredos)\r\n    await supabase.from('audit_logs').insert({\r\n      admin_id: user.id,\r\n      tenant_id,\r\n      action: 'create',\r\n      resource_type: 'email',\r\n      resource_id: usedTemplateId, // pode ser null quando html custom\r\n      details: { message: 'Email enviado via Resend', to_count: Array.isArray(to) ? to.length : 1 },\r\n    });\r\n    return NextResponse.json({ id: (result as any)?.data?.id || null, success: true });\r\n  } catch (err: any) {\r\n    console.error('Erro ao enviar e-mail:', String(err).slice(0, 300));\r\n    return NextResponse.json({ error: 'Falha ao enviar e-mail' }, { status: 500 });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\forms\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[233,236],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[233,236],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1219,1222],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1219,1222],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1227,1230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1227,1230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1336,1339],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1336,1339],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1597,1600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1597,1600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2894,2897],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2894,2897],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'form' is assigned a value but never used.","line":109,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":109,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":139,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4126,4129],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4126,4129],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":196,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5725,5728],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5725,5728],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5986,5989],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5986,5989],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":240,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":240,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7066,7069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7066,7069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'submissionsError' is assigned a value but never used.","line":247,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":247,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":280,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":280,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8274,8277],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8274,8277],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\n// GET /api/forms/[id] - Buscar formulário por ID\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const { data: form, error } = await supabase\r\n      .from('form_definitions')\r\n      .select(`\r\n        *,\r\n        tenants (\r\n          id,\r\n          name,\r\n          slug\r\n        ),\r\n        form_fields (\r\n          id,\r\n          label,\r\n          name,\r\n          type,\r\n          required,\r\n          placeholder,\r\n          options,\r\n          validation_rules,\r\n          order_index,\r\n          is_active\r\n        )\r\n      `)\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    if (error) {\r\n      return NextResponse.json({ error: error.message }, { status: 404 });\r\n    }\r\n\r\n    // Ordenar campos por order_index\r\n    if (form.form_fields) {\r\n      form.form_fields.sort((a: any, b: any) => a.order_index - b.order_index);\r\n    }\r\n\r\n    return NextResponse.json({ form });\r\n  } catch (error: any) {\r\n    console.error('Error fetching form:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// PATCH /api/forms/[id] - Atualizar formulário\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usuário\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role, admin_tenants(tenant_id)')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Parse do body\r\n    const body = await request.json();\r\n    const { description, is_active, settings, fields, tenant_id } = body;\r\n    const name: string | undefined = body.name ?? body.title;\r\n\r\n    // Buscar form antigo para auditoria\r\n    const { data: oldForm } = await supabase\r\n      .from('form_definitions')\r\n      .select('*, form_fields(*)')\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    if (!oldForm) {\r\n      return NextResponse.json({ error: 'Form not found' }, { status: 404 });\r\n    }\r\n\r\n    // Verificar se usuário tem acesso ao tenant do form\r\n    if (userData.role !== 'superadmin') {\r\n      const tenantIds = userData.admin_tenants?.map((at: any) => at.tenant_id) || [];\r\n      if (!tenantIds.includes(oldForm.tenant_id)) {\r\n        return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n      }\r\n    }\r\n\r\n    // Atualizar formulário\r\n    const { data: form, error: updateError } = await supabase\r\n      .from('form_definitions')\r\n      .update({\r\n        ...(name && { name }),\r\n        ...(description !== undefined && { description }),\r\n        ...(is_active !== undefined && { is_active }),\r\n        ...(settings && { settings }),\r\n        // Permitir alterar tenant apenas para superadmin\r\n        ...(userData.role === 'superadmin' && body.hasOwnProperty('tenant_id')\r\n          ? { tenant_id: tenant_id ?? null }\r\n          : {}),\r\n      })\r\n      .eq('id', params.id)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      return NextResponse.json({ error: updateError.message }, { status: 500 });\r\n    }\r\n\r\n    // Atualizar campos se fornecidos\r\n    if (fields !== undefined) {\r\n      // Deletar campos antigos\r\n      await supabase\r\n        .from('form_fields')\r\n        .delete()\r\n        .eq('form_definition_id', params.id);\r\n\r\n      // Criar novos campos\r\n      if (fields.length > 0) {\r\n        const formFields = fields.map((field: any, index: number) => ({\r\n          form_definition_id: params.id,\r\n          label: field.label,\r\n          name: field.name,\r\n          type: field.type,\r\n          required: field.required ?? false,\r\n          placeholder: field.placeholder || null,\r\n          options: field.options || [],\r\n          validation_rules: field.validation_rules || {},\r\n          order_index: field.order_index ?? index,\r\n          is_active: field.is_active ?? true,\r\n        }));\r\n\r\n        const { error: fieldsError } = await supabase\r\n          .from('form_fields')\r\n          .insert(formFields);\r\n\r\n        if (fieldsError) {\r\n          return NextResponse.json({ error: fieldsError.message }, { status: 500 });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'UPDATE',\r\n      resource_type: 'form',\r\n      resource_id: params.id,\r\n      changes: {\r\n        old: oldForm,\r\n        new: { name, description, is_active, settings, fields_count: fields?.length },\r\n      },\r\n    });\r\n\r\n    // Buscar form completo atualizado\r\n    const { data: completeForm } = await supabase\r\n      .from('form_definitions')\r\n      .select(`\r\n        *,\r\n        form_fields (\r\n          id,\r\n          label,\r\n          name,\r\n          type,\r\n          required,\r\n          placeholder,\r\n          options,\r\n          validation_rules,\r\n          order_index,\r\n          is_active\r\n        )\r\n      `)\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    return NextResponse.json({ form: completeForm });\r\n  } catch (error: any) {\r\n    console.error('Error updating form:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// DELETE /api/forms/[id] - Deletar formulário\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usuário\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role, admin_tenants(tenant_id)')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Buscar form para auditoria e verificação\r\n    const { data: form } = await supabase\r\n      .from('form_definitions')\r\n      .select('*')\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    if (!form) {\r\n      return NextResponse.json({ error: 'Form not found' }, { status: 404 });\r\n    }\r\n\r\n    // Verificar se usuário tem acesso ao tenant do form\r\n    if (userData.role !== 'superadmin') {\r\n      const tenantIds = userData.admin_tenants?.map((at: any) => at.tenant_id) || [];\r\n      if (!tenantIds.includes(form.tenant_id)) {\r\n        return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n      }\r\n    }\r\n\r\n    // Verificar se há submissões vinculadas\r\n    const { data: submissions, error: submissionsError } = await supabase\r\n      .from('submissions')\r\n      .select('id')\r\n      .eq('form_definition_id', params.id)\r\n      .limit(1);\r\n\r\n    if (submissions && submissions.length > 0) {\r\n      return NextResponse.json(\r\n        { error: 'Cannot delete form with existing submissions' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Deletar form (cascade vai deletar os campos)\r\n    const { error: deleteError } = await supabase\r\n      .from('form_definitions')\r\n      .delete()\r\n      .eq('id', params.id);\r\n\r\n    if (deleteError) {\r\n      return NextResponse.json({ error: deleteError.message }, { status: 500 });\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'DELETE',\r\n      resource_type: 'form',\r\n      resource_id: params.id,\r\n      changes: { deleted: form },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error: any) {\r\n    console.error('Error deleting form:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\forms\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":6,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1524,1527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1524,1527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":73,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2221,2224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2221,2224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":73,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2229,2232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2229,2232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2370,2373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2370,2373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3751,3754],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3751,3754],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":137,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4427,4430],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4427,4430],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5077,5080],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5077,5080],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":184,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5872,5875],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5872,5875],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":239,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7499,7502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7499,7502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { slugify } from '@/lib/utils';\r\n\r\n// GET /api/forms - Listar todos os formulários\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usuário e verificar role\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role, admin_tenants(tenant_id)')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Query base\r\n    let query = supabase\r\n      .from('form_definitions')\r\n      .select(`\r\n        *,\r\n        tenants (\r\n          id,\r\n          name,\r\n          slug\r\n        ),\r\n        form_fields (\r\n          id,\r\n          label,\r\n          name,\r\n          type,\r\n          required,\r\n          placeholder,\r\n          options,\r\n          validation_rules,\r\n          order_index,\r\n          is_active\r\n        )\r\n      `)\r\n      .order('created_at', { ascending: false });\r\n\r\n    // Filtrar por tenants se não for superadmin\r\n    if (userData.role !== 'superadmin') {\r\n      const tenantIds = userData.admin_tenants?.map((at: any) => at.tenant_id) || [];\r\n      if (tenantIds.length === 0) {\r\n        // Admin sem polos: ainda pode ver formulários globais\r\n        query = query.is('tenant_id', null);\r\n      } else {\r\n        // Incluir formulários globais e dos polos administrados\r\n        query = query.or(`tenant_id.is.null,tenant_id.in.(${tenantIds.join(',')})`);\r\n      }\r\n    }\r\n\r\n    const { data: forms, error: formsError } = await query;\r\n\r\n    if (formsError) {\r\n      return NextResponse.json({ error: formsError.message }, { status: 500 });\r\n    }\r\n\r\n    // Ordenar campos por order_index\r\n    const formsWithSortedFields = forms?.map(form => ({\r\n      ...form,\r\n      form_fields: form.form_fields?.sort((a: any, b: any) => a.order_index - b.order_index) || []\r\n    }));\r\n\r\n    return NextResponse.json({ forms: formsWithSortedFields });\r\n  } catch (error: any) {\r\n    console.error('Error fetching forms:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// POST /api/forms - Criar novo formulário\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usuário\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role, admin_tenants(tenant_id)')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Parse do body\r\n    const body = await request.json();\r\n    const { tenant_id, description, is_active, settings, fields } = body;\r\n    const name: string | undefined = body.name ?? body.title;\r\n\r\n    // Validações\r\n    if (!name) {\r\n      return NextResponse.json({ error: 'Nome é obrigatório' }, { status: 400 });\r\n    }\r\n\r\n    // Verificar se usuário tem acesso ao tenant\r\n    if (userData.role !== 'superadmin') {\r\n      // Admin deve informar um tenant válido\r\n      const tenantIds = userData.admin_tenants?.map((at: any) => at.tenant_id) || [];\r\n      if (!tenant_id) {\r\n        return NextResponse.json({ error: 'Admins devem selecionar um polo' }, { status: 400 });\r\n      }\r\n      if (!tenantIds.includes(tenant_id)) {\r\n        return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n      }\r\n    }\r\n\r\n    // Gerar slug único por tenant\r\n    const baseSlug = slugify(name);\r\n    let slugCandidate = baseSlug;\r\n\r\n    // Fallback seguro caso o título gere slug vazio\r\n    if (!slugCandidate) {\r\n      slugCandidate = `form-${Math.random().toString(36).slice(2, 8)}`;\r\n    }\r\n\r\n    // Buscar slugs existentes que começam com o baseSlug para evitar colisão\r\n    let existingSlugs: any[] = [];\r\n    if (tenant_id) {\r\n      const { data } = await supabase\r\n        .from('form_definitions')\r\n        .select('slug')\r\n        .eq('tenant_id', tenant_id)\r\n        .ilike('slug', `${baseSlug}%`);\r\n      existingSlugs = data || [];\r\n    } else {\r\n      // Formulário global: checar slugs globais (tenant_id IS NULL)\r\n      const { data } = await supabase\r\n        .from('form_definitions')\r\n        .select('slug')\r\n        .is('tenant_id', null)\r\n        .ilike('slug', `${baseSlug}%`);\r\n      existingSlugs = data || [];\r\n    }\r\n\r\n    if (existingSlugs && existingSlugs.length > 0) {\r\n      const used = new Set(existingSlugs.map((r: any) => r.slug));\r\n      if (used.has(slugCandidate)) {\r\n        let i = 2;\r\n        while (used.has(`${baseSlug}-${i}`)) i++;\r\n        slugCandidate = `${baseSlug}-${i}`;\r\n      }\r\n    }\r\n\r\n    // Criar formulário com slug\r\n    const { data: form, error: formError } = await supabase\r\n      .from('form_definitions')\r\n      .insert({\r\n        tenant_id,\r\n        name,\r\n        slug: slugCandidate,\r\n        description: description || null,\r\n        is_active: is_active ?? true,\r\n        settings: settings || {},\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (formError) {\r\n      return NextResponse.json({ error: formError.message }, { status: 500 });\r\n    }\r\n\r\n    // Criar campos se fornecidos\r\n    if (fields && fields.length > 0) {\r\n      const formFields = fields.map((field: any, index: number) => ({\r\n        form_definition_id: form.id,\r\n        label: field.label,\r\n        name: field.name,\r\n        type: field.type,\r\n        required: field.required ?? false,\r\n        placeholder: field.placeholder || null,\r\n        options: field.options || [],\r\n        validation_rules: field.validation_rules || {},\r\n        order_index: field.order_index ?? index,\r\n        is_active: field.is_active ?? true,\r\n      }));\r\n\r\n      const { error: fieldsError } = await supabase\r\n        .from('form_fields')\r\n        .insert(formFields);\r\n\r\n      if (fieldsError) {\r\n        // Rollback: deletar o form\r\n        await supabase.from('form_definitions').delete().eq('id', form.id);\r\n        return NextResponse.json({ error: fieldsError.message }, { status: 500 });\r\n      }\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'CREATE',\r\n      resource_type: 'form',\r\n      resource_id: form.id,\r\n      changes: { name, description, tenant_id, fields_count: fields?.length || 0 },\r\n    });\r\n\r\n    // Buscar form completo com campos\r\n    const { data: completeForm } = await supabase\r\n      .from('form_definitions')\r\n      .select(`\r\n        *,\r\n        form_fields (\r\n          id,\r\n          label,\r\n          name,\r\n          type,\r\n          required,\r\n          placeholder,\r\n          options,\r\n          validation_rules,\r\n          order_index,\r\n          is_active\r\n        )\r\n      `)\r\n      .eq('id', form.id)\r\n      .single();\r\n\r\n    return NextResponse.json({ form: completeForm }, { status: 201 });\r\n  } catch (error: any) {\r\n    console.error('Error creating form:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\integration\\mercadopago\\status\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2089,2092],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2089,2092],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2378,2381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2378,2381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3363,3366],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3363,3366],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3403,3406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3403,3406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3434,3437],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3434,3437],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3490,3493],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3490,3493],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { getAppUrl, getPreferenceClientForTenant, getAccessTokenForTenant, getGlobalAccessToken, maskToken } from '@/lib/mercadopago';\r\n\r\n// GET /api/integration/mercadopago/status\r\n// Checa rapidamente se as variáveis de ambiente estão configuradas e\r\n// tenta criar uma preferência mínima para validar acesso ao Mercado Pago.\r\nexport async function GET(request: NextRequest) {\r\n  const supabase = await createClient();\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  // Verificar papel do usuário: permitido para admin e superadmin\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  const role = roleRow?.role;\r\n  if (role !== 'admin' && role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Identificar tenant opcionalmente via query string\r\n  const url = new URL(request.url);\r\n  const tenantId = url.searchParams.get('tenant_id') || undefined;\r\n\r\n  // Admin só pode consultar tenants aos quais possui acesso\r\n  if (tenantId && role === 'admin') {\r\n    const { data: allowedTenants } = await supabase\r\n      .from('tenants')\r\n      .select('id');\r\n    const allowedIds = (allowedTenants || []).map(t => t.id);\r\n    if (!allowedIds.includes(tenantId)) {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n  }\r\n\r\n  // Coleta de token: global (banco) > tenant > ambiente\r\n  const fromGlobal = await getGlobalAccessToken();\r\n  const fromTenant = tenantId ? (await getAccessTokenForTenant(tenantId)) : null;\r\n  const rawToken = fromGlobal ?? fromTenant ?? process.env.MP_ACCESS_TOKEN ?? '';\r\n  const tokenMasked = maskToken(rawToken);\r\n\r\n  let appUrl = '';\r\n  let appUrlError: string | null = null;\r\n  try {\r\n    appUrl = getAppUrl();\r\n  } catch (e: any) {\r\n    appUrlError = String(e?.message || e);\r\n  }\r\n\r\n  const env = {\r\n    app_url_configured: !!appUrl && !appUrlError,\r\n    mp_token_configured: !!rawToken && rawToken.trim() !== '',\r\n  };\r\n\r\n  // Tentar criar uma preferência mínima para validar acesso ao MP\r\n  let testPreference: any = null;\r\n  try {\r\n    const preference = await getPreferenceClientForTenant(tenantId);\r\n    const back_urls = {\r\n      success: `${appUrl}/form/pagamento/sucesso`,\r\n      failure: `${appUrl}/form/pagamento/falha`,\r\n      pending: `${appUrl}/form/pagamento/pendente`,\r\n    };\r\n\r\n    const isHttpsPublic = appUrl.startsWith('https://');\r\n    const result = await preference.create({\r\n      body: {\r\n        items: [\r\n          {\r\n            id: 'PING-IWE',\r\n            title: 'Ping IWE',\r\n            quantity: 1,\r\n            unit_price: 1,\r\n            currency_id: 'BRL',\r\n          },\r\n        ],\r\n        payer: { email: 'teste@iwe.local' },\r\n        external_reference: `status-check-${Date.now()}`,\r\n        back_urls,\r\n        ...(isHttpsPublic ? { auto_return: 'approved' as const } : {}),\r\n        binary_mode: true,\r\n        notification_url: `${appUrl}/api/webhooks/mercadopago`,\r\n      },\r\n    });\r\n\r\n    testPreference = {\r\n      success: true,\r\n      id: (result as any)?.id,\r\n      init_point: (result as any)?.init_point ?? (result as any)?.sandbox_init_point,\r\n    };\r\n  } catch (sdkError: any) {\r\n    testPreference = {\r\n      success: false,\r\n      error: 'Erro ao criar preferência de teste',\r\n      detail: sdkError?.message || sdkError?.error || String(sdkError),\r\n      meta: {\r\n        status: sdkError?.status,\r\n        code: sdkError?.code,\r\n        blocked_by: sdkError?.blocked_by,\r\n      },\r\n    };\r\n  }\r\n\r\n  return NextResponse.json({\r\n    env,\r\n    app_url: appUrl || null,\r\n    app_url_error: appUrlError,\r\n    mp_token_masked: tokenMasked,\r\n    test_preference: testPreference,\r\n    // Compatibilidade com UI atual\r\n    has_app_url: env.app_url_configured,\r\n    has_mp_access_token: env.mp_token_configured,\r\n    masked_mp_access_token: tokenMasked,\r\n    preference_test: testPreference,\r\n  });\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\messages\\process-scheduled\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_req' is defined but never used.","line":17,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":157,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6359,6362],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6359,6362],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { parseTemplateVariables } from '@/lib/utils';\r\nimport { sendEmail } from '@/lib/resend';\r\n\r\nfunction normalizePhone(input: string): string {\r\n  const cleaned = String(input).replace(/\\D/g, '');\r\n  let number = cleaned;\r\n  if (/^\\d{11}$/.test(cleaned)) {\r\n    number = `55${cleaned}`;\r\n  } else if (/^\\d{13}$/.test(cleaned) && cleaned.startsWith('55')) {\r\n    number = cleaned;\r\n  }\r\n  return number;\r\n}\r\n\r\nexport async function POST(_req: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n\r\n    const now = new Date().toISOString();\r\n\r\n    // RLS limita aos tenants do usuário automaticamente\r\n    const { data: jobs, error } = await supabase\r\n      .from('schedule_jobs')\r\n      .select('*')\r\n      .lte('scheduled_for', now)\r\n      .eq('status', 'PENDING')\r\n      .order('scheduled_for', { ascending: true });\r\n    if (error) return NextResponse.json({ error: error.message }, { status: 500 });\r\n\r\n    let processed = 0;\r\n    for (const job of jobs || []) {\r\n      const channel = job.metadata?.channel || 'whatsapp';\r\n      try {\r\n        if (channel === 'whatsapp') {\r\n          // Buscar configuração GLOBAL do WhatsApp (unificada)\r\n          const { data: whatsappConfig } = await supabase\r\n            .from('whatsapp_global_configs')\r\n            .select('*')\r\n            .eq('is_active', true)\r\n            .order('updated_at', { ascending: false })\r\n            .limit(1)\r\n            .maybeSingle();\r\n          if (!whatsappConfig) throw new Error('WhatsApp não configurado');\r\n\r\n          // Montar conteúdo\r\n          let content = job.metadata?.message || '';\r\n          let templateId: string | null = null;\r\n          const templateKey = job.metadata?.template_key;\r\n          if (templateKey) {\r\n            const { data: template } = await supabase\r\n              .from('message_templates')\r\n              .select('*')\r\n              .is('tenant_id', null)\r\n              .eq('key', templateKey)\r\n              .eq('is_active', true)\r\n              .single();\r\n            if (!template) throw new Error('Template global não encontrado');\r\n            templateId = template.id;\r\n            content = parseTemplateVariables(template.content, job.metadata?.variables || {});\r\n          }\r\n          if (!content) throw new Error('Conteúdo vazio');\r\n\r\n          // Enviar para cada telefone do job\r\n          for (const raw of job.recipient_phones || []) {\r\n            const normalized = normalizePhone(String(raw));\r\n            const resp = await fetch(`${whatsappConfig.api_base_url}/message/sendText/${whatsappConfig.instance_id}`, {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json', 'apikey': whatsappConfig.token },\r\n              body: JSON.stringify({ number: normalized, text: content }),\r\n            });\r\n            if (!resp.ok) {\r\n              const errText = await resp.text().catch(() => '');\r\n              await supabase.from('message_logs').insert({\r\n                tenant_id: job.tenant_id,\r\n                template_id: templateId,\r\n                submission_id: null,\r\n                recipient_phone: String(raw),\r\n                message_content: content,\r\n                status: 'FAILED',\r\n                error_message: `Evolution API ${resp.status}: ${errText?.slice(0, 300)}`,\r\n              });\r\n            } else {\r\n              await supabase.from('message_logs').insert({\r\n                tenant_id: job.tenant_id,\r\n                template_id: templateId,\r\n                submission_id: null,\r\n                recipient_phone: String(raw),\r\n                message_content: content,\r\n                status: 'SENT',\r\n                sent_at: new Date().toISOString(),\r\n              });\r\n            }\r\n          }\r\n        } else if (channel === 'email') {\r\n          // Montar email\r\n          const to: string[] = job.metadata?.to || [];\r\n          if (!to.length) throw new Error('Destinatários vazios');\r\n          let subject: string = job.metadata?.subject || 'Mensagem';\r\n          let html: string = job.metadata?.html || job.metadata?.message || '';\r\n          const key = job.metadata?.template_key;\r\n          if (key) {\r\n            const { data: template } = await supabase\r\n              .from('message_templates')\r\n              .select('*')\r\n              .is('tenant_id', null)\r\n              .eq('key', key)\r\n              .eq('is_active', true)\r\n              .single();\r\n            if (template) {\r\n              subject = template.title || subject;\r\n              html = parseTemplateVariables(template.content, job.metadata?.variables || {});\r\n            }\r\n          }\r\n\r\n          for (const email of to) {\r\n            try {\r\n              await sendEmail({ to: email, subject, html, replyTo: process.env.RESEND_REPLY_TO });\r\n              await supabase.from('audit_logs').insert({\r\n                tenant_id: job.tenant_id,\r\n                action: 'CREATE',\r\n                resource_type: 'email',\r\n                resource_id: null,\r\n                details: { message: 'Email agendado enviado', to: '***' },\r\n              });\r\n            } catch (e) {\r\n              await supabase.from('audit_logs').insert({\r\n                tenant_id: job.tenant_id,\r\n                action: 'CREATE',\r\n                resource_type: 'email',\r\n                resource_id: null,\r\n                details: { message: 'Email agendado falhou', to: '***', error: String(e).slice(0, 300) },\r\n              });\r\n            }\r\n          }\r\n        }\r\n\r\n        // Atualiza job para EXECUTED\r\n        await supabase\r\n          .from('schedule_jobs')\r\n          .update({ status: 'EXECUTED', executed_at: new Date().toISOString() })\r\n          .eq('id', job.id);\r\n        processed++;\r\n      } catch (e) {\r\n        // Marca como FAILED\r\n        await supabase\r\n          .from('schedule_jobs')\r\n          .update({ status: 'FAILED', executed_at: new Date().toISOString(), metadata: { ...job.metadata, last_error: String(e).slice(0, 300) } })\r\n          .eq('id', job.id);\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ processed });\r\n  } catch (error: any) {\r\n    console.error('Process scheduled error:', error);\r\n    return NextResponse.json({ error: 'Falha ao processar agendamentos' }, { status: 500 });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\messages\\schedule\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[399,402],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[399,402],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[434,437],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[434,437],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1733,1736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1733,1736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2816,2819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2816,2819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\ntype ScheduleBody = {\r\n  tenant_id: string;\r\n  channel: 'whatsapp' | 'email';\r\n  scheduled_for: string; // ISO string\r\n  recipient_phones?: string[];\r\n  to?: string[];\r\n  template_key?: string;\r\n  message?: string;\r\n  subject?: string;\r\n  html?: string;\r\n  variables?: Record<string, any>;\r\n  metadata?: Record<string, any>;\r\n};\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const body: ScheduleBody = await request.json();\r\n    const { tenant_id, channel, scheduled_for } = body;\r\n    if (!tenant_id || !channel || !scheduled_for) {\r\n      return NextResponse.json({ error: 'tenant_id, channel e scheduled_for são obrigatórios' }, { status: 400 });\r\n    }\r\n\r\n    // Verifica usuário\r\n    const { data: userRow, error: userErr } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n    if (userErr || !userRow) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Monta dados do job\r\n    const baseMetadata = {\r\n      channel,\r\n      template_key: body.template_key || null,\r\n      variables: body.variables || {},\r\n      ...(body.metadata || {}),\r\n    };\r\n\r\n    // recipient_phones não pode ser null; usar [] para e-mail\r\n    const recipient_phones = channel === 'whatsapp' ? (body.recipient_phones || []) : [];\r\n\r\n    const insertPayload: any = {\r\n      tenant_id,\r\n      template_id: null,\r\n      recipient_phones,\r\n      scheduled_for,\r\n      status: 'PENDING',\r\n      metadata: {\r\n        ...baseMetadata,\r\n        to: body.to || undefined,\r\n        subject: body.subject || undefined,\r\n        html: body.html || undefined,\r\n        message: body.message || undefined,\r\n      },\r\n      created_by: userRow.id,\r\n    };\r\n\r\n    const { data: job, error: insertError } = await supabase\r\n      .from('schedule_jobs')\r\n      .insert(insertPayload)\r\n      .select()\r\n      .single();\r\n\r\n    if (insertError) {\r\n      return NextResponse.json({ error: insertError.message }, { status: 500 });\r\n    }\r\n\r\n    // Auditoria mínima\r\n    await supabase.from('audit_logs').insert({\r\n      tenant_id,\r\n      user_id: userRow.id,\r\n      action: 'CREATE',\r\n      resource_type: 'schedule_job',\r\n      resource_id: job.id,\r\n      changes: { channel, scheduled_for, metadata: insertPayload.metadata, recipient_phones_count: recipient_phones.length },\r\n    });\r\n\r\n    return NextResponse.json({ job }, { status: 201 });\r\n  } catch (error: any) {\r\n    console.error('Schedule error:', error);\r\n    return NextResponse.json({ error: 'Falha ao agendar' }, { status: 500 });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\metrics\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[946,949],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[946,949],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6021,6024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6021,6024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6129,6132],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6129,6132],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { searchParams } = new URL(request.url);\r\n  const tenantId = searchParams.get('tenant_id');\r\n  const monthParam = searchParams.get('month');\r\n  const yearParam = searchParams.get('year');\r\n\r\n  try {\r\n    // Buscar role e relação com tenants\r\n    const { data: userData } = await supabase\r\n      .from('users')\r\n      .select('role, admin_tenants(tenant_id)')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    const isSuperAdmin = userData?.role === 'superadmin';\r\n    const adminTenantIds = userData?.admin_tenants?.map((at: any) => at.tenant_id) || [];\r\n\r\n    // Definir intervalo de datas por mês/ano\r\n    const now = new Date();\r\n    const year = yearParam ? parseInt(yearParam) : now.getFullYear();\r\n    const month = monthParam ? parseInt(monthParam) : (now.getMonth() + 1);\r\n    const startDate = new Date(year, month - 1, 1);\r\n    const endDate = new Date(year, month, 1); // exclusivo\r\n\r\n    // Total submissions\r\n    let submissionsCountQuery = supabase\r\n      .from('submissions')\r\n      .select('*', { count: 'exact', head: true })\r\n      .gte('created_at', startDate.toISOString())\r\n      .lt('created_at', endDate.toISOString());\r\n\r\n    // Filtrar por tenant se informado; caso contrário, RLS e papel definem visibilidade\r\n    if (tenantId) {\r\n      submissionsCountQuery = submissionsCountQuery.eq('tenant_id', tenantId);\r\n    } else if (!isSuperAdmin && adminTenantIds.length > 0) {\r\n      submissionsCountQuery = submissionsCountQuery.in('tenant_id', adminTenantIds);\r\n    }\r\n\r\n    const { count: totalSubmissions } = await submissionsCountQuery;\r\n\r\n    // Total revenue (approved payments)\r\n    let paymentsQuery = supabase\r\n      .from('submissions')\r\n      .select('payment_amount, payment_status, created_at, tenant_id')\r\n      .eq('payment_status', 'PAGO')\r\n      .gte('created_at', startDate.toISOString())\r\n      .lt('created_at', endDate.toISOString());\r\n\r\n    if (tenantId) {\r\n      paymentsQuery = paymentsQuery.eq('tenant_id', tenantId);\r\n    } else if (!isSuperAdmin && adminTenantIds.length > 0) {\r\n      paymentsQuery = paymentsQuery.in('tenant_id', adminTenantIds);\r\n    }\r\n\r\n    const { data: paymentsData } = await paymentsQuery;\r\n    const totalRevenue = paymentsData?.reduce((sum, p) => sum + (Number(p.payment_amount) || 0), 0) || 0;\r\n\r\n    // Active forms\r\n    let activeFormsQuery = supabase\r\n      .from('form_definitions')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('is_active', true);\r\n    if (tenantId) {\r\n      activeFormsQuery = activeFormsQuery.eq('tenant_id', tenantId);\r\n    } else if (!isSuperAdmin && adminTenantIds.length > 0) {\r\n      activeFormsQuery = activeFormsQuery.in('tenant_id', adminTenantIds);\r\n    }\r\n    const { count: activeForms } = await activeFormsQuery;\r\n\r\n    // Submissions by day\r\n    let submissionsByDayQuery = supabase\r\n      .from('submissions')\r\n      .select('created_at, tenant_id')\r\n      .gte('created_at', startDate.toISOString())\r\n      .lt('created_at', endDate.toISOString())\r\n      .order('created_at');\r\n    if (tenantId) {\r\n      submissionsByDayQuery = submissionsByDayQuery.eq('tenant_id', tenantId);\r\n    } else if (!isSuperAdmin && adminTenantIds.length > 0) {\r\n      submissionsByDayQuery = submissionsByDayQuery.in('tenant_id', adminTenantIds);\r\n    }\r\n    const { data: submissionsByDay } = await submissionsByDayQuery;\r\n\r\n    // Process submissions by day\r\n    const dayMap = new Map<string, number>();\r\n    submissionsByDay?.forEach(s => {\r\n      const date = new Date(s.created_at).toISOString().split('T')[0];\r\n      dayMap.set(date, (dayMap.get(date) || 0) + 1);\r\n    });\r\n\r\n    const submissionsByDayArray = Array.from(dayMap.entries()).map(([date, count]) => ({\r\n      date,\r\n      count,\r\n    })).sort((a, b) => a.date.localeCompare(b.date));\r\n\r\n    // Revenue by day\r\n    let revenueByDayQuery = supabase\r\n      .from('submissions')\r\n      .select('created_at, payment_amount, payment_status, tenant_id')\r\n      .eq('payment_status', 'PAGO')\r\n      .gte('created_at', startDate.toISOString())\r\n      .lt('created_at', endDate.toISOString())\r\n      .order('created_at');\r\n    if (tenantId) {\r\n      revenueByDayQuery = revenueByDayQuery.eq('tenant_id', tenantId);\r\n    } else if (!isSuperAdmin && adminTenantIds.length > 0) {\r\n      revenueByDayQuery = revenueByDayQuery.in('tenant_id', adminTenantIds);\r\n    }\r\n    const { data: revenueByDayData } = await revenueByDayQuery;\r\n\r\n    const revenueDayMap = new Map<string, number>();\r\n    revenueByDayData?.forEach(s => {\r\n      const date = new Date(s.created_at).toISOString().split('T')[0];\r\n      revenueDayMap.set(date, (revenueDayMap.get(date) || 0) + (s.payment_amount || 0));\r\n    });\r\n\r\n    const revenueByDayArray = Array.from(revenueDayMap.entries()).map(([date, amount]) => ({\r\n      date,\r\n      amount,\r\n    })).sort((a, b) => a.date.localeCompare(b.date));\r\n\r\n    // Form performance\r\n    let formPerfQuery = supabase\r\n      .from('form_definitions')\r\n      .select(`\r\n        id,\r\n        name,\r\n        submissions!inner (\r\n          id,\r\n          payment_status,\r\n          created_at,\r\n          tenant_id\r\n        )\r\n      `)\r\n      .eq('is_active', true)\r\n      .gte('submissions.created_at', startDate.toISOString())\r\n      .lt('submissions.created_at', endDate.toISOString());\r\n    if (tenantId) {\r\n      formPerfQuery = formPerfQuery.eq('tenant_id', tenantId);\r\n    } else if (!isSuperAdmin && adminTenantIds.length > 0) {\r\n      formPerfQuery = formPerfQuery.in('tenant_id', adminTenantIds);\r\n    }\r\n    const { data: formData } = await formPerfQuery;\r\n\r\n    const formPerformance = formData?.map((form: any) => {\r\n      const submissions = form.submissions || [];\r\n      const approved = submissions.filter((s: any) => s.payment_status === 'PAGO').length;\r\n      return {\r\n        formId: form.id,\r\n        formTitle: form.name,\r\n        submissions: submissions.length,\r\n        conversions: approved,\r\n        conversionRate: submissions.length > 0 ? (approved / submissions.length) * 100 : 0,\r\n      };\r\n    }) || [];\r\n\r\n    // Payment stats\r\n    let paymentStatsQuery = supabase\r\n      .from('submissions')\r\n      .select('payment_status, created_at, tenant_id')\r\n      .gte('created_at', startDate.toISOString())\r\n      .lt('created_at', endDate.toISOString());\r\n    if (tenantId) {\r\n      paymentStatsQuery = paymentStatsQuery.eq('tenant_id', tenantId);\r\n    } else if (!isSuperAdmin && adminTenantIds.length > 0) {\r\n      paymentStatsQuery = paymentStatsQuery.in('tenant_id', adminTenantIds);\r\n    }\r\n    const { data: paymentStatsData } = await paymentStatsQuery;\r\n\r\n    const paymentStats = {\r\n      approved: paymentStatsData?.filter(p => p.payment_status === 'PAGO').length || 0,\r\n      pending: paymentStatsData?.filter(p => p.payment_status === 'PENDENTE').length || 0,\r\n      failed: paymentStatsData?.filter(p => p.payment_status === 'CANCELADO' || p.payment_status === 'REEMBOLSADO').length || 0,\r\n    };\r\n\r\n    // Conversion rate\r\n    const totalWithPayment = paymentStatsData?.length || 0;\r\n    const conversionRate = totalWithPayment > 0 \r\n      ? (paymentStats.approved / totalWithPayment) * 100 \r\n      : 0;\r\n\r\n    return NextResponse.json({\r\n      totalSubmissions: totalSubmissions || 0,\r\n      totalRevenue,\r\n      conversionRate,\r\n      activeForms: activeForms || 0,\r\n      submissionsByDay: submissionsByDayArray,\r\n      revenueByDay: revenueByDayArray,\r\n      formPerformance,\r\n      paymentStats,\r\n    });\r\n  } catch (error) {\r\n    console.error('Error fetching metrics:', error);\r\n    return NextResponse.json({ error: 'Failed to fetch metrics' }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\payments\\create-preference\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2682,2685],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2682,2685],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":119,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4226,4229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4226,4229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4323,4326],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4323,4326],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4379,4382],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4379,4382],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5528,5531],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5528,5531],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\nimport { getAppUrl, getPreferenceClientForTenant } from '@/lib/mercadopago';\r\n\r\n// Usamos o client ADMIN para bypass de RLS no backend.\r\n// Isso evita 404 por \"submissão não encontrada\" quando a política RLS bloqueia leitura com chave ANON.\r\nconst supabase = createAdminClient();\r\n\r\n// POST /api/payments/create-preference - Criar preferência de pagamento no Mercado Pago\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { submission_id } = body;\r\n\r\n    if (!submission_id) {\r\n      return NextResponse.json(\r\n        { error: 'submission_id é obrigatório', reason: 'MISSING_SUBMISSION_ID' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Buscar submissão (bypass RLS com Service Role)\r\n    const { data: submission, error: submissionError } = await supabase\r\n      .from('submissions')\r\n      .select(`\r\n        *,\r\n        tenants (\r\n          id,\r\n          name,\r\n          slug\r\n        ),\r\n        form_definitions (\r\n          id,\r\n          name,\r\n          settings\r\n        )\r\n      `)\r\n      .eq('id', submission_id)\r\n      .single();\r\n\r\n    if (submissionError || !submission) {\r\n      return NextResponse.json(\r\n        { error: 'Submissão não encontrada', reason: 'SUBMISSION_NOT_FOUND' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Verificar se já tem pagamento pendente\r\n    if (submission.payment_status !== 'PENDENTE') {\r\n      return NextResponse.json(\r\n        { error: 'Esta submissão não está pendente de pagamento', reason: 'NOT_PENDING' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Agora usamos credenciais por tenant quando disponíveis, com fallback para variável de ambiente.\r\n\r\n    // Preparar dados do pagamento\r\n    const amount = submission.payment_amount || submission.form_definitions.settings?.payment_amount || 0;\r\n    \r\n    if (amount <= 0) {\r\n      return NextResponse.json(\r\n        { error: 'Valor do pagamento inválido', reason: 'INVALID_AMOUNT' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Extrair informações do comprador dos dados do formulário\r\n    const payerName = submission.data.nome || submission.data.name || 'Comprador';\r\n    const payerEmail = submission.data.email || 'sem-email@example.com';\r\n    const payerPhone = submission.data.telefone || submission.data.phone || '';\r\n\r\n    // Criar preferência no Mercado Pago (global)\r\n    // Base URL da aplicação (preferir APP_URL do servidor; cair para NEXT_PUBLIC_APP_URL se necessário)\r\n    let appUrl: string;\r\n    try {\r\n      appUrl = getAppUrl();\r\n    } catch (e: any) {\r\n      return NextResponse.json(\r\n        { error: 'APP_URL/NEXT_PUBLIC_APP_URL não configurado', reason: 'APP_URL_NOT_CONFIGURED', detail: String(e?.message || e) },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const descriptor = (process.env.MP_STATEMENT_DESCRIPTOR || 'IWE').substring(0, 22);\r\n    const isHttpsPublic = appUrl.startsWith('https://');\r\n    const preferencePayload = {\r\n      items: [\r\n        {\r\n          title: submission.form_definitions.name,\r\n          description: `Inscrição`,\r\n          quantity: 1,\r\n          unit_price: amount,\r\n          currency_id: 'BRL',\r\n        },\r\n      ],\r\n      payer: {\r\n        name: payerName,\r\n        email: payerEmail,\r\n        phone: {\r\n          number: payerPhone.replace(/\\D/g, ''),\r\n        },\r\n      },\r\n      back_urls: {\r\n        success: `${appUrl}/form/pagamento/sucesso?submission_id=${submission_id}`,\r\n        failure: `${appUrl}/form/pagamento/falha?submission_id=${submission_id}`,\r\n        pending: `${appUrl}/form/pagamento/pendente?submission_id=${submission_id}`,\r\n      },\r\n      // Evitar erro 400 em ambientes locais com http\r\n      ...(isHttpsPublic ? { auto_return: 'approved' as const } : {}),\r\n      external_reference: submission_id,\r\n      notification_url: `${appUrl}/api/webhooks/mercadopago`,\r\n      statement_descriptor: descriptor,\r\n      binary_mode: true,\r\n    };\r\n\r\n    // Usar SDK oficial com token do tenant quando disponível\r\n    const preferenceClient = await getPreferenceClientForTenant(submission.tenants?.id);\r\n    let mpData: any;\r\n    try {\r\n      const result = await preferenceClient.create({ body: preferencePayload as any });\r\n      mpData = result;\r\n    } catch (sdkError: any) {\r\n      console.error('Mercado Pago error (SDK):', sdkError);\r\n      const detail = sdkError?.message || sdkError?.error || String(sdkError);\r\n      const meta = {\r\n        status: sdkError?.status,\r\n        code: sdkError?.code,\r\n        blocked_by: sdkError?.blocked_by,\r\n      };\r\n      return NextResponse.json(\r\n        { error: 'Erro ao criar preferência de pagamento', reason: 'MP_PREFERENCE_ERROR', detail, meta },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Atualizar submission com referência de pagamento\r\n    await supabase\r\n      .from('submissions')\r\n      .update({\r\n        payment_reference: mpData.id,\r\n        payment_external_id: mpData.id,\r\n        metadata: {\r\n          ...submission.metadata,\r\n          mp_preference_id: mpData.id,\r\n          mp_init_point: mpData.init_point,\r\n        },\r\n      })\r\n      .eq('id', submission_id);\r\n\r\n    // Retornar URL de checkout\r\n    return NextResponse.json({\r\n      success: true,\r\n      preference_id: mpData.id,\r\n      init_point: mpData.init_point, // URL para web\r\n      sandbox_init_point: mpData.sandbox_init_point, // URL para sandbox\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Error creating payment preference:', error);\r\n    return NextResponse.json(\r\n      { error: 'Erro ao processar pagamento', reason: 'UNEXPECTED_ERROR', detail: String(error?.message || error) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\payments\\mercadopago\\create-preference\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2387,2390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2387,2390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":95,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":98,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2418,2421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2418,2421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2544,2547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2544,2547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest } from 'next/server';\r\nimport { getPreferenceClient, getAppUrl } from '@/lib/mercadopago';\r\n\r\ntype CreatePreferenceBody = {\r\n  title: string;\r\n  quantity: number;\r\n  unit_price: number; // BRL\r\n  email: string;\r\n  external_reference?: string;\r\n};\r\n\r\nfunction badRequest(message: string) {\r\n  return new Response(JSON.stringify({ error: message }), {\r\n    status: 400,\r\n    headers: { 'content-type': 'application/json' },\r\n  });\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = (await req.json()) as Partial<CreatePreferenceBody>;\r\n    if (!body) return badRequest('Body inválido');\r\n\r\n    const title = body.title?.trim();\r\n    const quantity = Number(body.quantity ?? 1);\r\n    const unit_price = Number(body.unit_price ?? 0);\r\n    const email = body.email?.trim();\r\n\r\n    if (!title) return badRequest('title é obrigatório');\r\n    if (!email || !email.includes('@')) return badRequest('email inválido');\r\n    if (!Number.isFinite(quantity) || quantity <= 0) return badRequest('quantity deve ser > 0');\r\n    if (!Number.isFinite(unit_price) || unit_price <= 0) return badRequest('unit_price deve ser > 0');\r\n\r\n    const preference = getPreferenceClient();\r\n    const appUrl = getAppUrl();\r\n\r\n    const back_urls = {\r\n      success: `${appUrl}/form/pagamento/sucesso`,\r\n      failure: `${appUrl}/form/pagamento/falha`,\r\n      pending: `${appUrl}/form/pagamento/pendente`,\r\n    };\r\n    // Alguns ambientes (localhost/http) podem causar erro 400 com auto_return.\r\n    // Só definimos auto_return quando a URL for pública (https).\r\n    const isHttpsPublic = appUrl.startsWith('https://');\r\n\r\n    const notification_url = `${appUrl}/api/webhooks/mercadopago`;\r\n\r\n    const created = await preference.create({\r\n      body: {\r\n        items: [\r\n          {\r\n            id: `ITEM-${Date.now()}`,\r\n            title,\r\n            quantity,\r\n            unit_price,\r\n            currency_id: 'BRL',\r\n          },\r\n        ],\r\n        payer: {\r\n          email,\r\n        },\r\n        external_reference: body.external_reference,\r\n        back_urls,\r\n        ...(isHttpsPublic ? { auto_return: 'approved' as const } : {}),\r\n        binary_mode: true,\r\n        notification_url,\r\n      },\r\n    });\r\n\r\n    // Resposta simplificada para o client redirecionar\r\n    return new Response(\r\n      JSON.stringify({ id: created.id, init_point: (created as any).init_point ?? (created as any).sandbox_init_point }),\r\n      { status: 200, headers: { 'content-type': 'application/json' } },\r\n    );\r\n  } catch (err: any) {\r\n    console.error('[MP:create-preference] erro:', err?.message || err);\r\n    const detail = err?.message || err?.error || String(err);\r\n    const meta = {\r\n      status: err?.status,\r\n      code: err?.code,\r\n      blocked_by: err?.blocked_by,\r\n    };\r\n    return new Response(\r\n      JSON.stringify({ error: 'Falha ao criar preferência', detail, meta }),\r\n      {\r\n        status: 500,\r\n        headers: { 'content-type': 'application/json' },\r\n      }\r\n    );\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\public\\forms\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[448,451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[448,451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1394,1397],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1394,1397],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1402,1405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1402,1405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1539,1542],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1539,1542],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1644,1647],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1644,1647],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\n\r\n// Preferimos Service Role para evitar bloqueios de RLS na leitura pública de formulários\r\nconst admin = createAdminClient();\r\n\r\n// GET /api/public/forms/[id] - Buscar formulário público (sem autenticação)\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    // Buscar formulário\r\n    const { data: form, error } = await admin\r\n      .from('form_definitions')\r\n      .select(`\r\n        id,\r\n        slug,\r\n        name,\r\n        description,\r\n        settings,\r\n        tenant_id,\r\n        tenants (\r\n          id,\r\n          name,\r\n          slug\r\n        ),\r\n        form_fields (\r\n          id,\r\n          label,\r\n          name,\r\n          type,\r\n          required,\r\n          placeholder,\r\n          options,\r\n          validation_rules,\r\n          order_index,\r\n          is_active\r\n        )\r\n      `)\r\n      .eq('id', params.id)\r\n      .eq('is_active', true) // Apenas formulários ativos\r\n      .single();\r\n\r\n    if (error || !form) {\r\n      return NextResponse.json(\r\n        { error: 'Formulário não encontrado ou inativo' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Ordenar campos por order_index\r\n    if (form.form_fields) {\r\n      form.form_fields.sort((a: any, b: any) => a.order_index - b.order_index);\r\n      // Filtrar apenas campos ativos\r\n      form.form_fields = form.form_fields.filter((field: any) => field.is_active !== false);\r\n    }\r\n\r\n    return NextResponse.json({ form });\r\n  } catch (error: any) {\r\n    console.error('Error fetching public form:', error);\r\n    return NextResponse.json({ error: 'Erro ao buscar formulário' }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\public\\forms\\by-slug\\[slug]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[412,415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[412,415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1370,1373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1370,1373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1378,1381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1378,1381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1476,1479],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1476,1479],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1581,1584],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1581,1584],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\n\r\n// Preferimos Service Role para evitar bloqueios de RLS na leitura pública de formulários\r\nconst admin = createAdminClient();\r\n\r\n// GET /api/public/forms/by-slug/[slug] - Buscar formulário público por slug (sem autenticação)\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const slug = params.slug;\r\n\r\n    // Buscar formulário por slug\r\n    const { data: form, error } = await admin\r\n      .from('form_definitions')\r\n      .select(`\r\n        id,\r\n        name,\r\n        description,\r\n        settings,\r\n        tenant_id,\r\n        tenants (\r\n          id,\r\n          name,\r\n          slug\r\n        ),\r\n        form_fields (\r\n          id,\r\n          label,\r\n          name,\r\n          type,\r\n          required,\r\n          placeholder,\r\n          options,\r\n          validation_rules,\r\n          order_index,\r\n          is_active\r\n        )\r\n      `)\r\n      .eq('slug', slug)\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    if (error || !form) {\r\n      return NextResponse.json(\r\n        { error: 'Formulário não encontrado ou inativo' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Ordenar campos por order_index e filtrar ativos\r\n    if (form.form_fields) {\r\n      form.form_fields.sort((a: any, b: any) => a.order_index - b.order_index);\r\n      form.form_fields = form.form_fields.filter((field: any) => field.is_active !== false);\r\n    }\r\n\r\n    return NextResponse.json({ form });\r\n  } catch (error: any) {\r\n    console.error('Error fetching public form by slug:', error);\r\n    return NextResponse.json({ error: 'Erro ao buscar formulário' }, { status: 500 });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\public\\submissions\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabase' is assigned a value but never used.","line":6,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2667,2670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2667,2670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3519,3522],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3519,3522],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":117,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3630,3633],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3630,3633],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":119,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3721,3724],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3721,3724],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3996,3999],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3996,3999],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":220,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7400,7403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7400,7403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":222,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7498,7501],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7498,7501],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":318,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":318,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11228,11231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11228,11231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\n\r\n// Cliente público do Supabase\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n);\r\n\r\n// POST /api/public/submissions - Criar nova submissão (público)\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { form_id, data: formData, tenant_id } = body;\r\n\r\n    if (!form_id || !formData) {\r\n      return NextResponse.json(\r\n        { error: 'form_id e data são obrigatórios' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Nota: tenant_id pode ser opcional quando o formulário possui tenant vinculado\r\n\r\n    // Buscar formulário para validar (usar Service Role para evitar bloqueios de RLS)\r\n    const admin = createAdminClient();\r\n    const { data: form, error: formError } = await admin\r\n      .from('form_definitions')\r\n      .select(`\r\n        id,\r\n        tenant_id,\r\n        is_active,\r\n        settings,\r\n        form_fields (\r\n          id,\r\n          name,\r\n          type,\r\n          required,\r\n          validation_rules\r\n        )\r\n      `)\r\n      .eq('id', form_id)\r\n      .single();\r\n\r\n    if (formError || !form || !form.is_active) {\r\n      return NextResponse.json(\r\n        { error: 'Formulário não encontrado ou inativo' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Validar e resolver tenant da submissão\r\n    // Reutilizar admin client já criado para validar tenant\r\n    let tenantToUse: { id: string; name: string; status: boolean } | null = null;\r\n\r\n    if (form.tenant_id) {\r\n      // Formulário vinculado a um polo específico: deve usar o mesmo polo\r\n      // Se body.tenant_id vier e for diferente, rejeitar\r\n      if (tenant_id && tenant_id !== form.tenant_id) {\r\n        return NextResponse.json(\r\n          { error: 'Polo selecionado não corresponde ao polo do formulário' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      const { data: fixedTenant, error: fixedTenantError } = await admin\r\n        .from('tenants')\r\n        .select('id, name, status')\r\n        .eq('id', form.tenant_id)\r\n        .single();\r\n\r\n      if (fixedTenantError || !fixedTenant) {\r\n        return NextResponse.json(\r\n          { error: 'Polo do formulário inválido' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      if (fixedTenant.status !== true) {\r\n        return NextResponse.json(\r\n          { error: 'Polo do formulário está inativo' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      tenantToUse = fixedTenant as any;\r\n    } else {\r\n      // Formulário global: tenant_id é obrigatório\r\n      if (!tenant_id) {\r\n        return NextResponse.json(\r\n          { error: 'tenant_id é obrigatório para este formulário. Selecione um polo.' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      const { data: selectedTenant, error: tenantError } = await admin\r\n        .from('tenants')\r\n        .select('id, name, status')\r\n        .eq('id', tenant_id)\r\n        .single();\r\n\r\n      if (tenantError || !selectedTenant) {\r\n        return NextResponse.json(\r\n          { error: 'Polo inválido' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      if (selectedTenant.status !== true) {\r\n        return NextResponse.json(\r\n          { error: 'Polo inativo. Escolha outro polo.' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      tenantToUse = selectedTenant as any;\r\n    }\r\n\r\n    // Validar campos obrigatórios\r\n    const requiredFields = form.form_fields?.filter((field: any) => field.required);\r\n    const missingFields = requiredFields?.filter(\r\n      (field: any) => !formData[field.name] || formData[field.name] === ''\r\n    );\r\n\r\n    if (missingFields && missingFields.length > 0) {\r\n      return NextResponse.json(\r\n        {\r\n          error: 'Campos obrigatórios não preenchidos',\r\n          missing_fields: missingFields.map((f: any) => f.name),\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validar tipos de dados\r\n    for (const field of form.form_fields || []) {\r\n      const value = formData[field.name];\r\n      \r\n      if (!value) continue; // Pula se não foi preenchido (já validamos required acima)\r\n\r\n      // Validação de email\r\n      if (field.type === 'email' && value) {\r\n        const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n        if (!emailRegex.test(value)) {\r\n          return NextResponse.json(\r\n            { error: `Campo ${field.name} deve ser um email válido` },\r\n            { status: 400 }\r\n          );\r\n        }\r\n      }\r\n\r\n      // Validação de CPF (formato básico)\r\n      if (field.type === 'cpf' && value) {\r\n        const cpfRegex = /^\\d{3}\\.\\d{3}\\.\\d{3}-\\d{2}$/;\r\n        if (!cpfRegex.test(value)) {\r\n          return NextResponse.json(\r\n            { error: `Campo ${field.name} deve ser um CPF válido (000.000.000-00)` },\r\n            { status: 400 }\r\n          );\r\n        }\r\n      }\r\n\r\n      // Validação de CEP\r\n      if (field.type === 'cep' && value) {\r\n        const cepRegex = /^\\d{5}-\\d{3}$/;\r\n        if (!cepRegex.test(value)) {\r\n          return NextResponse.json(\r\n            { error: `Campo ${field.name} deve ser um CEP válido (00000-000)` },\r\n            { status: 400 }\r\n          );\r\n        }\r\n      }\r\n\r\n      // Validação de número\r\n      if (field.type === 'number' && value) {\r\n        if (isNaN(Number(value))) {\r\n          return NextResponse.json(\r\n            { error: `Campo ${field.name} deve ser um número` },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        // Validar min/max se definidos\r\n        if (field.validation_rules?.min !== undefined) {\r\n          if (Number(value) < field.validation_rules.min) {\r\n            return NextResponse.json(\r\n              { error: `Campo ${field.name} deve ser no mínimo ${field.validation_rules.min}` },\r\n              { status: 400 }\r\n            );\r\n          }\r\n        }\r\n        if (field.validation_rules?.max !== undefined) {\r\n          if (Number(value) > field.validation_rules.max) {\r\n            return NextResponse.json(\r\n              { error: `Campo ${field.name} deve ser no máximo ${field.validation_rules.max}` },\r\n              { status: 400 }\r\n            );\r\n          }\r\n        }\r\n      }\r\n\r\n      // Validação de comprimento de texto\r\n      if ((field.type === 'text' || field.type === 'textarea') && value) {\r\n        if (field.validation_rules?.minLength && value.length < field.validation_rules.minLength) {\r\n          return NextResponse.json(\r\n            { error: `Campo ${field.name} deve ter no mínimo ${field.validation_rules.minLength} caracteres` },\r\n            { status: 400 }\r\n          );\r\n        }\r\n        if (field.validation_rules?.maxLength && value.length > field.validation_rules.maxLength) {\r\n          return NextResponse.json(\r\n            { error: `Campo ${field.name} deve ter no máximo ${field.validation_rules.maxLength} caracteres` },\r\n            { status: 400 }\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    // Verificação de duplicidade: Nome + CPF\r\n    // - Identifica dinamicamente os campos de nome e cpf do formulário\r\n    // - Bloqueia nova submissão quando já existir registro com mesmo CPF\r\n    //   (e opcionalmente mesmo nome) em qualquer formulário do sistema.\r\n    const cpfField = (form.form_fields || []).find((f: any) => f.type === 'cpf')?.name;\r\n    const nameField = (form.form_fields || [])\r\n      .find((f: any) => {\r\n        const n = (f.name || '').toLowerCase();\r\n        return ['nome_completo', 'nome', 'name'].includes(n);\r\n      })?.name;\r\n\r\n    const cpfValueRaw = cpfField ? formData[cpfField] : null;\r\n    const nameValueRaw = nameField ? formData[nameField] : null;\r\n\r\n    if (cpfValueRaw) {\r\n      // Busca por CPF exatamente igual (formato mascarado). Como o frontend aplica máscara,\r\n      // isso evita falsos negativos por diferenças de formatação.\r\n      // Se também houver nome, exige ambos para reduzir falso-positivo em casos raros.\r\n      let dupQuery = admin\r\n        .from('submissions')\r\n        .select('id')\r\n        .eq(`data->>${cpfField}`, cpfValueRaw)\r\n        .limit(1);\r\n\r\n      if (nameValueRaw) {\r\n        dupQuery = dupQuery.eq(`data->>${nameField}`, nameValueRaw);\r\n      }\r\n\r\n      const { data: dup, error: dupError } = await dupQuery;\r\n      if (dupError) {\r\n        console.error('Erro ao verificar duplicidade:', dupError);\r\n        // Prossegue sem bloquear se houver erro de verificação\r\n      } else if (dup && dup.length > 0) {\r\n        return NextResponse.json(\r\n          { error: 'Aluno já cadastrado no sistema!' },\r\n          { status: 409 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Capturar informações da requisição\r\n    // Extrair primeiro IP válido\r\n    const forwardedFor = request.headers.get('x-forwarded-for') || '';\r\n    const firstForwardedIp = forwardedFor.split(',')[0]?.trim();\r\n    const realIp = request.headers.get('x-real-ip') || '';\r\n    const ipCandidate = firstForwardedIp || realIp || '';\r\n    const ipv4Regex = /^(?:\\d{1,3}\\.){3}\\d{1,3}$/;\r\n    const ipv6Regex = /^[0-9a-fA-F:]+$/;\r\n    const ip = ipCandidate && (ipv4Regex.test(ipCandidate) || ipv6Regex.test(ipCandidate)) ? ipCandidate : null;\r\n    const userAgent = request.headers.get('user-agent') || null;\r\n\r\n    // Criar submissão\r\n    const { data: submission, error: submissionError } = await admin\r\n      .from('submissions')\r\n      .insert({\r\n        tenant_id: tenantToUse!.id,\r\n        polo: tenantToUse!.name,\r\n        form_definition_id: form_id,\r\n        data: formData,\r\n        // Definir status de pagamento apenas quando aplicável (evita enum inválido)\r\n        ...(form.settings?.require_payment ? { payment_status: 'PENDENTE' } : {}),\r\n        // Persistir o valor previsto do pagamento na submissão para métricas e consistência\r\n        ...(form.settings?.require_payment\r\n          ? { payment_amount: Number(form.settings?.payment_amount ?? 0) }\r\n          : {}),\r\n        ip_address: ip,\r\n        user_agent: userAgent,\r\n        metadata: {\r\n          submitted_at: new Date().toISOString(),\r\n          form_title: form.settings?.form_title || 'Formulário',\r\n        },\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (submissionError) {\r\n      console.error('Error creating submission:', submissionError);\r\n      return NextResponse.json(\r\n        { error: 'Erro ao criar submissão', detail: submissionError.message },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Se requer pagamento, retornar info para redirecionar ao checkout\r\n    if (form.settings?.require_payment) {\r\n      return NextResponse.json({\r\n        success: true,\r\n        submission_id: submission.id,\r\n        requires_payment: true,\r\n        payment_amount: form.settings.payment_amount || 0,\r\n        message: 'Submissão criada. Redirecionando para pagamento...',\r\n      });\r\n    }\r\n\r\n    // Resposta de sucesso\r\n    return NextResponse.json({\r\n      success: true,\r\n      submission_id: submission.id,\r\n      requires_payment: false,\r\n      message: form.settings?.success_message || 'Formulário enviado com sucesso!',\r\n      redirect_url: form.settings?.redirect_url || null,\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Error in public submission:', error);\r\n    return NextResponse.json(\r\n      { error: 'Erro ao processar submissão' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\public\\tenants\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_request' is defined but never used.","line":9,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":35},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[798,801],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[798,801],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[925,928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[925,928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { createAdminClient } from '@/lib/supabase/admin';\n\n// Lista pública de polos/tenants para páginas de formulário sem autenticação.\n// Segurança: expõe apenas id, name e slug de tenants ativos (status=true).\nconst admin = createAdminClient();\n\n// GET /api/public/tenants\nexport async function GET(_request: NextRequest) {\n  try {\n    const { data: tenants, error } = await admin\n      .from('tenants')\n      .select('id, name, slug, status')\n      .eq('status', true)\n      .order('name', { ascending: true });\n\n    if (error) {\n      return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n\n    // Não expor o campo status no payload final (apenas usado para filtro)\n    const safeTenants = (tenants || []).map((t: any) => ({ id: t.id, name: t.name, slug: t.slug }));\n    return NextResponse.json({ tenants: safeTenants });\n  } catch (error: any) {\n    console.error('Error fetching public tenants:', error);\n    return NextResponse.json({ error: 'Erro ao listar polos' }, { status: 500 });\n  }\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\mercadopago\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":47,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1550,1553],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1550,1553],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n  const body = await request.json();\r\n  const { access_token, public_key, webhook_secret, is_sandbox, is_production, is_active } = body;\r\n\r\n  // Verificar se a config existe e se o admin tem permissão\r\n  const { data: existingConfig, error: fetchError } = await supabase\r\n    .from('mercadopago_configs')\r\n    .select('tenant_id')\r\n    .eq('id', id)\r\n    .single();\r\n\r\n  if (fetchError || !existingConfig) {\r\n    return NextResponse.json({ error: 'Configuration not found' }, { status: 404 });\r\n  }\r\n\r\n  // Verificar permissão: superadmin tem acesso global, admin precisa ser do tenant\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRow?.role !== 'superadmin') {\r\n    const { data: isAdmin } = await supabase\r\n      .rpc('is_admin_of_tenant', { tenant_uuid: existingConfig.tenant_id });\r\n    if (!isAdmin) {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n  }\r\n\r\n  // Atualizar configuração\r\n  const updateData: any = {};\r\n  if (access_token !== undefined) updateData.access_token = access_token;\r\n  if (public_key !== undefined) updateData.public_key = public_key || null;\r\n  if (webhook_secret !== undefined) updateData.webhook_secret = webhook_secret || null;\r\n  if (is_production !== undefined) {\r\n    updateData.is_production = is_production;\r\n  } else if (is_sandbox !== undefined) {\r\n    updateData.is_production = !is_sandbox;\r\n  }\r\n  if (is_active !== undefined) updateData.is_active = is_active;\r\n\r\n  const { data: config, error } = await supabase\r\n    .from('mercadopago_configs')\r\n    .update(updateData)\r\n    .eq('id', id)\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error('Error updating Mercado Pago config:', error);\r\n    return NextResponse.json({ error: 'Failed to update configuration' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRow?.id ?? null,\r\n    tenant_id: existingConfig.tenant_id,\r\n    action: 'UPDATE',\r\n    resource_type: 'mercadopago_config',\r\n    resource_id: id,\r\n    changes: { updated_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n\r\n  // Verificar se a config existe e se o admin tem permissão\r\n  const { data: existingConfig, error: fetchError } = await supabase\r\n    .from('mercadopago_configs')\r\n    .select('tenant_id')\r\n    .eq('id', id)\r\n    .single();\r\n\r\n  if (fetchError || !existingConfig) {\r\n    return NextResponse.json({ error: 'Configuration not found' }, { status: 404 });\r\n  }\r\n\r\n  // Verificar permissão: superadmin tem acesso global, admin precisa ser do tenant\r\n  const { data: roleRowDel } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRowDel?.role !== 'superadmin') {\r\n    const { data: isAdminDel } = await supabase\r\n      .rpc('is_admin_of_tenant', { tenant_uuid: existingConfig.tenant_id });\r\n    if (!isAdminDel) {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n  }\r\n\r\n  // Deletar configuração\r\n  const { error } = await supabase\r\n    .from('mercadopago_configs')\r\n    .delete()\r\n    .eq('id', id);\r\n\r\n  if (error) {\r\n    console.error('Error deleting Mercado Pago config:', error);\r\n    return NextResponse.json({ error: 'Failed to delete configuration' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRowDel?.id ?? null,\r\n    tenant_id: existingConfig.tenant_id,\r\n    action: 'DELETE',\r\n    resource_type: 'mercadopago_config',\r\n    resource_id: id,\r\n    changes: { deleted_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ success: true });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\mercadopago\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'is_sandbox' is assigned a value but never used.","line":60,"column":64,"nodeType":null,"messageId":"unusedVar","endLine":60,"endColumn":74}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { searchParams } = new URL(request.url);\r\n  const tenant_id = searchParams.get('tenant_id');\r\n\r\n  if (!tenant_id) {\r\n    return NextResponse.json({ error: 'tenant_id is required' }, { status: 400 });\r\n  }\r\n\r\n  // Verificar permissão: superadmin tem acesso global, admin precisa ser do tenant\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRow?.role !== 'superadmin') {\r\n    const { data: isAdmin } = await supabase\r\n      .rpc('is_admin_of_tenant', { tenant_uuid: tenant_id });\r\n    if (!isAdmin) {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n  }\r\n\r\n  // Buscar configuração\r\n  const { data: config, error } = await supabase\r\n    .from('mercadopago_configs')\r\n    .select('*')\r\n    .eq('tenant_id', tenant_id)\r\n    .single();\r\n\r\n  if (error) {\r\n    // Se não existe, retornar sem erro\r\n    return NextResponse.json({ config: null });\r\n  }\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const body = await request.json();\r\n  const { tenant_id, access_token, public_key, webhook_secret, is_sandbox, is_production, is_active } = body;\r\n\r\n  if (!tenant_id || !access_token) {\r\n    return NextResponse.json({ error: 'tenant_id and access_token are required' }, { status: 400 });\r\n  }\r\n\r\n  // Verificar permissão: superadmin tem acesso global, admin precisa ser do tenant\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRow?.role !== 'superadmin') {\r\n    const { data: isAdmin } = await supabase\r\n      .rpc('is_admin_of_tenant', { tenant_uuid: tenant_id });\r\n    if (!isAdmin) {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n  }\r\n\r\n  // Criar configuração\r\n  const { data: config, error } = await supabase\r\n    .from('mercadopago_configs')\r\n    .insert({\r\n      tenant_id,\r\n      access_token,\r\n      public_key: public_key || null,\r\n      webhook_secret: webhook_secret || null,\r\n      // Mapear corretamente para o schema (is_production). Padrão seguro: false.\r\n      is_production: typeof is_production === 'boolean' ? is_production : false,\r\n      is_active: is_active !== false,\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error('Error creating Mercado Pago config:', error);\r\n    return NextResponse.json({ error: 'Failed to create configuration' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRow?.id ?? null,\r\n    tenant_id,\r\n    action: 'CREATE',\r\n    resource_type: 'mercadopago_config',\r\n    resource_id: config.id,\r\n    changes: { created_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\n8n\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1373,1376],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1373,1376],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n  const body = await request.json();\r\n  const { webhook_url, auth_token, timeout_seconds, timeout_ms, max_retries, retries, is_active } = body;\r\n\r\n  // Verificar se a config GLOBAL existe\r\n  const { data: existingConfig, error: fetchError } = await supabase\r\n    .from('outbound_webhook_global_configs')\r\n    .select('id')\r\n    .eq('id', id)\r\n    .single();\r\n\r\n  if (fetchError || !existingConfig) {\r\n    return NextResponse.json({ error: 'Configuration not found' }, { status: 404 });\r\n  }\r\n\r\n  // Permissão: apenas superadmin pode atualizar configuração global\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRow?.role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Atualizar configuração\r\n  const updateData: any = {};\r\n  if (webhook_url !== undefined) updateData.enrollment_webhook_url = webhook_url;\r\n  if (auth_token !== undefined) updateData.enrollment_webhook_token = auth_token || null;\r\n  if (timeout_ms !== undefined) updateData.timeout_ms = timeout_ms;\r\n  if (timeout_seconds !== undefined) updateData.timeout_ms = timeout_seconds * 1000;\r\n  if (retries !== undefined) updateData.retries = retries;\r\n  if (max_retries !== undefined) updateData.retries = max_retries;\r\n  if (is_active !== undefined) updateData.is_active = is_active;\r\n\r\n  const { data: config, error } = await supabase\r\n    .from('outbound_webhook_global_configs')\r\n    .update(updateData)\r\n    .eq('id', id)\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error('Error updating n8n config:', error);\r\n    return NextResponse.json({ error: 'Failed to update configuration' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRow?.id ?? null,\r\n    tenant_id: null,\r\n    action: 'UPDATE',\r\n    resource_type: 'outbound_webhook_global_config',\r\n    resource_id: id,\r\n    changes: { updated_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n\r\n  // Verificar se a config GLOBAL existe\r\n  const { data: existingConfig, error: fetchError } = await supabase\r\n    .from('outbound_webhook_global_configs')\r\n    .select('id')\r\n    .eq('id', id)\r\n    .single();\r\n\r\n  if (fetchError || !existingConfig) {\r\n    return NextResponse.json({ error: 'Configuration not found' }, { status: 404 });\r\n  }\r\n\r\n  // Permissão: apenas superadmin pode excluir configuração global\r\n  const { data: roleRowDel } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRowDel?.role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Deletar configuração\r\n  const { error } = await supabase\r\n    .from('outbound_webhook_global_configs')\r\n    .delete()\r\n    .eq('id', id);\r\n\r\n  if (error) {\r\n    console.error('Error deleting n8n config:', error);\r\n    return NextResponse.json({ error: 'Failed to delete configuration' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRowDel?.id ?? null,\r\n    tenant_id: null,\r\n    action: 'DELETE',\r\n    resource_type: 'outbound_webhook_global_config',\r\n    resource_id: id,\r\n    changes: { deleted_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ success: true });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\n8n\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":4,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2858,2861],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2858,2861],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  // Permissão: admin e superadmin podem visualizar configuração global\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRow?.role !== 'admin' && roleRow?.role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Buscar configuração GLOBAL\r\n  const { data: config, error } = await supabase\r\n    .from('outbound_webhook_global_configs')\r\n    .select('*')\r\n    .eq('is_active', true)\r\n    .order('updated_at', { ascending: false })\r\n    .limit(1)\r\n    .maybeSingle();\r\n\r\n  if (error) {\r\n    return NextResponse.json({ config: null });\r\n  }\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const body = await request.json();\r\n  const {\r\n    webhook_url,\r\n    auth_token,\r\n    timeout_seconds,\r\n    timeout_ms,\r\n    max_retries,\r\n    retries,\r\n    is_active,\r\n  } = body;\r\n\r\n  if (!webhook_url) {\r\n    return NextResponse.json({ error: 'webhook_url is required' }, { status: 400 });\r\n  }\r\n\r\n  // Permissão: apenas superadmin pode escrever configuração global\r\n  const { data: roleRowPost } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRowPost?.role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Upsert configuração GLOBAL na tabela outbound_webhook_global_configs\r\n  const timeoutCalculated =\r\n    typeof timeout_ms === 'number'\r\n      ? timeout_ms\r\n      : typeof timeout_seconds === 'number'\r\n        ? timeout_seconds * 1000\r\n        : 30000; // default 30s\r\n\r\n  const { data: existing } = await supabase\r\n    .from('outbound_webhook_global_configs')\r\n    .select('id')\r\n    .order('updated_at', { ascending: false })\r\n    .limit(1)\r\n    .maybeSingle();\r\n\r\n  const payload = {\r\n    enrollment_webhook_url: webhook_url,\r\n    enrollment_webhook_token: auth_token || null,\r\n    timeout_ms: timeoutCalculated,\r\n    retries: typeof retries === 'number' ? retries : (typeof max_retries === 'number' ? max_retries : 3),\r\n    is_active: is_active !== false,\r\n  };\r\n\r\n  let config: any = null;\r\n  if (existing?.id) {\r\n    const { data: updated, error } = await supabase\r\n      .from('outbound_webhook_global_configs')\r\n      .update(payload)\r\n      .eq('id', existing.id)\r\n      .select()\r\n      .single();\r\n    if (error) {\r\n      console.error('Error updating n8n global config:', error);\r\n      return NextResponse.json({ error: 'Failed to update configuration' }, { status: 500 });\r\n    }\r\n    config = updated;\r\n  } else {\r\n    const { data: created, error } = await supabase\r\n      .from('outbound_webhook_global_configs')\r\n      .insert(payload)\r\n      .select()\r\n      .single();\r\n    if (error) {\r\n      console.error('Error creating n8n global config:', error);\r\n      return NextResponse.json({ error: 'Failed to create configuration' }, { status: 500 });\r\n    }\r\n    config = created;\r\n  }\r\n\r\n  // sucesso\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRowPost?.id ?? null,\r\n    tenant_id: null,\r\n    action: 'CREATE',\r\n    resource_type: 'outbound_webhook_global_config',\r\n    resource_id: config.id,\r\n    changes: { created_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\whatsapp\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[948,951],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[948,951],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[996,999],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[996,999],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1044,1047],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1044,1047],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1890,1893],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1890,1893],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2646,2649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2646,2649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2689,2692],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2689,2692],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2732,2735],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2732,2735],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":120,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4212,4215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4212,4215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4260,4263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4260,4263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":122,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4308,4311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4308,4311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":154,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5360,5363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5360,5363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5403,5406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5403,5406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5446,5449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5446,5449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n  const body = await request.json();\r\n  const { instance_name, instance_id, api_url, api_base_url, api_key, token, default_sender, is_active } = body;\r\n\r\n  // Verificar se a config GLOBAL existe e se tem permissão\r\n  const { data: existingConfig, error: fetchError } = await supabase\r\n    .from('whatsapp_global_configs')\r\n    .select('id')\r\n    .eq('id', id)\r\n    .single();\r\n  if (fetchError || !existingConfig) {\r\n    const code = (fetchError as any)?.code;\r\n    const message = (fetchError as any)?.message;\r\n    const hint = (fetchError as any)?.hint;\r\n    if (code === 'PGRST205' || /Could not find the table/i.test(String(message))) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            'Tabela whatsapp_global_configs não encontrada. Execute as migrações do Supabase antes de salvar (20251107123000_global_settings.sql).',\r\n          hint,\r\n        },\r\n        { status: 503 }\r\n      );\r\n    }\r\n    return NextResponse.json({ error: 'Configuration not found' }, { status: 404 });\r\n  }\r\n\r\n  // Permissão: apenas superadmin pode alterar config global\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRow?.role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Atualizar configuração\r\n  const updateData: any = {};\r\n  if (instance_id !== undefined || instance_name !== undefined) updateData.instance_id = instance_id ?? instance_name;\r\n  if (api_base_url !== undefined || api_url !== undefined) updateData.api_base_url = api_base_url ?? api_url;\r\n  if (token !== undefined || api_key !== undefined) updateData.token = token ?? api_key;\r\n  if (default_sender !== undefined) updateData.default_sender = default_sender;\r\n  if (is_active !== undefined) updateData.is_active = is_active;\r\n\r\n  const { data: config, error } = await supabase\r\n    .from('whatsapp_global_configs')\r\n    .update(updateData)\r\n    .eq('id', id)\r\n    .select()\r\n    .single();\r\n  if (error) {\r\n    console.error('Error updating WhatsApp global config:', error);\r\n    const code = (error as any)?.code;\r\n    const message = (error as any)?.message;\r\n    const hint = (error as any)?.hint;\r\n    if (code === 'PGRST205' || /Could not find the table/i.test(String(message))) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            'Tabela whatsapp_global_configs não encontrada. Execute as migrações do Supabase antes de salvar (20251107123000_global_settings.sql).',\r\n          hint,\r\n        },\r\n        { status: 503 }\r\n      );\r\n    }\r\n    return NextResponse.json({ error: 'Failed to update configuration' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRow?.id ?? null,\r\n    tenant_id: null,\r\n    action: 'UPDATE',\r\n    resource_type: 'whatsapp_global_config',\r\n    resource_id: id,\r\n    changes: { updated_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n\r\n  // Verificar se a config GLOBAL existe e se tem permissão\r\n  const { data: existingConfig, error: fetchError } = await supabase\r\n    .from('whatsapp_global_configs')\r\n    .select('id')\r\n    .eq('id', id)\r\n    .single();\r\n  if (fetchError || !existingConfig) {\r\n    const code = (fetchError as any)?.code;\r\n    const message = (fetchError as any)?.message;\r\n    const hint = (fetchError as any)?.hint;\r\n    if (code === 'PGRST205' || /Could not find the table/i.test(String(message))) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            'Tabela whatsapp_global_configs não encontrada. Execute as migrações do Supabase antes de deletar (20251107123000_global_settings.sql).',\r\n          hint,\r\n        },\r\n        { status: 503 }\r\n      );\r\n    }\r\n    return NextResponse.json({ error: 'Configuration not found' }, { status: 404 });\r\n  }\r\n\r\n  // Permissão: apenas superadmin pode deletar config global\r\n  const { data: roleRowDel } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRowDel?.role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Deletar configuração\r\n  const { error } = await supabase\r\n    .from('whatsapp_global_configs')\r\n    .delete()\r\n    .eq('id', id);\r\n  if (error) {\r\n    console.error('Error deleting WhatsApp global config:', error);\r\n    const code = (error as any)?.code;\r\n    const message = (error as any)?.message;\r\n    const hint = (error as any)?.hint;\r\n    if (code === 'PGRST205' || /Could not find the table/i.test(String(message))) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            'Tabela whatsapp_global_configs não encontrada. Execute as migrações do Supabase antes de deletar (20251107123000_global_settings.sql).',\r\n          hint,\r\n        },\r\n        { status: 503 }\r\n      );\r\n    }\r\n    return NextResponse.json({ error: 'Failed to delete configuration' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRowDel?.id ?? null,\r\n    tenant_id: null,\r\n    action: 'DELETE',\r\n    resource_type: 'whatsapp_global_config',\r\n    resource_id: id,\r\n    changes: { deleted_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ success: true });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\whatsapp\\qrcode\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":105,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4354,4357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4354,4357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4699,4702],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4699,4702],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\n// Endpoint: POST /api/settings/whatsapp/qrcode\r\n// Objetivo: obter QR Code da instância na Evolution API v2\r\n// Estratégia: tentar /instance/qrcode/{instance}; se falhar, tentar /instance/connect/{instance}\r\n// Retorno: { success, message, state, qrcode_base64 }\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  // Permissão: admin e superadmin podem visualizar QR Code\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  const role = roleRow?.role;\r\n  if (role !== 'admin' && role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  try {\r\n    const body = await request.json();\r\n    const { api_url, api_key, instance_name } = body;\r\n\r\n    if (!api_url || !api_key || !instance_name) {\r\n      return NextResponse.json(\r\n        { error: 'API URL, API Key e instance_name são obrigatórios' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const baseUrl = String(api_url).replace(/\\/+$/, '');\r\n\r\n    const controller = new AbortController();\r\n    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s\r\n\r\n    const headers: Record<string, string> = {\r\n      'apikey': api_key,\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    const toBase64 = async (resp: Response) => {\r\n      const buf = await resp.arrayBuffer();\r\n      // Converter ArrayBuffer -> base64\r\n      const bytes = Buffer.from(buf);\r\n      return bytes.toString('base64');\r\n    };\r\n\r\n    try {\r\n      // 1) Tentar endpoint direto de QR Code\r\n      const qrUrl = `${baseUrl}/instance/qrcode/${encodeURIComponent(instance_name)}`;\r\n      const qrRes = await fetch(qrUrl, { method: 'GET', headers, signal: controller.signal });\r\n\r\n      if (qrRes.ok) {\r\n        const contentType = qrRes.headers.get('content-type') || '';\r\n        if (contentType.includes('image')) {\r\n          const base64 = await toBase64(qrRes);\r\n          clearTimeout(timeoutId);\r\n          return NextResponse.json({ success: true, message: 'QR Code obtido com sucesso.', state: 'qrcode', qrcode_base64: base64 });\r\n        }\r\n        // Pode retornar JSON com qrcode.base64\r\n        const json = await qrRes.json().catch(() => null);\r\n        const base64 = json?.qrcode?.base64 || json?.base64 || null;\r\n        if (base64) {\r\n          clearTimeout(timeoutId);\r\n          return NextResponse.json({ success: true, message: 'QR Code obtido com sucesso.', state: 'qrcode', qrcode_base64: base64 });\r\n        }\r\n        // Se não houver imagem nem base64, prosseguir para connect\r\n      }\r\n\r\n      // 2) Fallback: tentar conectar (pode retornar qrcode)\r\n      const connectUrl = `${baseUrl}/instance/connect/${encodeURIComponent(instance_name)}`;\r\n      const connRes = await fetch(connectUrl, { method: 'GET', headers, signal: controller.signal });\r\n\r\n      if (!connRes.ok) {\r\n        const errorText = await connRes.text().catch(() => 'Erro desconhecido');\r\n        clearTimeout(timeoutId);\r\n        return NextResponse.json({ success: false, error: `Erro ao conectar: ${connRes.status} - ${errorText}` }, { status: 400 });\r\n      }\r\n\r\n      const connJson = await connRes.json().catch(() => null);\r\n      const state = connJson?.instance?.state ?? connJson?.state ?? null;\r\n      const base64 = connJson?.qrcode?.base64 ?? connJson?.base64 ?? null;\r\n\r\n      clearTimeout(timeoutId);\r\n\r\n      if (base64) {\r\n        return NextResponse.json({ success: true, message: 'QR Code obtido com sucesso.', state: state || 'qrcode', qrcode_base64: base64 });\r\n      }\r\n\r\n      if (state && (String(state).toLowerCase() === 'open' || String(state).toLowerCase() === 'connected')) {\r\n        return NextResponse.json({ success: true, message: 'Instância já está conectada.', state });\r\n      }\r\n\r\n      return NextResponse.json({ success: false, error: 'Não foi possível obter o QR Code. Verifique se a instância está aguardando pareamento (state=qrcode).' }, { status: 404 });\r\n\r\n    } catch (err: any) {\r\n      clearTimeout(timeoutId);\r\n      if (err?.name === 'AbortError') {\r\n        return NextResponse.json({ success: false, error: 'Timeout ao obter QR Code.' }, { status: 408 });\r\n      }\r\n      return NextResponse.json({ success: false, error: `Erro: ${err?.message || 'desconhecido'}` }, { status: 500 });\r\n    }\r\n\r\n  } catch (error: any) {\r\n    return NextResponse.json({ success: false, error: `Erro interno: ${error.message}` }, { status: 500 });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\whatsapp\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":4,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1162,1165],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1162,1165],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1205,1208],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1205,1208],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1248,1251],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1248,1251],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3637,3640],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3637,3640],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":133,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3973,3976],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3973,3976],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4018,4021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4018,4021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":135,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4063,4066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4063,4066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":157,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4871,4874],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4871,4874],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4916,4919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4916,4919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":159,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":159,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4961,4964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4961,4964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  // Permissão: admin e superadmin podem visualizar configuração global\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  const role = roleRow?.role;\r\n  if (role !== 'admin' && role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Buscar configuração GLOBAL\r\n  const { data: config, error } = await supabase\r\n    .from('whatsapp_global_configs')\r\n    .select('*')\r\n    .eq('is_active', true)\r\n    .order('updated_at', { ascending: false })\r\n    .limit(1)\r\n    .maybeSingle();\r\n\r\n  if (error) {\r\n    // Tornar o erro mais explícito quando a tabela não existe (migração não aplicada)\r\n    const code = (error as any)?.code;\r\n    const message = (error as any)?.message;\r\n    const hint = (error as any)?.hint;\r\n    if (code === 'PGRST205' || /Could not find the table/i.test(String(message))) {\r\n      return NextResponse.json(\r\n        {\r\n          config: null,\r\n          error:\r\n            'Tabela whatsapp_global_configs ausente no banco. Aplique as migrações do Supabase (20251107123000_global_settings.sql).',\r\n          hint,\r\n        },\r\n        { status: 503 }\r\n      );\r\n    }\r\n    return NextResponse.json({ config: null, error: 'Falha ao buscar configuração global.' }, { status: 500 });\r\n  }\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const body = await request.json();\r\n  const {\r\n    instance_name, // legacy naming\r\n    instance_id,\r\n    api_url, // legacy naming\r\n    api_base_url,\r\n    api_key, // legacy naming\r\n    token,\r\n    default_sender,\r\n    is_active,\r\n  } = body;\r\n\r\n  if (!instance_name && !instance_id) {\r\n    return NextResponse.json(\r\n      { error: 'instance_name or instance_id is required' },\r\n      { status: 400 }\r\n    );\r\n  }\r\n  if (!api_url && !api_base_url) {\r\n    return NextResponse.json(\r\n      { error: 'api_url or api_base_url is required' },\r\n      { status: 400 }\r\n    );\r\n  }\r\n  if (!api_key && !token) {\r\n    return NextResponse.json(\r\n      { error: 'api_key or token is required' },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Apenas superadmin pode escrever configuração global\r\n  const { data: roleRowPost } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  if (roleRowPost?.role !== 'superadmin') {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Se já existir, atualizar; caso contrário, criar\r\n  const { data: existing } = await supabase\r\n    .from('whatsapp_global_configs')\r\n    .select('id')\r\n    .order('updated_at', { ascending: false })\r\n    .limit(1)\r\n    .maybeSingle();\r\n\r\n  const payload = {\r\n    instance_id: instance_id ?? instance_name,\r\n    api_base_url: api_base_url ?? api_url,\r\n    token: token ?? api_key,\r\n    default_sender: default_sender ?? null,\r\n    is_active: is_active !== false,\r\n  };\r\n\r\n  let config: any = null;\r\n  if (existing?.id) {\r\n    const { data: updated, error } = await supabase\r\n      .from('whatsapp_global_configs')\r\n      .update(payload)\r\n      .eq('id', existing.id)\r\n      .select()\r\n      .single();\r\n    if (error) {\r\n      console.error('Error updating WhatsApp global config:', error);\r\n      const code = (error as any)?.code;\r\n      const message = (error as any)?.message;\r\n      const hint = (error as any)?.hint;\r\n      if (code === 'PGRST205' || /Could not find the table/i.test(String(message))) {\r\n        return NextResponse.json(\r\n          {\r\n            error:\r\n              'Tabela whatsapp_global_configs não encontrada. Execute as migrações do Supabase antes de salvar (20251107123000_global_settings.sql).',\r\n            hint,\r\n          },\r\n          { status: 503 }\r\n        );\r\n      }\r\n      return NextResponse.json({ error: 'Failed to update configuration' }, { status: 500 });\r\n    }\r\n    config = updated;\r\n  } else {\r\n    const { data: created, error } = await supabase\r\n      .from('whatsapp_global_configs')\r\n      .insert(payload)\r\n      .select()\r\n      .single();\r\n    if (error) {\r\n      console.error('Error creating WhatsApp global config:', error);\r\n      const code = (error as any)?.code;\r\n      const message = (error as any)?.message;\r\n      const hint = (error as any)?.hint;\r\n      if (code === 'PGRST205' || /Could not find the table/i.test(String(message))) {\r\n        return NextResponse.json(\r\n          {\r\n            error:\r\n              'Tabela whatsapp_global_configs não encontrada. Execute as migrações do Supabase antes de salvar (20251107123000_global_settings.sql).',\r\n            hint,\r\n          },\r\n          { status: 503 }\r\n        );\r\n      }\r\n      return NextResponse.json({ error: 'Failed to create configuration' }, { status: 500 });\r\n    }\r\n    config = created;\r\n  }\r\n\r\n  // Audit log (sem tenant)\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: roleRowPost?.id ?? null,\r\n    tenant_id: null,\r\n    action: 'CREATE',\r\n    resource_type: 'whatsapp_global_config',\r\n    resource_id: config.id,\r\n    changes: { created_by_auth_user_id: user.id },\r\n  });\r\n\r\n  return NextResponse.json({ config });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\settings\\whatsapp\\test\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1409,1412],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1409,1412],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":107,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3929,3932],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3929,3932],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4712,4715],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4712,4715],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":140,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5458,5461],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5458,5461],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6210,6213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6210,6213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":181,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6795,6798],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6795,6798],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\n\nexport async function POST(request: NextRequest) {\n  const supabase = await createClient();\n\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n  if (authError || !user) {\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  // Permissão: admin e superadmin podem testar configuração\n  const { data: roleRow } = await supabase\n    .from('users')\n    .select('id, role')\n    .eq('auth_user_id', user.id)\n    .single();\n\n  const role = roleRow?.role;\n  if (role !== 'admin' && role !== 'superadmin') {\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n  }\n\n  try {\n    const body = await request.json();\n    const { api_url, api_key, instance_name } = body;\n\n    if (!api_url || !api_key) {\n      return NextResponse.json(\n        { error: 'API URL e API Key são obrigatórios' },\n        { status: 400 }\n      );\n    }\n\n    // Normaliza a URL base removendo barras finais duplicadas\n    const baseUrl = String(api_url).replace(/\\/+$/, '');\n\n    // Testar conexão com a Evolution API\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout\n\n    try {\n      // Se informado, testa o estado de conexão da instância específica\n      let connectionState: any = null;\n      if (instance_name) {\n        const connResponse = await fetch(`${baseUrl}/instance/connectionState/${encodeURIComponent(instance_name)}`, {\n          method: 'GET',\n          headers: {\n            'apikey': api_key,\n            'Content-Type': 'application/json',\n          },\n          signal: controller.signal,\n        });\n\n        if (!connResponse.ok) {\n          const errorText = await connResponse.text().catch(() => 'Erro desconhecido');\n          return NextResponse.json({\n            success: false,\n            error: `Erro na API (connectionState): ${connResponse.status} - ${errorText}`,\n            instances: [],\n            connection_state: null,\n          }, { status: 400 });\n        }\n\n        connectionState = await connResponse.json().catch(() => null);\n      }\n\n      // Buscar instâncias disponíveis\n      const instancesResponse = await fetch(`${baseUrl}/instance/fetchInstances`, {\n        method: 'GET',\n        headers: {\n          'apikey': api_key,\n          'Content-Type': 'application/json',\n        },\n        signal: controller.signal,\n      });\n\n      if (!instancesResponse.ok) {\n        const errorText = await instancesResponse.text().catch(() => 'Erro desconhecido');\n        return NextResponse.json({\n          success: false,\n          error: `Erro ao buscar instâncias: ${instancesResponse.status} - ${errorText}`,\n          instances: [],\n          connection_status: 'error'\n        }, { status: 400 });\n      }\n\n      const rawInstances = await instancesResponse.json();\n\n      // Helper: extrai telefone do owner JID\n      const ownerToPhone = (owner: string | null | undefined) => {\n        if (!owner) return 'Não disponível';\n        const match = String(owner).match(/^(\\d+)/);\n        return match ? match[1] : 'Não disponível';\n      };\n\n      // Formatar dados das instâncias conforme docs oficiais\n      // Docs: GET /instance/fetchInstances retorna array de objetos com a chave \"instance\"\n      // Observação: algumas versões da Evolution API expõem o estado de conexão\n      // no campo `connectionStatus` do objeto `instance`. Nosso mapeamento anterior\n      // considerava apenas `status`/`state`, o que pode resultar em \"0 conectadas\"\n      // mesmo quando a instância está com `connectionStatus = open/connected`.\n      // Abaixo incluímos `connectionStatus` e usamos esse campo como principal\n      // para determinar se a instância está conectada.\n      const instances = Array.isArray(rawInstances)\n        ? rawInstances.map((item: any) => {\n            const inst = item.instance ?? item;\n            return {\n              name: inst.instanceName || inst.name || 'Desconhecido',\n              // preservar ambos para exibição\n              status: inst.status || inst.state || 'unknown',\n              connectionStatus: inst.connectionStatus || inst.state || 'unknown',\n              number: inst.phone || ownerToPhone(inst.owner),\n              owner: inst.owner || 'Não disponível',\n              profileName: inst.profileName || inst.profile?.name || 'Não disponível',\n              profilePictureUrl: inst.profilePictureUrl || inst.profile?.picture || null,\n            };\n          })\n        : [];\n\n      // Verificar se há instâncias conectadas\n      const connectedInstances = instances.filter((instance: any) => {\n        const s = String((instance.connectionStatus ?? instance.status) || '').toLowerCase();\n        return s === 'open' || s === 'connected';\n      });\n\n      // Registrar auditoria do último estado (sem segredos)\n      try {\n        await supabase.from('audit_logs').insert({\n          user_id: roleRow?.id ?? null,\n          tenant_id: null,\n          action: 'whatsapp_test',\n          resource_type: 'evolution_api',\n          resource_id: instance_name ?? null,\n          changes: {\n            connection_state: connectionState?.instance?.state ?? connectionState?.state ?? null,\n            total_instances: instances.length,\n            connected_instances: connectedInstances.length,\n            instances: instances.map((i: any) => ({\n              name: i.name,\n              status: i.status,\n              connectionStatus: i.connectionStatus,\n              number: i.number,\n            })),\n          },\n        });\n      } catch (auditErr) {\n        console.warn('Falha ao registrar auditoria do teste WhatsApp:', auditErr);\n      }\n\n      return NextResponse.json({\n        success: true,\n        message: `Conexão bem-sucedida! ${instances.length} instância(s) encontrada(s), ${connectedInstances.length} conectada(s).`,\n        instances,\n        connection_state: connectionState?.instance?.state ?? connectionState?.state ?? null,\n        total_instances: instances.length,\n        connected_instances: connectedInstances.length\n      });\n\n    } catch (fetchError: any) {\n      clearTimeout(timeoutId);\n      \n      if (fetchError.name === 'AbortError') {\n        return NextResponse.json({\n          success: false,\n          error: 'Timeout na conexão. Verifique se a URL está correta e a API está acessível.',\n          instances: [],\n          connection_status: 'timeout'\n        }, { status: 408 });\n      }\n\n      return NextResponse.json({\n        success: false,\n        error: `Erro de conexão: ${fetchError.message}`,\n        instances: [],\n        connection_status: 'connection_error'\n      }, { status: 500 });\n    }\n\n  } catch (error: any) {\n    console.error('WhatsApp test error:', error);\n    return NextResponse.json({\n      success: false,\n      error: `Erro interno: ${error.message}`,\n      instances: [],\n      connection_status: 'internal_error'\n    }, { status: 500 });\n  }\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\submissions\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[325,328],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[325,328],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1220,1223],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1220,1223],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1492,1495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1492,1495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2584,2587],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2584,2587],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":125,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":125,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3458,3461],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3458,3461],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3730,3733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3730,3733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":187,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5275,5278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5275,5278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\n// Evitar qualquer cache para este handler\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// GET /api/submissions/[id] - Buscar submissão por ID\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const { data: submission, error } = await supabase\r\n      .from('submissions')\r\n      .select(`\r\n        *,\r\n        tenants (\r\n          id,\r\n          name,\r\n          slug\r\n        ),\r\n        form_definitions (\r\n          id,\r\n          name,\r\n          form_fields (\r\n            id,\r\n            label,\r\n            name,\r\n            type\r\n          )\r\n        )\r\n      `)\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    if (error) {\r\n      return NextResponse.json({ error: error.message }, { status: 404 });\r\n    }\r\n\r\n    return NextResponse.json({ submission });\r\n  } catch (error: any) {\r\n    console.error('Error fetching submission:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// PATCH /api/submissions/[id] - Atualizar submissão\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usuário\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Parse do body\r\n    const body = await request.json();\r\n    const { payment_status, data: formData, metadata } = body;\r\n\r\n    // Buscar submission antiga para auditoria\r\n    const { data: oldSubmission } = await supabase\r\n      .from('submissions')\r\n      .select('*')\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    if (!oldSubmission) {\r\n      return NextResponse.json({ error: 'Submission not found' }, { status: 404 });\r\n    }\r\n\r\n    // Atualizar submissão\r\n    const updateData: any = {};\r\n    if (payment_status) updateData.payment_status = payment_status;\r\n    if (formData) updateData.data = formData;\r\n    if (metadata) updateData.metadata = { ...oldSubmission.metadata, ...metadata };\r\n\r\n    const { data: submission, error: updateError } = await supabase\r\n      .from('submissions')\r\n      .update(updateData)\r\n      .eq('id', params.id)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      return NextResponse.json({ error: updateError.message }, { status: 500 });\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'UPDATE',\r\n      resource_type: 'submission',\r\n      resource_id: params.id,\r\n      changes: {\r\n        old: oldSubmission,\r\n        new: updateData,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({ submission });\r\n  } catch (error: any) {\r\n    console.error('Error updating submission:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// DELETE /api/submissions/[id] - Deletar submissão\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usuário\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Buscar submission para auditoria\r\n    const { data: submission } = await supabase\r\n      .from('submissions')\r\n      .select('*')\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    if (!submission) {\r\n      return NextResponse.json({ error: 'Submission not found' }, { status: 404 });\r\n    }\r\n\r\n    // Deletar (não depender de retorno de linhas, pois RLS pode impedir returning)\r\n    const { error: deleteError } = await supabase\r\n      .from('submissions')\r\n      .delete()\r\n      .eq('id', params.id);\r\n\r\n    if (deleteError) {\r\n      return NextResponse.json({ error: deleteError.message }, { status: 500 });\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'DELETE',\r\n      resource_type: 'submission',\r\n      resource_id: params.id,\r\n      changes: { deleted: submission },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error: any) {\r\n    console.error('Error deleting submission:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\submissions\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1895,1898],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1895,1898],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":120,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4259,4262],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4259,4262],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5058,5061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5058,5061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":138,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":138,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6086,6089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6086,6089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\n// Garantir que a rota seja sempre dinâmica (sem cache)\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// GET /api/submissions - Listar submissões com filtros\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usuário\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role, admin_tenants(tenant_id)')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Obter parâmetros de query\r\n    const { searchParams } = new URL(request.url);\r\n    const tenant_id = searchParams.get('tenant_id');\r\n    const form_id = searchParams.get('form_id');\r\n    const payment_status = searchParams.get('payment_status');\r\n    const search = searchParams.get('search');\r\n    const limit = parseInt(searchParams.get('limit') || '50');\r\n    const offset = parseInt(searchParams.get('offset') || '0');\r\n\r\n    // Query base\r\n    let query = supabase\r\n      .from('submissions')\r\n      .select(`\r\n        *,\r\n        tenants (\r\n          id,\r\n          name,\r\n          slug\r\n        ),\r\n        form_definitions (\r\n          id,\r\n          name\r\n        )\r\n      `, { count: 'exact' })\r\n      .order('created_at', { ascending: false })\r\n      .range(offset, offset + limit - 1);\r\n\r\n    // Filtrar por tenants se não for superadmin\r\n    if (userData.role !== 'superadmin') {\r\n      const tenantIds = userData.admin_tenants?.map((at: any) => at.tenant_id) || [];\r\n      if (tenantIds.length === 0) {\r\n        return NextResponse.json({ submissions: [], total: 0 });\r\n      }\r\n      query = query.in('tenant_id', tenantIds);\r\n    }\r\n\r\n    // Aplicar filtros\r\n    if (tenant_id) {\r\n      query = query.eq('tenant_id', tenant_id);\r\n    }\r\n    if (form_id) {\r\n      query = query.eq('form_definition_id', form_id);\r\n    }\r\n    if (payment_status) {\r\n      query = query.eq('payment_status', payment_status);\r\n    }\r\n\r\n    // Busca por texto (nome, e-mail, telefone/whatsapp) e por IDs de aluno/submissão\r\n    if (search) {\r\n      const s = search.trim();\r\n\r\n      // Montar lista de clausulas OR\r\n      const orClauses: string[] = [\r\n        `data->>'email'.ilike.*${s}*`,\r\n        `data->>'contato_email'.ilike.*${s}*`,\r\n        `data->>'e-mail'.ilike.*${s}*`,\r\n        `data->>'nome'.ilike.*${s}*`,\r\n        `data->>'nome_completo'.ilike.*${s}*`,\r\n        `data->>'name'.ilike.*${s}*`,\r\n        // variações comuns de nome\r\n        `data->>'aluno'.ilike.*${s}*`,\r\n        `data->>'nome_aluno'.ilike.*${s}*`,\r\n        `data->>'nome_do_aluno'.ilike.*${s}*`,\r\n        `data->>'responsavel_nome'.ilike.*${s}*`,\r\n        `data->>'telefone'.ilike.*${s}*`,\r\n        `data->>'phone'.ilike.*${s}*`,\r\n        `data->>'whatsapp'.ilike.*${s}*`,\r\n        `data->>'celular'.ilike.*${s}*`,\r\n        `data->>'zap'.ilike.*${s}*`,\r\n      ];\r\n\r\n      // 1) Buscar por ID da submissão (UUID) quando o termo corresponde a um padrão UUID\r\n      const uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;\r\n      if (uuidRegex.test(s)) {\r\n        orClauses.push(`id.eq.${s}`);\r\n      }\r\n\r\n      // 2) Buscar por campos de ID do aluno nos formulários\r\n      //    - Candidatos padrão\r\n      const idCandidatesDefault = [\r\n        'id_aluno', 'matricula', 'ra', 'student_id', 'codigo_aluno', 'registro', 'inscricao', 'id'\r\n      ];\r\n\r\n      //    - Descobrir dinamicamente nomes de campos que parecem IDs nos formulários\r\n      try {\r\n        const patterns = ['*id*', '*matric*', '*ra*', '*codigo*', '*registro*', '*inscr*'];\r\n        const { data: ff } = await supabase\r\n          .from('form_fields')\r\n          .select('name')\r\n          .or(patterns.map(p => `name.ilike.${p}`).join(','))\r\n          .limit(500);\r\n        const dynamicNames = Array.from(new Set((ff || []).map((r: any) => String(r.name))));\r\n        const idFieldNames = Array.from(new Set([...idCandidatesDefault, ...dynamicNames]));\r\n        for (const fieldName of idFieldNames) {\r\n          // Busca parcial por ID do aluno no JSON\r\n          orClauses.push(`data->>'${fieldName}'.ilike.*${s}*`);\r\n        }\r\n\r\n        // 3) Descobrir dinamicamente campos de nome/telefone para ampliar a busca\r\n        const namePhonePatterns = ['*nome*', '*aluno*', '*name*', '*whats*', '*zap*', '*tel*', '*fone*', '*cel*', '*telefone*', '*celular*'];\r\n        const { data: ff2 } = await supabase\r\n          .from('form_fields')\r\n          .select('name')\r\n          .or(namePhonePatterns.map(p => `name.ilike.${p}`).join(','))\r\n          .limit(500);\r\n        const namePhoneNames = Array.from(new Set((ff2 || []).map((r: any) => String(r.name))));\r\n        for (const fieldName of namePhoneNames) {\r\n          orClauses.push(`data->>'${fieldName}'.ilike.*${s}*`);\r\n        }\r\n      } catch (e) {\r\n        // Se não conseguir ler form_fields (RLS), usa somente candidatos padrão\r\n        for (const fieldName of idCandidatesDefault) {\r\n          orClauses.push(`data->>'${fieldName}'.ilike.*${s}*`);\r\n        }\r\n      }\r\n\r\n      // Fallback geral: busca em todo o JSON como texto\r\n      orClauses.push(`data::text.ilike.*${s}*`);\r\n\r\n      // Aplicar OR acumulado\r\n      query = query.or(orClauses.join(','));\r\n    }\r\n\r\n    const { data: submissions, error: submissionsError, count } = await query;\r\n\r\n    if (submissionsError) {\r\n      console.error('Error fetching submissions:', submissionsError);\r\n      return NextResponse.json({ error: submissionsError.message }, { status: 500 });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      submissions: submissions || [],\r\n      total: count || 0,\r\n      limit,\r\n      offset,\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Error in submissions GET:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\templates\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2052,2055],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2052,2055],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n  const body = await request.json();\r\n  // Aceitar aliases (name/title, message_template/content)\r\n  const name = body.name ?? body.title;\r\n  const message_template = body.message_template ?? body.content;\r\n  const trigger_event = body.trigger_event ?? body.key;\r\n  const is_active = body.is_active;\r\n\r\n  // Verificar se o template existe e se o admin tem permissão (tabela message_templates)\r\n  const { data: existingTemplate, error: fetchError } = await supabase\r\n    .from('message_templates')\r\n    .select('tenant_id, title')\r\n    .eq('id', id)\r\n    .single();\r\n\r\n  if (fetchError || !existingTemplate) {\r\n    return NextResponse.json({ error: 'Template not found' }, { status: 404 });\r\n  }\r\n\r\n  // Verificar permissão: superadmin tem acesso global; admin precisa ser do tenant\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n  const isSuperAdmin = roleRow?.role === 'superadmin';\r\n  if (!isSuperAdmin) {\r\n    return NextResponse.json({ error: 'Apenas superadmin pode editar templates globais' }, { status: 403 });\r\n  }\r\n\r\n  // Validar trigger_event se fornecido (expandido)\r\n  if (trigger_event) {\r\n    const validTriggers = ['payment_approved', 'payment_approved_email', 'payment_reminder', 'welcome', 'submission_created', 'manual'];\r\n    if (!validTriggers.includes(trigger_event)) {\r\n      return NextResponse.json({ error: 'Invalid trigger_event' }, { status: 400 });\r\n    }\r\n  }\r\n\r\n  // Atualizar template (tabela message_templates)\r\n  const updateData: any = {};\r\n  if (name !== undefined) updateData.title = name;\r\n  if (message_template !== undefined) {\r\n    updateData.content = message_template;\r\n    // Atualizar variáveis dinamicamente conforme placeholders\r\n    const variables = Array.from((message_template as string).matchAll(/\\{\\{(\\w+)\\}\\}/g)).map(m => m[1]);\r\n    updateData.variables = variables;\r\n  }\r\n  if (trigger_event !== undefined) updateData.key = trigger_event;\r\n  if (is_active !== undefined) updateData.is_active = is_active;\r\n\r\n  const { data: templateRow, error } = await supabase\r\n    .from('message_templates')\r\n    .update(updateData)\r\n    .eq('id', id)\r\n    .select('id, tenant_id, key, title, content, variables, is_active, created_at')\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error('Error updating template:', error);\r\n    return NextResponse.json({ error: 'Failed to update template' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: user.id,\r\n    tenant_id: null,\r\n    action: 'update',\r\n    resource_type: 'message_template',\r\n    resource_id: id,\r\n    changes: { message: `Template global atualizado: ${existingTemplate.title}` },\r\n  });\r\n\r\n  // Responder no formato esperado pela UI\r\n  return NextResponse.json({ template: {\r\n    id: templateRow.id,\r\n    tenant_id: templateRow.tenant_id,\r\n    name: templateRow.title,\r\n    message_template: templateRow.content,\r\n    trigger_event: templateRow.key,\r\n    variables: templateRow.variables ?? [],\r\n    is_active: !!templateRow.is_active,\r\n    created_at: templateRow.created_at,\r\n  } });\r\n}\r\n\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const { id } = await context.params;\r\n\r\n  // Verificar se o template existe e se o admin tem permissão (tabela message_templates)\r\n  const { data: existingTemplate, error: fetchError } = await supabase\r\n    .from('message_templates')\r\n    .select('tenant_id, title')\r\n    .eq('id', id)\r\n    .single();\r\n\r\n  if (fetchError || !existingTemplate) {\r\n    return NextResponse.json({ error: 'Template not found' }, { status: 404 });\r\n  }\r\n\r\n  // Verificar permissão: superadmin tem acesso global; admin precisa ser do tenant\r\n  const { data: roleRowDel } = await supabase\r\n    .from('users')\r\n    .select('role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n  const isSuperAdminDel = roleRowDel?.role === 'superadmin';\r\n  if (!isSuperAdminDel) {\r\n    return NextResponse.json({ error: 'Apenas superadmin pode excluir templates globais' }, { status: 403 });\r\n  }\r\n\r\n  // Deletar template (tabela message_templates)\r\n  const { error } = await supabase\r\n    .from('message_templates')\r\n    .delete()\r\n    .eq('id', id);\r\n\r\n  if (error) {\r\n    console.error('Error deleting template:', error);\r\n    return NextResponse.json({ error: 'Failed to delete template' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: user.id,\r\n    tenant_id: null,\r\n    action: 'delete',\r\n    resource_type: 'message_template',\r\n    resource_id: id,\r\n    changes: { message: `Template global excluído: ${existingTemplate.title}` },\r\n  });\r\n\r\n  return NextResponse.json({ success: true });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\templates\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":4,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  // Permissões: qualquer usuário autenticado com papel admin/superadmin pode listar templates globais\r\n  const { data: roleRow } = await supabase\r\n    .from('users')\r\n    .select('role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n  const role = roleRow?.role;\r\n  if (!role || (role !== 'admin' && role !== 'superadmin')) {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n  }\r\n\r\n  // Buscar templates globais (tenant_id IS NULL)\r\n  const { data: mtData, error } = await supabase\r\n    .from('message_templates')\r\n    .select('id, tenant_id, key, title, content, variables, is_active, created_at')\r\n    .is('tenant_id', null)\r\n    .order('created_at', { ascending: false });\r\n\r\n  if (error) {\r\n    console.error('Error fetching templates:', error);\r\n    return NextResponse.json({ error: 'Failed to fetch templates' }, { status: 500 });\r\n  }\r\n\r\n  // Mapear para formato neutro consumido por múltiplas UIs\r\n  const templates = (mtData || []).map((t) => ({\r\n    id: t.id,\r\n    tenant_id: t.tenant_id,\r\n    name: t.title,\r\n    message_template: t.content,\r\n    trigger_event: t.key,\r\n    variables: t.variables ?? [],\r\n    is_active: !!t.is_active,\r\n    created_at: t.created_at,\r\n  }));\r\n\r\n  return NextResponse.json({ templates });\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const supabase = await createClient();\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n  }\r\n\r\n  const body = await request.json();\r\n  // Suportar ambas convenções: name/title e message_template/content\r\n  const name = body.name ?? body.title;\r\n  const message_template = body.message_template ?? body.content;\r\n  const trigger_event = body.trigger_event ?? body.key;\r\n  const is_active = body.is_active;\r\n\r\n  if (!name || !message_template || !trigger_event) {\r\n    return NextResponse.json(\r\n      { error: 'name/title, message_template/content e trigger_event são obrigatórios' },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Validar trigger_event (expandido para suportar e-mail pós-pagamento e templates comuns)\r\n  const validTriggers = ['payment_approved', 'payment_approved_email', 'payment_reminder', 'welcome', 'submission_created', 'manual'];\r\n  if (!validTriggers.includes(trigger_event)) {\r\n    return NextResponse.json({ error: 'Invalid trigger_event' }, { status: 400 });\r\n  }\r\n\r\n  // Verificar permissão: superadmin tem acesso global; admin precisa ser do tenant\r\n  const { data: roleRowPost } = await supabase\r\n    .from('users')\r\n    .select('role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n\r\n  // Templates globais: apenas superadmin pode criar/editar/deletar\r\n  const isSuperAdminPost = roleRowPost?.role === 'superadmin';\r\n  if (!isSuperAdminPost) {\r\n    return NextResponse.json({ error: 'Apenas superadmin pode criar templates globais' }, { status: 403 });\r\n  }\r\n\r\n  // Criar template (tabela message_templates)\r\n  const variables = Array.from((message_template as string).matchAll(/\\{\\{(\\w+)\\}\\}/g)).map(m => m[1]);\r\n\r\n  // Evitar duplicidade de chave global\r\n  const { data: existingByKey } = await supabase\r\n    .from('message_templates')\r\n    .select('id')\r\n    .is('tenant_id', null)\r\n    .eq('key', trigger_event)\r\n    .maybeSingle();\r\n  if (existingByKey) {\r\n    return NextResponse.json({ error: 'Já existe um template global com essa chave. Edite o existente ou escolha outra chave.' }, { status: 409 });\r\n  }\r\n  const { data: templateRow, error } = await supabase\r\n    .from('message_templates')\r\n    .insert({\r\n      tenant_id: null,\r\n      key: trigger_event,\r\n      title: name,\r\n      content: message_template,\r\n      variables,\r\n      is_active: is_active !== false,\r\n    })\r\n    .select('id, tenant_id, key, title, content, variables, is_active, created_at')\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error('Error creating template:', error);\r\n    return NextResponse.json({ error: 'Failed to create template' }, { status: 500 });\r\n  }\r\n\r\n  // Audit log\r\n  await supabase.from('audit_logs').insert({\r\n    user_id: user.id,\r\n    tenant_id: null,\r\n    action: 'create',\r\n    resource_type: 'message_template',\r\n    resource_id: templateRow.id,\r\n    changes: { message: `Template global criado: ${name}` },\r\n  });\r\n\r\n  // Responder no formato esperado pela UI\r\n  return NextResponse.json({ template: {\r\n    id: templateRow.id,\r\n    tenant_id: templateRow.tenant_id,\r\n    name: templateRow.title,\r\n    message_template: templateRow.content,\r\n    trigger_event: templateRow.key,\r\n    variables: templateRow.variables ?? [],\r\n    is_active: !!templateRow.is_active,\r\n    created_at: templateRow.created_at,\r\n  } });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\tenants\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[231,234],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[231,234],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[833,836],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[833,836],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1094,1097],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1094,1097],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2902,2905],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2902,2905],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3163,3166],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3163,3166],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4545,4548],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4545,4548],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\n// GET /api/tenants/[id] - Buscar tenant por ID\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const { data: tenant, error } = await supabase\r\n      .from('tenants')\r\n      .select('*')\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    if (error) {\r\n      return NextResponse.json({ error: error.message }, { status: 404 });\r\n    }\r\n\r\n    return NextResponse.json({ tenant });\r\n  } catch (error: any) {\r\n    console.error('Error fetching tenant:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// PATCH /api/tenants/[id] - Atualizar tenant\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Verificar se é superadmin\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError || userData?.role !== 'superadmin') {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n\r\n    // Parse do body\r\n    const body = await request.json();\r\n    const { name, slug, status, settings } = body;\r\n\r\n    // Buscar tenant antigo para auditoria\r\n    const { data: oldTenant } = await supabase\r\n      .from('tenants')\r\n      .select('*')\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    // Atualizar tenant\r\n    const { data: tenant, error: updateError } = await supabase\r\n      .from('tenants')\r\n      .update({\r\n        ...(name && { name }),\r\n        ...(slug && { slug }),\r\n        ...(status !== undefined && { status }),\r\n        ...(settings && { settings }),\r\n      })\r\n      .eq('id', params.id)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      return NextResponse.json({ error: updateError.message }, { status: 500 });\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      tenant_id: params.id,\r\n      user_id: userData.id,\r\n      action: 'UPDATE',\r\n      resource_type: 'tenant',\r\n      resource_id: params.id,\r\n      changes: {\r\n        old: oldTenant,\r\n        new: { name, slug, status, settings },\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({ tenant });\r\n  } catch (error: any) {\r\n    console.error('Error updating tenant:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// DELETE /api/tenants/[id] - Deletar tenant\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  { params }: any\r\n) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Verificar se é superadmin\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError || userData?.role !== 'superadmin') {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n\r\n    // Buscar tenant para auditoria\r\n    const { data: tenant } = await supabase\r\n      .from('tenants')\r\n      .select('*')\r\n      .eq('id', params.id)\r\n      .single();\r\n\r\n    // Deletar tenant\r\n    const { error: deleteError } = await supabase\r\n      .from('tenants')\r\n      .delete()\r\n      .eq('id', params.id);\r\n\r\n    if (deleteError) {\r\n      return NextResponse.json({ error: deleteError.message }, { status: 500 });\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      user_id: userData.id,\r\n      action: 'DELETE',\r\n      resource_type: 'tenant',\r\n      resource_id: params.id,\r\n      changes: { deleted: tenant },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error: any) {\r\n    console.error('Error deleting tenant:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\tenants\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_req' is defined but never used.","line":6,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1316,1319],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1316,1319],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":104,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3349,3352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3349,3352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport type { Database } from '@/lib/supabase/client';\r\n\r\n// GET /api/tenants - Listar todos os tenants\r\nexport async function GET(_req: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Buscar dados do usuário para verificar role\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    if (userError || !userData) {\r\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n    }\r\n\r\n    // Buscar tenants (RLS vai filtrar automaticamente)\r\n    const { data: tenants, error: tenantsError } = await supabase\r\n      .from('tenants')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (tenantsError) {\r\n      return NextResponse.json({ error: tenantsError.message }, { status: 500 });\r\n    }\r\n\r\n    return NextResponse.json({ tenants, role: userData.role });\r\n  } catch (error: any) {\r\n    console.error('Error fetching tenants:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// POST /api/tenants - Criar novo tenant\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Verificar se é superadmin\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('role')\r\n      .eq('auth_user_id', user.id)\r\n      .single();\r\n\r\n    type UserBasic = Pick<Database['public']['Tables']['users']['Row'], 'id' | 'role'>;\r\n    const userBasic = userData as UserBasic;\r\n    if (userError || userBasic?.role !== 'superadmin') {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n\r\n    // Parse do body\r\n    const body = await request.json();\r\n    const { name, slug, status, settings } = body;\r\n\r\n    // Validações\r\n    if (!name || !slug) {\r\n      return NextResponse.json({ error: 'Name and slug are required' }, { status: 400 });\r\n    }\r\n\r\n    // Criar tenant\r\n    const { data: tenant, error: createError } = await supabase\r\n      .from('tenants')\r\n      .insert({\r\n        name,\r\n        slug,\r\n        status: status !== undefined ? status : true,\r\n        settings: settings || {},\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (createError) {\r\n      return NextResponse.json({ error: createError.message }, { status: 500 });\r\n    }\r\n\r\n    // Registrar auditoria\r\n    await supabase.from('audit_logs').insert({\r\n      tenant_id: tenant.id,\r\n      user_id: userBasic.id,\r\n      action: 'CREATE',\r\n      resource_type: 'tenant',\r\n      resource_id: tenant.id,\r\n      changes: { name, slug, status, settings },\r\n    });\r\n\r\n    return NextResponse.json({ tenant }, { status: 201 });\r\n  } catch (error: any) {\r\n    console.error('Error creating tenant:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\upload\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'uploadData' is assigned a value but never used.","line":61,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":61,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const formData = await request.formData();\r\n    const file = formData.get('file') as File;\r\n    const fieldName = formData.get('fieldName') as string;\r\n    const tenantId = formData.get('tenantId') as string;\r\n    \r\n    if (!file) {\r\n      return NextResponse.json({ error: 'No file provided' }, { status: 400 });\r\n    }\r\n\r\n    if (!fieldName || !tenantId) {\r\n      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });\r\n    }\r\n\r\n    // Validações\r\n    const maxSize = 10 * 1024 * 1024; // 10MB\r\n    if (file.size > maxSize) {\r\n      return NextResponse.json({ error: 'File size exceeds 10MB limit' }, { status: 400 });\r\n    }\r\n\r\n    const allowedTypes = [\r\n      // Imagens permitidas\r\n      'image/jpeg',\r\n      'image/png',\r\n      'image/webp',\r\n      // Documentos permitidos\r\n      'application/pdf',\r\n      'application/msword',\r\n      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n      'application/vnd.ms-excel',\r\n      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n    ];\r\n\r\n    if (!allowedTypes.includes(file.type)) {\r\n      return NextResponse.json({ error: 'File type not allowed' }, { status: 400 });\r\n    }\r\n\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Gerar nome único para o arquivo\r\n    const timestamp = Date.now();\r\n    const randomString = Math.random().toString(36).substring(7);\r\n    const fileExt = file.name.split('.').pop();\r\n    const fileName = `${timestamp}_${randomString}.${fileExt}`;\r\n    const storagePath = `${tenantId}/${fieldName}/${fileName}`;\r\n\r\n    // Upload para o Supabase Storage\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n\r\n    const { data: uploadData, error: uploadError } = await supabase.storage\r\n      .from('form-submissions')\r\n      .upload(storagePath, buffer, {\r\n        contentType: file.type,\r\n        upsert: false,\r\n      });\r\n\r\n    if (uploadError) {\r\n      console.error('Upload error:', uploadError);\r\n      return NextResponse.json({ error: 'Failed to upload file' }, { status: 500 });\r\n    }\r\n\r\n    // Gerar URL assinada (válida para acesso direto, mesmo com bucket privado)\r\n    const { data: signedData, error: signedError } = await supabase.storage\r\n      .from('form-submissions')\r\n      .createSignedUrl(storagePath, 60 * 60 * 24 * 7); // 7 dias\r\n\r\n    if (signedError) {\r\n      console.error('Signed URL error:', signedError);\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      file: {\r\n        name: file.name,\r\n        size: file.size,\r\n        type: file.type,\r\n        storagePath,\r\n        url: signedData?.signedUrl || null,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error('Upload error:', error);\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\r\n  }\r\n}\r\n\r\n// Deletar arquivo\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const storagePath = searchParams.get('path');\r\n\r\n    if (!storagePath) {\r\n      return NextResponse.json({ error: 'No path provided' }, { status: 400 });\r\n    }\r\n\r\n    const supabase = await createClient();\r\n\r\n    // Verificar autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Deletar do storage\r\n    const { error: deleteError } = await supabase.storage\r\n      .from('form-submissions')\r\n      .remove([storagePath]);\r\n\r\n    if (deleteError) {\r\n      console.error('Delete error:', deleteError);\r\n      return NextResponse.json({ error: 'Failed to delete file' }, { status: 500 });\r\n    }\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Delete error:', error);\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\users\\ensure\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1370,1373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1370,1373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1816,1819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1816,1819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2169,2172],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2169,2172],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server'\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { createAdminClient } from '@/lib/supabase/admin'\r\n\r\nfunction decodeJwt(token: string | undefined): { sub?: string; email?: string } {\r\n  try {\r\n    if (!token) return {}\r\n    const parts = token.split('.')\r\n    if (parts.length < 2) return {}\r\n    const payload = JSON.parse(Buffer.from(parts[1], 'base64').toString('utf8'))\r\n    return { sub: payload?.sub, email: payload?.email }\r\n  } catch {\r\n    return {}\r\n  }\r\n}\r\n\r\n// Garante que exista um registro em public.users vinculado ao usuário autenticado.\r\n// Usa Service Role no backend (NUNCA exposta ao cliente) para bypass de RLS quando necessário.\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // Tentar obter user via cookie; se não vier, usar Authorization Bearer\r\n    const supabase = await createClient()\r\n    const {\r\n      data: { user: cookieUser },\r\n    } = await supabase.auth.getUser()\r\n\r\n    let user = cookieUser\r\n    if (!user) {\r\n      const authHeader = req.headers.get('authorization') || req.headers.get('Authorization')\r\n      const bearer = authHeader?.startsWith('Bearer ')\r\n        ? authHeader.substring('Bearer '.length)\r\n        : undefined\r\n      const claims = decodeJwt(bearer)\r\n      if (claims?.sub) {\r\n        user = { id: claims.sub, email: claims.email ?? null } as any\r\n      }\r\n    }\r\n\r\n    if (!user) {\r\n      return NextResponse.json({ error: 'not_authenticated' }, { status: 401 })\r\n    }\r\n\r\n    const admin = createAdminClient()\r\n\r\n    // Upsert idempotente por email: garante criação/atualização do vínculo auth_user_id\r\n    const { data: ensured, error: upsertErr } = await admin\r\n      .from('users')\r\n      .upsert({\r\n        auth_user_id: user.id,\r\n        email: user.email!,\r\n        name: (user as any)?.user_metadata?.name ?? (user.email?.split('@')[0] ?? 'Usuário'),\r\n        is_active: true,\r\n      }, { onConflict: 'email' })\r\n      .select()\r\n      .single()\r\n\r\n    if (upsertErr) {\r\n      return NextResponse.json({ error: upsertErr.message }, { status: 500 })\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, id: ensured.id })\r\n  } catch (e: any) {\r\n    return NextResponse.json({ error: e?.message ?? 'unexpected_error' }, { status: 500 })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\users\\me\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'readErr' is assigned a value but never used.","line":46,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":40},{"ruleId":"prefer-const","severity":2,"message":"'readErr' is never reassigned. Use 'const' instead.","line":46,"column":33,"nodeType":"Identifier","messageId":"useConst","endLine":46,"endColumn":40},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2363,2366],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2363,2366],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server'\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { createAdminClient } from '@/lib/supabase/admin'\r\n\r\nfunction decodeJwt(token: string | undefined): { sub?: string; email?: string } {\r\n  try {\r\n    if (!token) return {}\r\n    const parts = token.split('.')\r\n    if (parts.length < 2) return {}\r\n    const payload = JSON.parse(Buffer.from(parts[1], 'base64').toString('utf8'))\r\n    return { sub: payload?.sub, email: payload?.email }\r\n  } catch {\r\n    return {}\r\n  }\r\n}\r\n\r\n// Retorna o próprio usuário autenticado (registro de public.users)\r\n// Usa Service Role no backend para garantir leitura idempotente sem depender de RLS\r\nexport async function GET(req: Request) {\r\n  try {\r\n    // 1) Obter usuário via cookie; fallback para Authorization: Bearer <access_token>\r\n    const supabase = await createClient()\r\n    const {\r\n      data: { user: cookieUser },\r\n    } = await supabase.auth.getUser()\r\n\r\n    let user = cookieUser as { id: string; email: string | null } | null\r\n    if (!user) {\r\n      const authHeader = req.headers.get('authorization') || req.headers.get('Authorization')\r\n      const bearer = authHeader?.startsWith('Bearer ')\r\n        ? authHeader.substring('Bearer '.length)\r\n        : undefined\r\n      const claims = decodeJwt(bearer)\r\n      if (claims?.sub) {\r\n        user = { id: claims.sub!, email: claims.email ?? null }\r\n      }\r\n    }\r\n\r\n    if (!user) {\r\n      return NextResponse.json({ error: 'not_authenticated' }, { status: 401 })\r\n    }\r\n\r\n    const admin = createAdminClient()\r\n\r\n    // 2) Tentar localizar por auth_user_id primeiro\r\n    let { data: userRow, error: readErr } = await admin\r\n      .from('users')\r\n      .select('*')\r\n      .eq('auth_user_id', user.id)\r\n      .maybeSingle()\r\n\r\n    // 3) Fallback por email, se disponível\r\n    if (!userRow && user.email) {\r\n      const { data: byEmail, error: byEmailErr } = await admin\r\n        .from('users')\r\n        .select('*')\r\n        .eq('email', user.email)\r\n        .maybeSingle()\r\n\r\n      if (byEmailErr) {\r\n        return NextResponse.json({ error: byEmailErr.message }, { status: 500 })\r\n      }\r\n      if (byEmail) userRow = byEmail\r\n    }\r\n\r\n    if (!userRow) {\r\n      return NextResponse.json({ error: 'user_not_found' }, { status: 404 })\r\n    }\r\n\r\n    return NextResponse.json({ user: userRow })\r\n  } catch (e: any) {\r\n    return NextResponse.json({ error: e?.message ?? 'unexpected_error' }, { status: 500 })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\webhooks\\mercadopago\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2167,2170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2167,2170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":199,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6634,6637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6634,6637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":314,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":314,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":321,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":321,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10914,10917],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10914,10917],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":377,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":377,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13141,13144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13141,13144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport { sendEmail } from '@/lib/resend';\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY! || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n);\r\n\r\n// POST /api/webhooks/mercadopago - Webhook do Mercado Pago\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    \r\n    console.log('Mercado Pago webhook received:', body);\r\n\r\n    // Mercado Pago envia tipo e ID do recurso\r\n    const { type, data } = body;\r\n\r\n    // Verificar se é uma notificação de pagamento\r\n    if (type !== 'payment') {\r\n      return NextResponse.json({ received: true });\r\n    }\r\n\r\n    const paymentId = data?.id;\r\n    if (!paymentId) {\r\n      return NextResponse.json({ error: 'Payment ID not found' }, { status: 400 });\r\n    }\r\n\r\n    // Verificar idempotência - se já processamos este evento\r\n    const { data: existingEvent } = await supabase\r\n      .from('payment_events')\r\n      .select('id')\r\n      .eq('event_id', paymentId)\r\n      .eq('provider', 'mercadopago')\r\n      .single();\r\n\r\n    if (existingEvent) {\r\n      console.log('Event already processed:', paymentId);\r\n      return NextResponse.json({ received: true, message: 'Already processed' });\r\n    }\r\n\r\n    // Buscar detalhes do pagamento no Mercado Pago\r\n    // Precisamos do access_token, mas não sabemos qual tenant ainda\r\n    // Vamos buscar pelo external_reference depois de obter o pagamento\r\n\r\n    // Por enquanto, registrar o evento como recebido\r\n    const { data: eventRecord } = await supabase\r\n      .from('payment_events')\r\n      .insert({\r\n        event_id: paymentId,\r\n        provider: 'mercadopago',\r\n        event_type: type,\r\n        raw_payload: body,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    // Processar de forma assíncrona (em produção, usar fila)\r\n    processPaymentWebhook(paymentId, eventRecord?.id).catch(error => {\r\n      console.error('Error processing payment webhook:', error);\r\n    });\r\n\r\n    return NextResponse.json({ received: true });\r\n  } catch (error: any) {\r\n    console.error('Webhook error:', error);\r\n    return NextResponse.json({ error: 'Webhook processing failed' }, { status: 500 });\r\n  }\r\n}\r\n\r\n// GET /api/webhooks/mercadopago - Endpoint de teste\r\nexport async function GET() {\r\n  return NextResponse.json({ \r\n    status: 'Mercado Pago webhook endpoint is active',\r\n    timestamp: new Date().toISOString() \r\n  });\r\n}\r\n\r\n// Função auxiliar para processar o webhook\r\nasync function processPaymentWebhook(paymentId: string, eventId?: string) {\r\n  try {\r\n    // Buscar submission pelo payment_external_id\r\n    const { data: submission, error: submissionError } = await supabase\r\n      .from('submissions')\r\n      .select('*, tenants(*)')\r\n      .eq('payment_external_id', paymentId)\r\n      .single();\r\n\r\n    if (submissionError || !submission) {\r\n      console.error('Submission not found for payment:', paymentId);\r\n      \r\n      // Atualizar evento como falha\r\n      // Sem atualização de status pois a tabela não possui coluna de status\r\n      return;\r\n    }\r\n\r\n    // Token do tenant quando disponível; fallback para variável de ambiente\r\n    const { data: cfg } = await supabase\r\n      .from('mercadopago_configs')\r\n      .select('access_token, is_active')\r\n      .eq('tenant_id', submission.tenant_id)\r\n      .order('updated_at', { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    const accessToken = (cfg && cfg.is_active !== false && cfg.access_token)\r\n      ? cfg.access_token\r\n      : (process.env.MP_ACCESS_TOKEN || '');\r\n\r\n    if (!accessToken || accessToken.trim() === '') {\r\n      console.error('Credenciais do Mercado Pago não configuradas para processamento de webhook');\r\n      if (eventId) {\r\n        await supabase\r\n          .from('payment_events')\r\n          .update({ error_message: 'Credenciais do Mercado Pago não configuradas' })\r\n          .eq('id', eventId);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Buscar detalhes do pagamento na API do Mercado Pago\r\n    const paymentResponse = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {\r\n      headers: {\r\n        'Authorization': `Bearer ${accessToken}`,\r\n      },\r\n    });\r\n\r\n    const payment = await paymentResponse.json();\r\n\r\n    if (!paymentResponse.ok) {\r\n      console.error('Error fetching payment from MP:', payment);\r\n      \r\n      // Sem atualização de status; apenas log em console\r\n      return;\r\n    }\r\n\r\n    // Mapear status do MP para nosso enum\r\n    let paymentStatus = 'PENDENTE';\r\n    if (payment.status === 'approved') {\r\n      paymentStatus = 'PAGO';\r\n    } else if (payment.status === 'rejected' || payment.status === 'cancelled') {\r\n      paymentStatus = 'CANCELADO';\r\n    }\r\n\r\n    // Atualizar submission\r\n    const { error: updateError } = await supabase\r\n      .from('submissions')\r\n      .update({\r\n        payment_status: paymentStatus,\r\n        payment_date: payment.status === 'approved' ? new Date().toISOString() : null,\r\n        payment_amount: payment.transaction_amount,\r\n        metadata: {\r\n          ...submission.metadata,\r\n          mp_payment_id: payment.id,\r\n          mp_status: payment.status,\r\n          mp_status_detail: payment.status_detail,\r\n          mp_payment_method: payment.payment_method_id,\r\n          mp_payment_type: payment.payment_type_id,\r\n        },\r\n      })\r\n      .eq('id', submission.id);\r\n\r\n    if (updateError) {\r\n      console.error('Error updating submission:', updateError);\r\n      return;\r\n    }\r\n\r\n    // Atualizar evento como processado\r\n    if (eventId) {\r\n      await supabase\r\n        .from('payment_events')\r\n        .update({ \r\n          submission_id: submission.id,\r\n          processed_at: new Date().toISOString(),\r\n        })\r\n        .eq('id', eventId);\r\n    }\r\n\r\n    // Se pagamento aprovado, disparar ações automáticas\r\n    if (payment.status === 'approved') {\r\n      // 1. Enviar WhatsApp (se configurado)\r\n      await sendWhatsAppNotification(submission);\r\n\r\n      // 2. Enviar para n8n/Moodle (se configurado)\r\n      await sendToMoodle(submission);\r\n\r\n      // 3. Enviar E-mail (Resend), se configurado\r\n      await sendEmailNotification(submission);\r\n    }\r\n\r\n    console.log('Payment webhook processed successfully:', paymentId);\r\n  } catch (error) {\r\n    console.error('Error in processPaymentWebhook:', error);\r\n    // Sem atualização de status na payment_events (schema atual não possui coluna de status)\r\n  }\r\n}\r\n\r\n// Função auxiliar para enviar WhatsApp\r\nasync function sendWhatsAppNotification(submission: any) {\r\n  try {\r\n    // Buscar configuração WhatsApp GLOBAL\r\n    const { data: whatsappConfig } = await supabase\r\n      .from('whatsapp_global_configs')\r\n      .select('*')\r\n      .eq('is_active', true)\r\n      .order('updated_at', { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    if (!whatsappConfig) {\r\n      console.log('WhatsApp not configured for tenant:', submission.tenant_id);\r\n      return;\r\n    }\r\n\r\n    // Buscar template de confirmação de pagamento\r\n    // Usa a tabela message_templates com chave 'payment_approved' conforme seeds\r\n    const { data: template } = await supabase\r\n      .from('message_templates')\r\n      .select('*')\r\n      .is('tenant_id', null)\r\n      .eq('key', 'payment_approved')\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    if (!template) {\r\n      console.log('No payment confirmation template found');\r\n      return;\r\n    }\r\n\r\n    // Extrair número de telefone\r\n    const phone = submission.data.telefone || submission.data.phone || '';\r\n    if (!phone) {\r\n      console.log('No phone number in submission');\r\n      return;\r\n    }\r\n\r\n    // Preparar variáveis para o template (alinhado aos seeds)\r\n    const variables = {\r\n      nome_completo: submission.data.nome_completo || submission.data.nome || submission.data.name || 'Aluno',\r\n      curso: submission.data.curso || submission.data.course || '',\r\n      polo: submission.tenants?.name || submission.tenant_name || '',\r\n      valor: submission.payment_amount != null ? Number(submission.payment_amount).toFixed(2) : '0.00',\r\n      ...submission.data,\r\n    };\r\n\r\n    // Substituir variáveis no template usando util\r\n    // Evita substituições quebradas e mantém placeholders não encontrados\r\n    // import implícito: util fica no lado do cliente; replicamos logicamente aqui\r\n    const message = template.content.replace(/\\{\\{(\\w+)\\}\\}/g, (match, key) => {\r\n      return variables[key] !== undefined ? String(variables[key]) : match;\r\n    });\r\n\r\n    // Normalizar telefone para Evolution API (E.164 simplificado)\r\n    const cleaned = phone.replace(/\\D/g, '');\r\n    let number = cleaned;\r\n    if (/^\\d{11}$/.test(cleaned)) {\r\n      // Telefone BR sem DDI, prefixar 55\r\n      number = `55${cleaned}`;\r\n    } else if (/^\\d{13}$/.test(cleaned) && cleaned.startsWith('55')) {\r\n      number = cleaned;\r\n    }\r\n\r\n    // Enviar via Evolution API v2 [formato do endpoint confirmado]\r\n    const evoResp = await fetch(`${whatsappConfig.api_base_url}/message/sendText/${whatsappConfig.instance_id}`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'apikey': whatsappConfig.token,\r\n      },\r\n      body: JSON.stringify({\r\n        number,\r\n        text: message,\r\n      }),\r\n    });\r\n\r\n    if (!evoResp.ok) {\r\n      const errText = await evoResp.text().catch(() => '');\r\n      console.error('Evolution API error:', evoResp.status, errText);\r\n      await supabase.from('message_logs').insert({\r\n        tenant_id: submission.tenant_id,\r\n        template_id: template.id,\r\n        submission_id: submission.id,\r\n        recipient_phone: phone,\r\n        message_content: message,\r\n        status: 'FAILED',\r\n        error_message: `Evolution API ${evoResp.status}: ${errText?.slice(0, 300)}`,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Registrar log\r\n    await supabase.from('message_logs').insert({\r\n      tenant_id: submission.tenant_id,\r\n      template_id: template.id,\r\n      submission_id: submission.id,\r\n      recipient_phone: phone,\r\n      message_content: message,\r\n      status: 'SENT',\r\n      sent_at: new Date().toISOString(),\r\n    });\r\n\r\n    console.log('WhatsApp notification sent successfully');\r\n  } catch (error) {\r\n    console.error('Error sending WhatsApp:', error);\r\n    try {\r\n      await supabase.from('message_logs').insert({\r\n        tenant_id: submission.tenant_id,\r\n        submission_id: submission.id,\r\n        recipient_phone: submission.data.telefone || submission.data.phone || '',\r\n        message_content: 'Erro ao enviar mensagem',\r\n        status: 'FAILED',\r\n        error_message: String(error).slice(0, 300),\r\n      });\r\n    } catch (e) {\r\n      // evita crash em erro de log\r\n    }\r\n  }\r\n}\r\n\r\n// Função auxiliar para enviar E-mail via Resend\r\nasync function sendEmailNotification(submission: any) {\r\n  try {\r\n    if (!process.env.RESEND_API_KEY || !process.env.RESEND_FROM) {\r\n      // Não configurado, ignorar silenciosamente\r\n      return;\r\n    }\r\n\r\n    // Extrair e-mail do aluno\r\n    const email = submission.data.email || submission.data.contato_email || submission.data['e-mail'] || submission.data['email_contato'] || '';\r\n    if (!email) {\r\n      console.log('No email in submission');\r\n      return;\r\n    }\r\n\r\n    // Buscar template de confirmação de pagamento para e-mail (se existir)\r\n    const { data: template } = await supabase\r\n      .from('message_templates')\r\n      .select('*')\r\n      .is('tenant_id', null)\r\n      .eq('key', 'payment_approved_email')\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    const variables = {\r\n      nome_completo: submission.data.nome_completo || submission.data.nome || submission.data.name || 'Aluno',\r\n      curso: submission.data.curso || submission.data.course || '',\r\n      polo: submission.tenants?.name || submission.tenant_name || '',\r\n      valor: submission.payment_amount != null ? Number(submission.payment_amount).toFixed(2) : '0.00',\r\n      ...submission.data,\r\n    };\r\n\r\n    const subject = template?.title || 'Confirmação de pagamento';\r\n    const html = (template?.content || `\r\n      <p>Olá, {{nome_completo}}!</p>\r\n      <p>Seu pagamento de {{valor}} para o curso {{curso}} no polo {{polo}} foi aprovado.</p>\r\n      <p>Em breve você receberá orientações de acesso.</p>\r\n    `).replace(/\\{\\{(\\w+)\\}\\}/g, (m, key) => variables[key] !== undefined ? String(variables[key]) : m);\r\n\r\n    const replyTo = process.env.RESEND_REPLY_TO;\r\n    await sendEmail({ to: email, subject, html, replyTo });\r\n\r\n    // Registrar auditoria (não há tabela específica de e-mail logs)\r\n    await supabase.from('audit_logs').insert({\r\n      admin_id: null,\r\n      tenant_id: submission.tenant_id,\r\n      action: 'create',\r\n      resource_type: 'email',\r\n      resource_id: template?.id || null,\r\n      details: { message: 'Email pós-pagamento enviado', to: '***' },\r\n    });\r\n  } catch (error) {\r\n    console.error('Error sending Email:', String(error).slice(0, 300));\r\n  }\r\n}\r\n\r\n// Função auxiliar para enviar para Moodle via n8n\r\nasync function sendToMoodle(submission: any) {\r\n  try {\r\n    // Buscar configuração webhook\r\n    const { data: webhookConfig } = await supabase\r\n      .from('outbound_webhook_global_configs')\r\n      .select('*')\r\n      .eq('is_active', true)\r\n      .order('updated_at', { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    if (!webhookConfig) {\r\n      console.log('Webhook not configured for tenant:', submission.tenant_id);\r\n      return;\r\n    }\r\n\r\n    // Preparar payload\r\n    const payload = {\r\n      submission_id: submission.id,\r\n      tenant_id: submission.tenant_id,\r\n      tenant_name: submission.tenants.name,\r\n      student_data: submission.data,\r\n      payment_amount: submission.payment_amount,\r\n      payment_date: submission.payment_date,\r\n    };\r\n\r\n    // Enviar para n8n\r\n    const response = await fetch(webhookConfig.enrollment_webhook_url, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        ...(webhookConfig.enrollment_webhook_token && {\r\n          'Authorization': `Bearer ${webhookConfig.enrollment_webhook_token}`,\r\n        }),\r\n      },\r\n      body: JSON.stringify(payload),\r\n    });\r\n\r\n    const success = response.ok;\r\n\r\n    // Registrar log no padrão da tabela\r\n    await supabase.from('enrollment_logs').insert({\r\n      tenant_id: submission.tenant_id,\r\n      submission_id: submission.id,\r\n      status: success ? 'DONE' : 'FAILED',\r\n      request_payload: payload,\r\n      response_payload: {\r\n        status: response.status,\r\n        body: await response.text().catch(() => null),\r\n      },\r\n      attempt_count: 1,\r\n      last_attempt_at: new Date().toISOString(),\r\n      completed_at: success ? new Date().toISOString() : null,\r\n    });\r\n\r\n    console.log('Moodle enrollment webhook sent:', success ? 'SUCCESS' : 'FAILED');\r\n  } catch (error) {\r\n    console.error('Error sending to Moodle:', error);\r\n    \r\n    // Registrar erro\r\n    await supabase.from('enrollment_logs').insert({\r\n      tenant_id: submission.tenant_id,\r\n      submission_id: submission.id,\r\n      status: 'FAILED',\r\n      error_message: error instanceof Error ? error.message : 'Unknown error',\r\n      attempt_count: 1,\r\n      last_attempt_at: new Date().toISOString(),\r\n    });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\api\\whatsapp\\send\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[411,414],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[411,414],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":139,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4777,4780],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4777,4780],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { parseTemplateVariables } from '@/lib/utils';\r\n\r\ntype SendWhatsAppBody = {\r\n  tenant_id: string;\r\n  to: string[] | string; // números no formato 11999999999 ou 5511999999999\r\n  template_key?: string;\r\n  message?: string; // conteúdo bruto se não usar template\r\n  variables?: Record<string, any>;\r\n  submission_id?: string; // opcional para log\r\n};\r\n\r\nfunction normalizePhone(input: string): string {\r\n  const cleaned = String(input).replace(/\\D/g, '');\r\n  let number = cleaned;\r\n  if (/^\\d{11}$/.test(cleaned)) {\r\n    number = `55${cleaned}`;\r\n  } else if (/^\\d{13}$/.test(cleaned) && cleaned.startsWith('55')) {\r\n    number = cleaned;\r\n  }\r\n  return number;\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Autenticação\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const body: SendWhatsAppBody = await request.json();\r\n    const { tenant_id, to, template_key, message, variables = {}, submission_id } = body;\r\n\r\n    if (!tenant_id) {\r\n      return NextResponse.json({ error: 'tenant_id é obrigatório' }, { status: 400 });\r\n    }\r\n    const recipients = Array.isArray(to) ? to : [to];\r\n    if (!recipients?.length) {\r\n      return NextResponse.json({ error: 'Destinatários são obrigatórios' }, { status: 400 });\r\n    }\r\n\r\n  // Verificar se usuário é admin do tenant (via RLS e policies)\r\n  const { data: userRow } = await supabase\r\n    .from('users')\r\n    .select('id, role')\r\n    .eq('auth_user_id', user.id)\r\n    .single();\r\n  if (!userRow) {\r\n    return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n  }\r\n\r\n  // Permissão: superadmin tem acesso global; admin precisa ser do tenant\r\n  if (userRow.role !== 'superadmin') {\r\n    const { data: isAdmin } = await supabase.rpc('is_admin_of_tenant', { tenant_uuid: tenant_id });\r\n    if (!isAdmin) {\r\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n    }\r\n  }\r\n\r\n    // Buscar configuração GLOBAL do WhatsApp (unificada)\r\n    const { data: whatsappConfig } = await supabase\r\n      .from('whatsapp_global_configs')\r\n      .select('*')\r\n      .eq('is_active', true)\r\n      .order('updated_at', { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n    if (!whatsappConfig) {\r\n      return NextResponse.json({ error: 'WhatsApp não configurado' }, { status: 400 });\r\n    }\r\n\r\n    // Montar mensagem: template ou texto\r\n    let content = message || '';\r\n    let templateId: string | null = null;\r\n    if (template_key) {\r\n      const { data: template } = await supabase\r\n        .from('message_templates')\r\n        .select('*')\r\n        .is('tenant_id', null)\r\n        .eq('key', template_key)\r\n        .eq('is_active', true)\r\n        .single();\r\n      if (!template) {\r\n        return NextResponse.json({ error: 'Template global não encontrado' }, { status: 404 });\r\n      }\r\n      templateId = template.id;\r\n      content = parseTemplateVariables(template.content, variables);\r\n    }\r\n    if (!content) {\r\n      return NextResponse.json({ error: 'Conteúdo da mensagem é obrigatório' }, { status: 400 });\r\n    }\r\n\r\n    let success = 0;\r\n    let failures = 0;\r\n    for (const raw of recipients) {\r\n      const normalized = normalizePhone(raw);\r\n      // Enviar via Evolution API\r\n      const resp = await fetch(`${whatsappConfig.api_base_url}/message/sendText/${whatsappConfig.instance_id}`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'apikey': whatsappConfig.token,\r\n        },\r\n        body: JSON.stringify({ number: normalized, text: content }),\r\n      });\r\n\r\n      if (!resp.ok) {\r\n        failures++;\r\n        const errText = await resp.text().catch(() => '');\r\n        await supabase.from('message_logs').insert({\r\n          tenant_id,\r\n          template_id: templateId,\r\n          submission_id: submission_id || null,\r\n          recipient_phone: String(raw),\r\n          message_content: content,\r\n          status: 'FAILED',\r\n          error_message: `Evolution API ${resp.status}: ${errText?.slice(0, 300)}`,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      success++;\r\n      await supabase.from('message_logs').insert({\r\n        tenant_id,\r\n        template_id: templateId,\r\n        submission_id: submission_id || null,\r\n        recipient_phone: String(raw),\r\n        message_content: content,\r\n        status: 'SENT',\r\n        sent_at: new Date().toISOString(),\r\n      });\r\n    }\r\n\r\n    return NextResponse.json({ success, failures });\r\n  } catch (error: any) {\r\n    console.error('WhatsApp send error:', error);\r\n    return NextResponse.json({ error: 'Falha ao enviar WhatsApp' }, { status: 500 });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\auth\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2307,2310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2307,2310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2952,2955],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2952,2955],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { supabase } from '@/lib/supabase/client';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport Logo from '@/components/ui/logo';\r\nimport { toast } from 'sonner';\r\nimport { Loader2 } from 'lucide-react';\r\n\r\nexport default function LoginPage() {\r\n  const router = useRouter();\r\n  const [email, setEmail] = useState('');\r\n  const [password, setPassword] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  const wait = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\r\n\r\n  // Busca o usuário via backend (/api/users/me) para contornar RLS e garantir consistência\r\n  const getUserFromBackend = async (accessToken?: string | null) => {\r\n    const res = await fetch('/api/users/me', {\r\n      headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : undefined,\r\n    })\r\n    if (!res.ok) {\r\n      if (res.status === 404) return null\r\n      const payload = await res.json().catch(() => ({}))\r\n      throw new Error(payload?.error || 'Falha ao buscar usuário')\r\n    }\r\n    const payload = await res.json()\r\n    return payload?.user ?? null\r\n  }\r\n\r\n  const handleLogin = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    try {\r\n      const { data, error } = await supabase.auth.signInWithPassword({\r\n        email,\r\n        password,\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      if (data.user) {\r\n        // Garantir o registro do usuário no backend\r\n        const res = await fetch('/api/users/ensure', {\r\n          method: 'POST',\r\n          headers: {\r\n            // Não logar este header.\r\n            Authorization: `Bearer ${data.session?.access_token ?? ''}`,\r\n          },\r\n        })\r\n        if (!res.ok) {\r\n          const payload = await res.json().catch(() => ({}))\r\n          throw new Error(payload?.error || 'Falha ao garantir registro de usuário')\r\n        }\r\n\r\n        // Obter o usuário pelo backend, com pequenos retries para latências\r\n        const delays = [0, 200, 500];\r\n        let userData: any = null;\r\n        for (const d of delays) {\r\n          if (d) await wait(d)\r\n          userData = await getUserFromBackend(data.session?.access_token)\r\n          if (userData) break\r\n        }\r\n\r\n        if (!userData) {\r\n          throw new Error('Registro de usuário não encontrado. Tente novamente.');\r\n        }\r\n\r\n        if (!userData.is_active) {\r\n          toast.error('Sua conta está desativada. Entre em contato com o administrador.');\r\n          await supabase.auth.signOut();\r\n          return;\r\n        }\r\n\r\n        toast.success('Login realizado com sucesso!');\r\n        router.push('/dashboard');\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Login error:', error);\r\n      toast.error(error.message || 'Erro ao fazer login');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-brand-primary via-brand-primary/90 to-brand-primary/80 p-4\">\r\n      <Card className=\"w-full max-w-md\">\r\n        <CardHeader className=\"space-y-1 text-center\">\r\n          <div className=\"flex justify-center mb-4\">\r\n            <Logo size=\"lg\" />\r\n          </div>\r\n          <CardTitle className=\"text-2xl\">Bem-vindo de volta</CardTitle>\r\n          <CardDescription>\r\n            Entre com suas credenciais para acessar o sistema\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <form onSubmit={handleLogin} className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"email\">E-mail</Label>\r\n              <Input\r\n                id=\"email\"\r\n                type=\"email\"\r\n                placeholder=\"seu@email.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n                required\r\n                disabled={loading}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"password\">Senha</Label>\r\n              <Input\r\n                id=\"password\"\r\n                type=\"password\"\r\n                placeholder=\"••••••••\"\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                required\r\n                disabled={loading}\r\n              />\r\n            </div>\r\n            <Button\r\n              type=\"submit\"\r\n              className=\"w-full bg-brand-primary hover:bg-brand-primary/90\"\r\n              disabled={loading}\r\n            >\r\n              {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n              Entrar\r\n            </Button>\r\n          </form>\r\n          <div className=\"mt-4 text-center text-sm text-muted-foreground\">\r\n            <p>Esqueceu sua senha? Entre em contato com o administrador.</p>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\admins\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":378,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":378,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12873,12876],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12873,12876],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Plus, Edit2, Trash2, Loader2, Shield, User } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { formatDate } from '@/lib/utils';\r\n\r\ninterface Tenant {\r\n  id: string;\r\n  name: string;\r\n  slug: string;\r\n}\r\n\r\ninterface Admin {\r\n  id: string;\r\n  name: string;\r\n  email: string;\r\n  phone: string | null;\r\n  role: 'superadmin' | 'admin';\r\n  is_active: boolean;\r\n  created_at: string;\r\n  admin_tenants: Array<{\r\n    tenant_id: string;\r\n    tenants: Tenant;\r\n  }>;\r\n}\r\n\r\nexport default function AdminsPage() {\r\n  const [admins, setAdmins] = useState<Admin[]>([]);\r\n  const [tenants, setTenants] = useState<Tenant[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [dialogOpen, setDialogOpen] = useState(false);\r\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\r\n  const [editingAdmin, setEditingAdmin] = useState<Admin | null>(null);\r\n  const [deletingAdmin, setDeletingAdmin] = useState<Admin | null>(null);\r\n  const [submitting, setSubmitting] = useState(false);\r\n\r\n  // Form state\r\n  const [formData, setFormData] = useState({\r\n    name: '',\r\n    email: '',\r\n    phone: '',\r\n    password: '',\r\n    role: 'admin' as 'admin' | 'superadmin',\r\n    is_active: true,\r\n    tenant_ids: [] as string[],\r\n  });\r\n\r\n  useEffect(() => {\r\n    fetchData();\r\n  }, []);\r\n\r\n  const fetchData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      // Buscar admins e tenants em paralelo\r\n      const [adminsResponse, tenantsResponse] = await Promise.all([\r\n        fetch('/api/admins'),\r\n        fetch('/api/tenants'),\r\n      ]);\r\n\r\n      const adminsData = await adminsResponse.json();\r\n      const tenantsData = await tenantsResponse.json();\r\n\r\n      if (adminsResponse.ok) {\r\n        setAdmins(adminsData.admins || []);\r\n      } else {\r\n        toast.error(adminsData.error || 'Erro ao carregar admins');\r\n      }\r\n\r\n      if (tenantsResponse.ok) {\r\n        setTenants(tenantsData.tenants || []);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching data:', error);\r\n      toast.error('Erro ao carregar dados');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleOpenDialog = (admin?: Admin) => {\r\n    if (admin) {\r\n      setEditingAdmin(admin);\r\n      const linkedTenantIds = admin.admin_tenants?.map(at => at.tenant_id) || [];\r\n      setFormData({\r\n        name: admin.name,\r\n        email: admin.email,\r\n        phone: admin.phone || '',\r\n        password: '', // Não preencher senha ao editar\r\n        role: admin.role,\r\n        is_active: admin.is_active,\r\n        tenant_ids: linkedTenantIds,\r\n      });\r\n    } else {\r\n      setEditingAdmin(null);\r\n      setFormData({\r\n        name: '',\r\n        email: '',\r\n        phone: '',\r\n        password: '',\r\n        role: 'admin',\r\n        is_active: true,\r\n        tenant_ids: [],\r\n      });\r\n    }\r\n    setDialogOpen(true);\r\n  };\r\n\r\n  const handleTenantToggle = (tenantId: string) => {\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      tenant_ids: prev.tenant_ids.includes(tenantId)\r\n        ? prev.tenant_ids.filter(id => id !== tenantId)\r\n        : [...prev.tenant_ids, tenantId],\r\n    }));\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      // Validar senha apenas ao criar novo admin\r\n      if (!editingAdmin && formData.password.length < 6) {\r\n        toast.error('A senha deve ter no mínimo 6 caracteres');\r\n        setSubmitting(false);\r\n        return;\r\n      }\r\n\r\n      const url = editingAdmin ? `/api/admins/${editingAdmin.id}` : '/api/admins';\r\n      const method = editingAdmin ? 'PATCH' : 'POST';\r\n\r\n      const payload = editingAdmin\r\n        ? {\r\n            name: formData.name,\r\n            phone: formData.phone || null,\r\n            role: formData.role,\r\n            is_active: formData.is_active,\r\n            tenant_ids: formData.tenant_ids,\r\n          }\r\n        : formData;\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (response.ok) {\r\n        toast.success(editingAdmin ? 'Admin atualizado com sucesso!' : 'Admin criado com sucesso!');\r\n        setDialogOpen(false);\r\n        fetchData();\r\n      } else {\r\n        toast.error(data.error || 'Erro ao salvar admin');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error saving admin:', error);\r\n      toast.error('Erro ao salvar admin');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async () => {\r\n    if (!deletingAdmin) return;\r\n\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/admins/${deletingAdmin.id}`, {\r\n        method: 'DELETE',\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast.success('Admin deletado com sucesso!');\r\n        setDeleteDialogOpen(false);\r\n        setDeletingAdmin(null);\r\n        fetchData();\r\n      } else {\r\n        const data = await response.json();\r\n        toast.error(data.error || 'Erro ao deletar admin');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error deleting admin:', error);\r\n      toast.error('Erro ao deletar admin');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-brand-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">Administradores</h1>\r\n          <p className=\"text-muted-foreground\">Gerencie os usuários administradores do sistema</p>\r\n        </div>\r\n        <Button onClick={() => handleOpenDialog()} className=\"bg-brand-primary hover:bg-brand-primary/90\">\r\n          <Plus className=\"mr-2 h-4 w-4\" />\r\n          Novo Admin\r\n        </Button>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Lista de Administradores</CardTitle>\r\n          <CardDescription>\r\n            {admins.length} {admins.length === 1 ? 'administrador cadastrado' : 'administradores cadastrados'}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {admins.length === 0 ? (\r\n            <div className=\"text-center py-12\">\r\n              <p className=\"text-muted-foreground\">Nenhum administrador cadastrado ainda.</p>\r\n            </div>\r\n          ) : (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Nome</TableHead>\r\n                  <TableHead>Email</TableHead>\r\n                  <TableHead>Role</TableHead>\r\n                  <TableHead>Polos Vinculados</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead>Criado em</TableHead>\r\n                  <TableHead className=\"text-right\">Ações</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {admins.map((admin) => (\r\n                  <TableRow key={admin.id}>\r\n                    <TableCell className=\"font-medium\">{admin.name}</TableCell>\r\n                    <TableCell>{admin.email}</TableCell>\r\n                    <TableCell>\r\n                      <Badge variant={admin.role === 'superadmin' ? 'default' : 'secondary'}>\r\n                        {admin.role === 'superadmin' ? (\r\n                          <><Shield className=\"w-3 h-3 mr-1\" /> Superadmin</>\r\n                        ) : (\r\n                          <><User className=\"w-3 h-3 mr-1\" /> Admin</>\r\n                        )}\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      {admin.admin_tenants && admin.admin_tenants.length > 0 ? (\r\n                        <div className=\"flex flex-wrap gap-1\">\r\n                          {admin.admin_tenants.map((at) => (\r\n                            <Badge key={at.tenant_id} variant=\"outline\" className=\"text-xs\">\r\n                              {at.tenants.name}\r\n                            </Badge>\r\n                          ))}\r\n                        </div>\r\n                      ) : (\r\n                        <span className=\"text-muted-foreground text-sm\">Nenhum</span>\r\n                      )}\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge variant={admin.is_active ? 'success' : 'destructive'}>\r\n                        {admin.is_active ? 'Ativo' : 'Inativo'}\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell>{formatDate(admin.created_at)}</TableCell>\r\n                    <TableCell className=\"text-right space-x-2\">\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => handleOpenDialog(admin)}\r\n                      >\r\n                        <Edit2 className=\"h-4 w-4\" />\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => {\r\n                          setDeletingAdmin(admin);\r\n                          setDeleteDialogOpen(true);\r\n                        }}\r\n                      >\r\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\r\n                      </Button>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Dialog Criar/Editar */}\r\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\r\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n          <DialogHeader>\r\n            <DialogTitle>{editingAdmin ? 'Editar Admin' : 'Novo Admin'}</DialogTitle>\r\n            <DialogDescription>\r\n              {editingAdmin\r\n                ? 'Atualize as informações do administrador.'\r\n                : 'Preencha as informações do novo administrador.'}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <form onSubmit={handleSubmit}>\r\n            <div className=\"space-y-4 py-4\">\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"name\">Nome Completo *</Label>\r\n                  <Input\r\n                    id=\"name\"\r\n                    value={formData.name}\r\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                    placeholder=\"Ex: João Silva\"\r\n                    required\r\n                    disabled={submitting}\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"email\">E-mail *</Label>\r\n                  <Input\r\n                    id=\"email\"\r\n                    type=\"email\"\r\n                    value={formData.email}\r\n                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}\r\n                    placeholder=\"joao@email.com\"\r\n                    required\r\n                    disabled={submitting || !!editingAdmin}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"phone\">Telefone</Label>\r\n                  <Input\r\n                    id=\"phone\"\r\n                    value={formData.phone}\r\n                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\r\n                    placeholder=\"(11) 99999-9999\"\r\n                    disabled={submitting}\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"role\">Função *</Label>\r\n                  <Select\r\n                    id=\"role\"\r\n                    value={formData.role}\r\n                    onChange={(e) => setFormData({ ...formData, role: e.target.value as any })}\r\n                    disabled={submitting}\r\n                  >\r\n                    <option value=\"admin\">Admin</option>\r\n                    <option value=\"superadmin\">Superadmin</option>\r\n                  </Select>\r\n                </div>\r\n              </div>\r\n\r\n              {!editingAdmin && (\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"password\">Senha *</Label>\r\n                  <Input\r\n                    id=\"password\"\r\n                    type=\"password\"\r\n                    value={formData.password}\r\n                    onChange={(e) => setFormData({ ...formData, password: e.target.value })}\r\n                    placeholder=\"Mínimo 6 caracteres\"\r\n                    required={!editingAdmin}\r\n                    disabled={submitting}\r\n                  />\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label>Vincular a Polos</Label>\r\n                <div className=\"border rounded-md p-4 space-y-2 max-h-48 overflow-y-auto\">\r\n                  {tenants.length === 0 ? (\r\n                    <p className=\"text-sm text-muted-foreground\">Nenhum polo disponível</p>\r\n                  ) : (\r\n                    tenants.map((tenant) => (\r\n                      <div key={tenant.id} className=\"flex items-center space-x-2\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          id={`tenant-${tenant.id}`}\r\n                          checked={formData.tenant_ids.includes(tenant.id)}\r\n                          onChange={() => handleTenantToggle(tenant.id)}\r\n                          disabled={submitting}\r\n                          className=\"rounded border-gray-300\"\r\n                        />\r\n                        <Label htmlFor={`tenant-${tenant.id}`} className=\"cursor-pointer flex-1\">\r\n                          {tenant.name}\r\n                        </Label>\r\n                      </div>\r\n                    ))\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center space-x-2\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  id=\"is_active\"\r\n                  checked={formData.is_active}\r\n                  onChange={(e) => setFormData({ ...formData, is_active: e.target.checked })}\r\n                  disabled={submitting}\r\n                  className=\"rounded border-gray-300\"\r\n                />\r\n                <Label htmlFor=\"is_active\" className=\"cursor-pointer\">Usuário ativo</Label>\r\n              </div>\r\n            </div>\r\n            <DialogFooter>\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                onClick={() => setDialogOpen(false)}\r\n                disabled={submitting}\r\n              >\r\n                Cancelar\r\n              </Button>\r\n              <Button\r\n                type=\"submit\"\r\n                className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n                disabled={submitting}\r\n              >\r\n                {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                {editingAdmin ? 'Atualizar' : 'Criar'}\r\n              </Button>\r\n            </DialogFooter>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Dialog Deletar */}\r\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Confirmar exclusão</DialogTitle>\r\n            <DialogDescription>\r\n              Tem certeza que deseja deletar o admin <strong>{deletingAdmin?.name}</strong>?\r\n              <br />\r\n              <span className=\"text-destructive\">Esta ação não pode ser desfeita!</span>\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <DialogFooter>\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              onClick={() => setDeleteDialogOpen(false)}\r\n              disabled={submitting}\r\n            >\r\n              Cancelar\r\n            </Button>\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"destructive\"\r\n              onClick={handleDelete}\r\n              disabled={submitting}\r\n            >\r\n              {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n              Deletar\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\forms\\[id]\\edit\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Eye' is defined but never used.","line":17,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":6},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3076,3079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3076,3079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3357,3360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3357,3360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":107,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3734,3737],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3734,3737],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":537,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":537,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20024,20027],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20024,20027],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":557,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":557,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21093,21096],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21093,21096],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchForm'. Either include it or remove the dependency array.","line":58,"column":6,"nodeType":"ArrayExpression","endLine":58,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [fetchForm, formId]","fix":{"range":[1856,1864],"text":"[fetchForm, formId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { useRouter, useParams } from 'next/navigation';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { \r\n  Plus, \r\n  Trash2, \r\n  GripVertical, \r\n  Loader2, \r\n  Save, \r\n  ArrowLeft,\r\n  Eye\r\n} from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { \r\n  FIELD_TYPES, \r\n  FormField, \r\n  generateFieldName, \r\n  fieldRequiresOptions,\r\n  getDefaultPlaceholder \r\n} from '@/lib/form-field-types';\r\n\r\ninterface Tenant {\r\n  id: string;\r\n  name: string;\r\n  slug: string;\r\n}\r\n\r\nexport default function EditFormPage() {\r\n  const params = useParams();\r\n  const formId = params.id as string;\r\n  const router = useRouter();\r\n  const [loading, setLoading] = useState(true);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [tenants, setTenants] = useState<Tenant[]>([]);\r\n\r\n  // Form data\r\n  const [formTitle, setFormTitle] = useState('');\r\n  const [formDescription, setFormDescription] = useState('');\r\n  const [selectedTenant, setSelectedTenant] = useState('');\r\n  const [isActive, setIsActive] = useState(true);\r\n  const [requiresPayment, setRequiresPayment] = useState(false);\r\n  const [paymentAmount, setPaymentAmount] = useState('');\r\n  const [fields, setFields] = useState<FormField[]>([]);\r\n\r\n  // Field being edited\r\n  const [editingFieldIndex, setEditingFieldIndex] = useState<number | null>(null);\r\n  const [fieldEditorData, setFieldEditorData] = useState<Partial<FormField>>({});\r\n\r\n  useEffect(() => {\r\n    Promise.all([fetchTenants(), fetchForm()]);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [formId]);\r\n\r\n  const fetchTenants = async () => {\r\n    try {\r\n      const response = await fetch('/api/tenants');\r\n      const data = await response.json();\r\n      if (response.ok) {\r\n        setTenants(data.tenants || []);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching tenants:', error);\r\n      toast.error('Erro ao carregar polos');\r\n    }\r\n  };\r\n\r\n  const fetchForm = async () => {\r\n    try {\r\n      const response = await fetch(`/api/forms/${formId}`);\r\n      const data = await response.json();\r\n      \r\n      if (response.ok && data.form) {\r\n        const form = data.form;\r\n        setFormTitle(form.name);\r\n        setFormDescription(form.description || '');\r\n        setSelectedTenant(form.tenant_id || '');\r\n        setIsActive(form.is_active);\r\n        // Ler configurações de pagamento do objeto settings\r\n        const requirePayment = form.settings?.require_payment ?? false;\r\n        const paymentAmt = form.settings?.payment_amount ?? null;\r\n        setRequiresPayment(Boolean(requirePayment));\r\n        setPaymentAmount(paymentAmt != null ? String(paymentAmt) : '');\r\n        // Carregar campos corretos (form_fields) normalizando opções\r\n        const normalizeOptions = (opts: any, type: string) => {\r\n          if (!opts) return [];\r\n          if (!Array.isArray(opts)) return [];\r\n          // Garantir que sempre seja [{label, value}] para tipos com opções\r\n          if (['select', 'radio', 'checkbox'].includes(type)) {\r\n            return opts.map((o: any) => {\r\n              if (typeof o === 'string') {\r\n                // Gera value a partir do label\r\n                return { label: o, value: generateFieldName(o) };\r\n              }\r\n              // Já é objeto\r\n              return o;\r\n            });\r\n          }\r\n          return opts;\r\n        };\r\n\r\n        const normalizedFields = (form.form_fields || []).map((f: any) => ({\r\n          ...f,\r\n          options: normalizeOptions(f.options, f.type),\r\n        }));\r\n        setFields(normalizedFields);\r\n      } else {\r\n        toast.error('Formulário não encontrado');\r\n        router.push('/dashboard/forms');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching form:', error);\r\n      toast.error('Erro ao carregar formulário');\r\n      router.push('/dashboard/forms');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const addField = (type: string) => {\r\n    const newField: FormField = {\r\n      id: `field_${Date.now()}`,\r\n      type,\r\n      label: '',\r\n      name: '',\r\n      placeholder: getDefaultPlaceholder(type),\r\n      required: false,\r\n      options: fieldRequiresOptions(type) ? [] : undefined,\r\n      order_index: fields.length,\r\n      is_active: true,\r\n    };\r\n    setFields([...fields, newField]);\r\n    setEditingFieldIndex(fields.length);\r\n    setFieldEditorData(newField);\r\n  };\r\n\r\n  const openFieldEditor = (index: number) => {\r\n    setEditingFieldIndex(index);\r\n    setFieldEditorData({ ...fields[index] });\r\n  };\r\n\r\n  const saveFieldEdit = () => {\r\n    if (editingFieldIndex === null) return;\r\n\r\n    const updatedFields = [...fields];\r\n    updatedFields[editingFieldIndex] = fieldEditorData as FormField;\r\n    \r\n    // Auto-generate name if not set\r\n    if (!updatedFields[editingFieldIndex].name && updatedFields[editingFieldIndex].label) {\r\n      updatedFields[editingFieldIndex].name = generateFieldName(updatedFields[editingFieldIndex].label);\r\n    }\r\n    \r\n    setFields(updatedFields);\r\n    setEditingFieldIndex(null);\r\n    setFieldEditorData({});\r\n  };\r\n\r\n  const cancelFieldEdit = () => {\r\n    // If it's a new field that was never saved, remove it\r\n    if (editingFieldIndex !== null && !fields[editingFieldIndex].label) {\r\n      const updatedFields = fields.filter((_, i) => i !== editingFieldIndex);\r\n      setFields(updatedFields);\r\n    }\r\n    setEditingFieldIndex(null);\r\n    setFieldEditorData({});\r\n  };\r\n\r\n  const deleteField = (index: number) => {\r\n    if (confirm('Tem certeza que deseja excluir este campo?')) {\r\n      const updatedFields = fields.filter((_, i) => i !== index);\r\n      // Reindexar order_index após remover\r\n      updatedFields.forEach((f, i) => { f.order_index = i; });\r\n      setFields(updatedFields);\r\n      if (editingFieldIndex === index) {\r\n        setEditingFieldIndex(null);\r\n        setFieldEditorData({});\r\n      }\r\n    }\r\n  };\r\n\r\n  const moveField = (index: number, direction: 'up' | 'down') => {\r\n    const newIndex = direction === 'up' ? index - 1 : index + 1;\r\n    if (newIndex < 0 || newIndex >= fields.length) return;\r\n\r\n    const updatedFields = [...fields];\r\n    [updatedFields[index], updatedFields[newIndex]] = [updatedFields[newIndex], updatedFields[index]];\r\n    // Atualizar order_index conforme nova ordem\r\n    updatedFields.forEach((f, i) => { f.order_index = i; });\r\n    setFields(updatedFields);\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (!formTitle.trim()) {\r\n      toast.error('O título do formulário é obrigatório');\r\n      return;\r\n    }\r\n\r\n    // Polo opcional: permitir formulário global (sem tenant)\r\n\r\n    if (fields.length === 0) {\r\n      toast.error('Adicione pelo menos um campo ao formulário');\r\n      return;\r\n    }\r\n\r\n    // Validate fields\r\n    for (let i = 0; i < fields.length; i++) {\r\n      const field = fields[i];\r\n      if (!field.label) {\r\n        toast.error(`Campo ${i + 1}: O rótulo é obrigatório`);\r\n        return;\r\n      }\r\n      if (!field.name) {\r\n        toast.error(`Campo ${i + 1}: O nome é obrigatório`);\r\n        return;\r\n      }\r\n      if (fieldRequiresOptions(field.type) && (!field.options || field.options.length === 0)) {\r\n        toast.error(`Campo ${i + 1}: Adicione pelo menos uma opção`);\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (requiresPayment && (!paymentAmount || parseFloat(paymentAmount) <= 0)) {\r\n      toast.error('Informe o valor do pagamento');\r\n      return;\r\n    }\r\n\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/forms/${formId}`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          name: formTitle,\r\n          description: formDescription,\r\n          // tenant_id opcional: somente enviar se houver seleção\r\n          ...(selectedTenant ? { tenant_id: selectedTenant } : {}),\r\n          is_active: isActive,\r\n          // Enviar configurações dentro de settings\r\n          settings: {\r\n            ...(requiresPayment ? { require_payment: true } : { require_payment: false }),\r\n            payment_amount: requiresPayment ? parseFloat(paymentAmount) : null,\r\n          },\r\n          fields,\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast.success('Formulário atualizado com sucesso!');\r\n        router.push('/dashboard/forms');\r\n      } else {\r\n        const data = await response.json();\r\n        toast.error(data.error || 'Erro ao atualizar formulário');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating form:', error);\r\n      toast.error('Erro ao atualizar formulário');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-brand-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-8 max-w-7xl mx-auto space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"icon\"\r\n            onClick={() => router.push('/dashboard/forms')}\r\n          >\r\n            <ArrowLeft className=\"h-5 w-5\" />\r\n          </Button>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold\">Editar Formulário</h1>\r\n            <p className=\"text-muted-foreground\">Modifique campos e configurações</p>\r\n          </div>\r\n        </div>\r\n        <div className=\"hidden sm:flex items-center gap-2\">\r\n          <Button\r\n            type=\"button\"\r\n            className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n            disabled={submitting}\r\n            onClick={() => {\r\n              const formEl = document.getElementById('editForm') as HTMLFormElement | null;\r\n              formEl?.requestSubmit();\r\n            }}\r\n          >\r\n            {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n            <Save className=\"mr-2 h-4 w-4\" />\r\n            Salvar Alterações\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      <form id=\"editForm\" onSubmit={handleSubmit} className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* Form Builder - Left Column */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          {/* Basic Info */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Informações Básicas</CardTitle>\r\n              <CardDescription>Configure título e descrição do formulário</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"tenant\">Polo</Label>\r\n                <select\r\n                  id=\"tenant\"\r\n                  value={selectedTenant}\r\n                  onChange={(e) => setSelectedTenant(e.target.value)}\r\n                  className=\"w-full px-3 py-2 text-sm border rounded-md\"\r\n                >\r\n                  <option value=\"\">— sem polo (global) —</option>\r\n                  {tenants.map((tenant) => (\r\n                    <option key={tenant.id} value={tenant.id}>\r\n                      {tenant.name}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n                <p className=\"text-xs text-muted-foreground\">Deixe vazio para manter como formulário global.</p>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"title\">Título do Formulário *</Label>\r\n                <Input\r\n                  id=\"title\"\r\n                  value={formTitle}\r\n                  onChange={(e) => setFormTitle(e.target.value)}\r\n                  placeholder=\"Ex: Inscrição 2025.1\"\r\n                  required\r\n                />\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"description\">Descrição</Label>\r\n                <textarea\r\n                  id=\"description\"\r\n                  value={formDescription}\r\n                  onChange={(e) => setFormDescription(e.target.value)}\r\n                  placeholder=\"Descrição opcional do formulário\"\r\n                  rows={3}\r\n                  className=\"w-full px-3 py-2 text-sm border rounded-md\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"is_active\"\r\n                    checked={isActive}\r\n                    onChange={(e) => setIsActive(e.target.checked)}\r\n                  />\r\n                  <Label htmlFor=\"is_active\">Formulário ativo</Label>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"requires_payment\"\r\n                    checked={requiresPayment}\r\n                    onChange={(e) => setRequiresPayment(e.target.checked)}\r\n                  />\r\n                  <Label htmlFor=\"requires_payment\">Requer pagamento</Label>\r\n                </div>\r\n\r\n                {requiresPayment && (\r\n                  <div className=\"space-y-2 pl-6\">\r\n                    <Label htmlFor=\"payment_amount\">Valor (R$) *</Label>\r\n                    <Input\r\n                      id=\"payment_amount\"\r\n                      type=\"number\"\r\n                      step=\"0.01\"\r\n                      min=\"0\"\r\n                      value={paymentAmount}\r\n                      onChange={(e) => setPaymentAmount(e.target.value)}\r\n                      placeholder=\"150.00\"\r\n                      required={requiresPayment}\r\n                    />\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Fields List */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Campos do Formulário</CardTitle>\r\n              <CardDescription>\r\n                {fields.length} campo(s) adicionado(s)\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-2\">\r\n              {fields.length === 0 ? (\r\n                <div className=\"text-center py-8 text-muted-foreground\">\r\n                  Nenhum campo adicionado. Clique em um tipo de campo à direita.\r\n                </div>\r\n              ) : (\r\n                fields.map((field, index) => (\r\n                  <div\r\n                    key={field.id}\r\n                    className={`p-4 border rounded-lg cursor-pointer transition-colors ${\r\n                      editingFieldIndex === index\r\n                        ? 'border-brand-primary bg-brand-primary/5'\r\n                        : 'hover:bg-muted'\r\n                    }`}\r\n                    onClick={() => openFieldEditor(index)}\r\n                  >\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <GripVertical className=\"h-5 w-5 text-muted-foreground\" />\r\n                        <div>\r\n                          <div className=\"font-medium\">\r\n                            {field.label || '(Sem rótulo)'}\r\n                            {field.required && <span className=\"text-red-500 ml-1\">*</span>}\r\n                          </div>\r\n                          <div className=\"text-xs text-muted-foreground\">\r\n                            {FIELD_TYPES.find((t) => t.value === field.type)?.label} • {field.name || '(Sem nome)'}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Button\r\n                          type=\"button\"\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            moveField(index, 'up');\r\n                          }}\r\n                          disabled={index === 0}\r\n                        >\r\n                          ↑\r\n                        </Button>\r\n                        <Button\r\n                          type=\"button\"\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            moveField(index, 'down');\r\n                          }}\r\n                          disabled={index === fields.length - 1}\r\n                        >\r\n                          ↓\r\n                        </Button>\r\n                        <Button\r\n                          type=\"button\"\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            deleteField(index);\r\n                          }}\r\n                        >\r\n                          <Trash2 className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Field Editor */}\r\n          {editingFieldIndex !== null && (\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Editar Campo</CardTitle>\r\n                <CardDescription>\r\n                  Configure as propriedades do campo\r\n                </CardDescription>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>Tipo de Campo</Label>\r\n                  <Badge variant=\"secondary\">\r\n                    {FIELD_TYPES.find((t) => t.value === fieldEditorData.type)?.label}\r\n                  </Badge>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"field_label\">Rótulo *</Label>\r\n                  <Input\r\n                    id=\"field_label\"\r\n                    value={fieldEditorData.label || ''}\r\n                    onChange={(e) => setFieldEditorData({ ...fieldEditorData, label: e.target.value })}\r\n                    placeholder=\"Ex: Nome Completo\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"field_name\">Nome (ID) *</Label>\r\n                  <Input\r\n                    id=\"field_name\"\r\n                    value={fieldEditorData.name || ''}\r\n                    onChange={(e) => setFieldEditorData({ ...fieldEditorData, name: e.target.value })}\r\n                    placeholder=\"Ex: nome_completo\"\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    Usado para identificar o campo nos dados\r\n                  </p>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"field_placeholder\">Placeholder</Label>\r\n                  <Input\r\n                    id=\"field_placeholder\"\r\n                    value={fieldEditorData.placeholder || ''}\r\n                    onChange={(e) => setFieldEditorData({ ...fieldEditorData, placeholder: e.target.value })}\r\n                    placeholder=\"Texto de ajuda\"\r\n                  />\r\n                </div>\r\n\r\n                {fieldRequiresOptions(fieldEditorData.type!) && (\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Opções</Label>\r\n                    <div className=\"space-y-2\">\r\n                      {(fieldEditorData.options || []).map((option: any, i) => (\r\n                        <div key={i} className=\"flex gap-2\">\r\n                          <Input\r\n                            value={option?.label || ''}\r\n                            onChange={(e) => {\r\n                              const label = e.target.value;\r\n                              const newOptions = [...(fieldEditorData.options || [])];\r\n                              newOptions[i] = {\r\n                                label,\r\n                                value: generateFieldName(label),\r\n                              };\r\n                              setFieldEditorData({ ...fieldEditorData, options: newOptions });\r\n                            }}\r\n                            placeholder=\"Label da opção\"\r\n                          />\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            onClick={() => {\r\n                              const newOptions = (fieldEditorData.options || []).filter((_: any, idx: number) => idx !== i);\r\n                              setFieldEditorData({ ...fieldEditorData, options: newOptions });\r\n                            }}\r\n                          >\r\n                            <Trash2 className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </div>\r\n                      ))}\r\n                      <Button\r\n                        type=\"button\"\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => {\r\n                          setFieldEditorData({\r\n                            ...fieldEditorData,\r\n                            options: [...(fieldEditorData.options || []), { label: '', value: '' }],\r\n                          });\r\n                        }}\r\n                      >\r\n                        <Plus className=\"h-4 w-4 mr-2\" />\r\n                        Adicionar Opção\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                <div className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"field_required\"\r\n                    checked={fieldEditorData.required || false}\r\n                    onChange={(e) => setFieldEditorData({ ...fieldEditorData, required: e.target.checked })}\r\n                  />\r\n                  <Label htmlFor=\"field_required\">Campo obrigatório</Label>\r\n                </div>\r\n\r\n                <div className=\"flex gap-2\">\r\n                  <Button type=\"button\" onClick={saveFieldEdit} size=\"sm\">\r\n                    <Save className=\"h-4 w-4 mr-2\" />\r\n                    Salvar Campo\r\n                  </Button>\r\n                  <Button type=\"button\" variant=\"outline\" onClick={cancelFieldEdit} size=\"sm\">\r\n                    Cancelar\r\n                  </Button>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n        </div>\r\n\r\n        {/* Field Types - Right Column */}\r\n        <div className=\"space-y-6\">\r\n          <Card className=\"sticky top-20\">\r\n            <CardHeader>\r\n              <CardTitle>Tipos de Campo</CardTitle>\r\n              <CardDescription>Clique para adicionar ao formulário</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-2\">\r\n              {FIELD_TYPES.map((fieldType) => (\r\n                <Button\r\n                  key={fieldType.value}\r\n                  type=\"button\"\r\n                  variant=\"outline\"\r\n                  className=\"w-full justify-start\"\r\n                  onClick={() => addField(fieldType.value)}\r\n                >\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  {fieldType.label}\r\n                </Button>\r\n              ))}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardContent className=\"pt-6 space-y-4\">\r\n              <Button\r\n                type=\"submit\"\r\n                className=\"w-full bg-brand-primary hover:bg-brand-primary/90\"\r\n                disabled={submitting}\r\n              >\r\n                {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                <Save className=\"mr-2 h-4 w-4\" />\r\n                Salvar Alterações\r\n              </Button>\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                className=\"w-full\"\r\n                onClick={() => router.push('/dashboard/forms')}\r\n              >\r\n                Cancelar\r\n              </Button>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\forms\\new\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Eye' is defined but never used.","line":18,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoading' is assigned a value but never used.","line":38,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setIsActive' is assigned a value but never used.","line":46,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2685,2688],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2685,2688],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2764,2767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2764,2767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":94,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2815,2818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2815,2818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'id' is defined but never used.","line":201,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":201,"endColumn":33},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":480,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":480,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16586,16589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16586,16589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { \r\n  Plus, \r\n  Trash2, \r\n  GripVertical, \r\n  Loader2, \r\n  Save, \r\n  ArrowLeft,\r\n  Eye,\r\n  Settings as SettingsIcon\r\n} from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { \r\n  FIELD_TYPES, \r\n  FormField, \r\n  generateFieldName, \r\n  fieldRequiresOptions,\r\n  getDefaultPlaceholder \r\n} from '@/lib/form-field-types';\r\n\r\ninterface Tenant {\r\n  id: string;\r\n  name: string;\r\n  slug: string;\r\n}\r\n\r\nexport default function NewFormPage() {\r\n  const router = useRouter();\r\n  const [loading, setLoading] = useState(false);\r\n  const [submitting, setSubmitting] = useState(false);\r\n\r\n  // Form data\r\n  const [formTitle, setFormTitle] = useState('');\r\n  const [formDescription, setFormDescription] = useState('');\r\n  // Polo opcional: criação de formulário global por padrão\r\n  // Status do formulário será sempre ativo por padrão na criação\r\n  const [isActive, setIsActive] = useState(true);\r\n  const [fields, setFields] = useState<FormField[]>([]);\r\n\r\n  // Tenants\r\n  const [tenants, setTenants] = useState<Tenant[]>([]);\r\n  const [selectedTenant, setSelectedTenant] = useState('');\r\n  const [tenantsLoading, setTenantsLoading] = useState(false);\r\n\r\n  // Field being edited\r\n  const [editingFieldIndex, setEditingFieldIndex] = useState<number | null>(null);\r\n  const [currentField, setCurrentField] = useState<Partial<FormField>>({\r\n    label: '',\r\n    name: '',\r\n    type: 'text',\r\n    required: false,\r\n    placeholder: '',\r\n    options: [],\r\n    validation_rules: {},\r\n    order_index: 0,\r\n    is_active: true,\r\n  });\r\n\r\n  useEffect(() => {\r\n    const loadTenants = async () => {\r\n      setTenantsLoading(true);\r\n      try {\r\n        const response = await fetch('/api/tenants');\r\n        const data = await response.json();\r\n        if (response.ok) {\r\n          setTenants(data.tenants || []);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error fetching tenants:', error);\r\n        toast.error('Erro ao carregar polos');\r\n      } finally {\r\n        setTenantsLoading(false);\r\n      }\r\n    };\r\n    loadTenants();\r\n  }, []);\r\n\r\n  const addField = (type: string) => {\r\n    const newField: FormField = {\r\n      label: `Campo ${fields.length + 1}`,\r\n      name: `field_${fields.length + 1}`,\r\n      type: type as any,\r\n      required: false,\r\n      placeholder: getDefaultPlaceholder(type as any),\r\n      options: fieldRequiresOptions(type as any) ? [{ label: 'Opção 1', value: 'option_1' }] : [],\r\n      validation_rules: {},\r\n      order_index: fields.length,\r\n      is_active: true,\r\n    };\r\n\r\n    setFields([...fields, newField]);\r\n  };\r\n\r\n  const removeField = (index: number) => {\r\n    const updatedFields = fields.filter((_, i) => i !== index);\r\n    // Reordenar\r\n    updatedFields.forEach((field, i) => {\r\n      field.order_index = i;\r\n    });\r\n    setFields(updatedFields);\r\n  };\r\n\r\n  const moveField = (index: number, direction: 'up' | 'down') => {\r\n    if (\r\n      (direction === 'up' && index === 0) ||\r\n      (direction === 'down' && index === fields.length - 1)\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const newIndex = direction === 'up' ? index - 1 : index + 1;\r\n    const updatedFields = [...fields];\r\n    const [movedField] = updatedFields.splice(index, 1);\r\n    updatedFields.splice(newIndex, 0, movedField);\r\n\r\n    // Atualizar order_index\r\n    updatedFields.forEach((field, i) => {\r\n      field.order_index = i;\r\n    });\r\n\r\n    setFields(updatedFields);\r\n  };\r\n\r\n  const editField = (index: number) => {\r\n    setEditingFieldIndex(index);\r\n    setCurrentField({ ...fields[index] });\r\n  };\r\n\r\n  const saveFieldEdit = () => {\r\n    if (editingFieldIndex === null) return;\r\n\r\n    if (!currentField.label || !currentField.name) {\r\n      toast.error('Label e Name são obrigatórios');\r\n      return;\r\n    }\r\n\r\n    const updatedFields = [...fields];\r\n    updatedFields[editingFieldIndex] = currentField as FormField;\r\n    setFields(updatedFields);\r\n    setEditingFieldIndex(null);\r\n    setCurrentField({\r\n      label: '',\r\n      name: '',\r\n      type: 'text',\r\n      required: false,\r\n      placeholder: '',\r\n      options: [],\r\n      validation_rules: {},\r\n      order_index: 0,\r\n      is_active: true,\r\n    });\r\n    toast.success('Campo atualizado!');\r\n  };\r\n\r\n  const cancelEdit = () => {\r\n    setEditingFieldIndex(null);\r\n    setCurrentField({\r\n      label: '',\r\n      name: '',\r\n      type: 'text',\r\n      required: false,\r\n      placeholder: '',\r\n      options: [],\r\n      validation_rules: {},\r\n      order_index: 0,\r\n      is_active: true,\r\n    });\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (!formTitle) {\r\n      toast.error('Título é obrigatório');\r\n      return;\r\n    }\r\n\r\n    if (fields.length === 0) {\r\n      toast.error('Adicione pelo menos um campo ao formulário');\r\n      return;\r\n    }\r\n\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const payload = {\r\n        name: formTitle,\r\n        description: formDescription || null,\r\n        is_active: isActive,\r\n        settings: {},\r\n        ...(selectedTenant ? { tenant_id: selectedTenant } : {}),\r\n        fields: fields.map(({ id, ...field }) => field), // Remove id para criar novos\r\n      };\r\n\r\n      const response = await fetch('/api/forms', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (response.ok) {\r\n        toast.success('Formulário criado com sucesso!');\r\n        router.push('/dashboard/forms');\r\n      } else {\r\n        toast.error(data.error || 'Erro ao criar formulário');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error creating form:', error);\r\n      toast.error('Erro ao criar formulário');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-brand-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6 max-w-7xl mx-auto\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"icon\"\r\n            onClick={() => router.back()}\r\n          >\r\n            <ArrowLeft className=\"h-4 w-4\" />\r\n          </Button>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold\">Novo Formulário</h1>\r\n            <p className=\"text-muted-foreground\">Crie um formulário personalizado</p>\r\n          </div>\r\n        </div>\r\n        <Button\r\n          onClick={handleSubmit}\r\n          disabled={submitting}\r\n          className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n        >\r\n          {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n          <Save className=\"mr-2 h-4 w-4\" />\r\n          Salvar Formulário\r\n        </Button>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* Configurações do Formulário */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Informações Básicas</CardTitle>\r\n              <CardDescription>Configure os dados principais do formulário</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"title\">Título do Formulário *</Label>\r\n                <Input\r\n                  id=\"title\"\r\n                  value={formTitle}\r\n                  onChange={(e) => setFormTitle(e.target.value)}\r\n                  placeholder=\"Ex: Inscrição Vestibular 2025\"\r\n                  required\r\n                />\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"description\">Descrição</Label>\r\n                <textarea\r\n                  id=\"description\"\r\n                  value={formDescription}\r\n                  onChange={(e) => setFormDescription(e.target.value)}\r\n                  placeholder=\"Descreva o propósito deste formulário...\"\r\n                  className=\"w-full min-h-[80px] px-3 py-2 text-sm border rounded-md\"\r\n                />\r\n              </div>\r\n\r\n              {/* Observação: Polo e Status não são configurados manualmente aqui.\r\n                  - O formulário é criado como Ativo por padrão.\r\n                  - Opcionalmente, selecione um Polo para criar o formulário vinculado (obrigatório para admins). */}\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label>Polo (opcional — obrigatório para admins)</Label>\r\n                <Select\r\n                  value={selectedTenant}\r\n                  onChange={(e) => setSelectedTenant(e.target.value)}\r\n                  className=\"w-full\"\r\n                >\r\n                  <option value=\"\">\r\n                    {tenantsLoading ? 'Carregando polos...' : 'Selecione um polo (opcional)'}\r\n                  </option>\r\n                  {tenants.map((tenant) => (\r\n                    <option key={tenant.id} value={tenant.id}>\r\n                      {tenant.name}\r\n                    </option>\r\n                  ))}\r\n                </Select>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  - Superadmin: pode criar formulário global deixando vazio.\r\n                  <br />\r\n                  - Admin: deve selecionar um polo.\r\n                </p>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Campos do Formulário */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Campos do Formulário ({fields.length})</CardTitle>\r\n              <CardDescription>Arraste para reordenar os campos</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              {fields.length === 0 ? (\r\n                <div className=\"text-center py-8 text-muted-foreground\">\r\n                  Nenhum campo adicionado ainda. Use o menu à direita para adicionar campos.\r\n                </div>\r\n              ) : (\r\n                fields.map((field, index) => (\r\n                  <div\r\n                    key={index}\r\n                    className=\"flex items-center gap-3 p-4 border rounded-lg hover:bg-accent/50 transition-colors\"\r\n                  >\r\n                    <GripVertical className=\"h-5 w-5 text-muted-foreground cursor-move\" />\r\n                    \r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <p className=\"font-medium\">{field.label}</p>\r\n                        {field.required && (\r\n                          <Badge variant=\"destructive\" className=\"text-xs\">Obrigatório</Badge>\r\n                        )}\r\n                      </div>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        {FIELD_TYPES.find(t => t.value === field.type)?.label} • {field.name}\r\n                      </p>\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-1\">\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        onClick={() => moveField(index, 'up')}\r\n                        disabled={index === 0}\r\n                      >\r\n                        ↑\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        onClick={() => moveField(index, 'down')}\r\n                        disabled={index === fields.length - 1}\r\n                      >\r\n                        ↓\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        onClick={() => editField(index)}\r\n                      >\r\n                        <SettingsIcon className=\"h-4 w-4\" />\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        onClick={() => removeField(index)}\r\n                      >\r\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Sidebar - Tipos de Campo */}\r\n        <div className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Adicionar Campos</CardTitle>\r\n              <CardDescription>Clique para adicionar ao formulário</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-2\">\r\n              {FIELD_TYPES.map((fieldType) => (\r\n                <Button\r\n                  key={fieldType.value}\r\n                  variant=\"outline\"\r\n                  className=\"w-full justify-start\"\r\n                  onClick={() => addField(fieldType.value)}\r\n                >\r\n                  <Plus className=\"mr-2 h-4 w-4\" />\r\n                  {fieldType.label}\r\n                </Button>\r\n              ))}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Modal de Edição de Campo */}\r\n      {editingFieldIndex !== null && (\r\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\">\r\n          <Card className=\"w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n            <CardHeader>\r\n              <CardTitle>Editar Campo</CardTitle>\r\n              <CardDescription>Configure as propriedades do campo</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>Label (Rótulo) *</Label>\r\n                  <Input\r\n                    value={currentField.label}\r\n                    onChange={(e) => {\r\n                      const label = e.target.value;\r\n                      setCurrentField({\r\n                        ...currentField,\r\n                        label,\r\n                        name: generateFieldName(label),\r\n                      });\r\n                    }}\r\n                    placeholder=\"Ex: Nome Completo\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label>Name (Identificador) *</Label>\r\n                  <Input\r\n                    value={currentField.name}\r\n                    onChange={(e) => setCurrentField({ ...currentField, name: e.target.value })}\r\n                    placeholder=\"Ex: nome_completo\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label>Placeholder</Label>\r\n                <Input\r\n                  value={currentField.placeholder || ''}\r\n                  onChange={(e) => setCurrentField({ ...currentField, placeholder: e.target.value })}\r\n                  placeholder=\"Texto de ajuda para o usuário\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-4\">\r\n                <label className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={currentField.required}\r\n                    onChange={(e) => setCurrentField({ ...currentField, required: e.target.checked })}\r\n                  />\r\n                  <span>Campo Obrigatório</span>\r\n                </label>\r\n\r\n                <label className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={currentField.is_active}\r\n                    onChange={(e) => setCurrentField({ ...currentField, is_active: e.target.checked })}\r\n                  />\r\n                  <span>Campo Ativo</span>\r\n                </label>\r\n              </div>\r\n\r\n              {fieldRequiresOptions(currentField.type as any) && (\r\n                <div className=\"space-y-2\">\r\n                  <Label>Opções</Label>\r\n                  <div className=\"space-y-2\">\r\n                    {currentField.options?.map((option, i) => (\r\n                      <div key={i} className=\"flex gap-2\">\r\n                        <Input\r\n                          value={option.label}\r\n                          onChange={(e) => {\r\n                            const newOptions = [...(currentField.options || [])];\r\n                            newOptions[i] = { ...option, label: e.target.value, value: generateFieldName(e.target.value) };\r\n                            setCurrentField({ ...currentField, options: newOptions });\r\n                          }}\r\n                          placeholder=\"Label da opção\"\r\n                        />\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          onClick={() => {\r\n                            const newOptions = currentField.options?.filter((_, idx) => idx !== i);\r\n                            setCurrentField({ ...currentField, options: newOptions });\r\n                          }}\r\n                        >\r\n                          <Trash2 className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      </div>\r\n                    ))}\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => {\r\n                        const newOptions = [...(currentField.options || []), { label: '', value: '' }];\r\n                        setCurrentField({ ...currentField, options: newOptions });\r\n                      }}\r\n                    >\r\n                      <Plus className=\"mr-2 h-4 w-4\" />\r\n                      Adicionar Opção\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"flex gap-2 justify-end pt-4\">\r\n                <Button variant=\"outline\" onClick={cancelEdit}>\r\n                  Cancelar\r\n                </Button>\r\n                <Button onClick={saveFieldEdit} className=\"bg-brand-primary\">\r\n                  Salvar Alterações\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\forms\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Eye' is defined but never used.","line":24,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Plus, Edit2, Trash2, Loader2, Eye, Copy } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { formatDate } from '@/lib/utils';\r\nimport { Form } from '@/lib/form-field-types';\r\n\r\nexport default function FormsPage() {\r\n  const router = useRouter();\r\n  const [forms, setForms] = useState<Form[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\r\n  const [deletingForm, setDeletingForm] = useState<Form | null>(null);\r\n  const [submitting, setSubmitting] = useState(false);\r\n\r\n  useEffect(() => {\r\n    fetchForms();\r\n  }, []);\r\n\r\n  const fetchForms = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const response = await fetch('/api/forms');\r\n      const data = await response.json();\r\n\r\n      if (response.ok) {\r\n        setForms(data.forms || []);\r\n      } else {\r\n        toast.error(data.error || 'Erro ao carregar formulários');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching forms:', error);\r\n      toast.error('Erro ao carregar formulários');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async () => {\r\n    if (!deletingForm) return;\r\n\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/forms/${deletingForm.id}`, {\r\n        method: 'DELETE',\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast.success('Formulário deletado com sucesso!');\r\n        setDeleteDialogOpen(false);\r\n        setDeletingForm(null);\r\n        fetchForms();\r\n      } else {\r\n        const data = await response.json();\r\n        toast.error(data.error || 'Erro ao deletar formulário');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error deleting form:', error);\r\n      toast.error('Erro ao deletar formulário');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const copyPublicUrl = (form: Form) => {\r\n    const base = window.location.origin;\r\n    const url = form.slug ? `${base}/f/${form.slug}` : `${base}/form/${form.id}`;\r\n    navigator.clipboard.writeText(url);\r\n    toast.success('URL pública copiada!');\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-brand-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">Formulários</h1>\r\n          <p className=\"text-muted-foreground\">Crie e gerencie formulários personalizados</p>\r\n        </div>\r\n        <Button \r\n          onClick={() => router.push('/dashboard/forms/new')} \r\n          className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n        >\r\n          <Plus className=\"mr-2 h-4 w-4\" />\r\n          Novo Formulário\r\n        </Button>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Lista de Formulários</CardTitle>\r\n          <CardDescription>\r\n            {forms.length} {forms.length === 1 ? 'formulário cadastrado' : 'formulários cadastrados'}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {forms.length === 0 ? (\r\n            <div className=\"text-center py-12\">\r\n              <p className=\"text-muted-foreground mb-4\">Nenhum formulário cadastrado ainda.</p>\r\n              <Button \r\n                onClick={() => router.push('/dashboard/forms/new')}\r\n                className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n              >\r\n                <Plus className=\"mr-2 h-4 w-4\" />\r\n                Criar Primeiro Formulário\r\n              </Button>\r\n            </div>\r\n          ) : (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Título</TableHead>\r\n                  <TableHead>Polo</TableHead>\r\n                  <TableHead>Campos</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead>Criado em</TableHead>\r\n                  <TableHead className=\"text-right\">Ações</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {forms.map((form) => (\r\n                  <TableRow key={form.id}>\r\n                    <TableCell>\r\n                      <div>\r\n                        <p className=\"font-medium\">{form.name}</p>\r\n                        {form.description && (\r\n                          <p className=\"text-sm text-muted-foreground\">{form.description}</p>\r\n                        )}\r\n                        {form.slug && (\r\n                          <p className=\"text-xs text-muted-foreground mt-1\">\r\n                            <code className=\"bg-muted px-2 py-0.5 rounded\">\r\n                              {`${typeof window !== 'undefined' ? window.location.origin : ''}/f/${form.slug}`}\r\n                            </code>\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge variant=\"outline\">{form.tenants?.name || '— sem polo —'}</Badge>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge variant=\"secondary\">\r\n                        {form.form_fields?.length || 0} campos\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge variant={form.is_active ? 'success' : 'destructive'}>\r\n                        {form.is_active ? 'Ativo' : 'Inativo'}\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell>{formatDate(form.created_at)}</TableCell>\r\n                    <TableCell className=\"text-right space-x-2\">\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => copyPublicUrl(form)}\r\n                        title=\"Copiar URL pública\"\r\n                      >\r\n                        <Copy className=\"h-4 w-4\" />\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => router.push(`/dashboard/forms/${form.id}/edit`)}\r\n                        title=\"Editar\"\r\n                      >\r\n                        <Edit2 className=\"h-4 w-4\" />\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => {\r\n                          setDeletingForm(form);\r\n                          setDeleteDialogOpen(true);\r\n                        }}\r\n                        title=\"Deletar\"\r\n                      >\r\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\r\n                      </Button>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Dialog Deletar */}\r\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Confirmar Exclusão</DialogTitle>\r\n            <DialogDescription>\r\n              Tem certeza que deseja deletar o formulário <strong>{deletingForm?.name}</strong>?\r\n              {' '}Esta ação não pode ser desfeita.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <DialogFooter>\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={() => setDeleteDialogOpen(false)}\r\n              disabled={submitting}\r\n            >\r\n              Cancelar\r\n            </Button>\r\n            <Button\r\n              variant=\"destructive\"\r\n              onClick={handleDelete}\r\n              disabled={submitting}\r\n            >\r\n              {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n              Deletar\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from 'next/link';\nimport { redirect } from 'next/navigation';\nimport Logo from '@/components/ui/logo';\nimport { Button } from '@/components/ui/button';\nimport { LayoutDashboard, Users, FileText, Settings, Shield, MessageCircle } from 'lucide-react';\nimport { createClient } from '@/lib/supabase/server';\nimport { createAdminClient } from '@/lib/supabase/admin';\nimport DarkModeButton from '@/components/dashboard/DarkModeButton';\nimport LogoutButton from '@/components/dashboard/LogoutButton';\n\nexport default async function DashboardLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  // Buscar usuário autenticado pelo cookie (server-side)\n  const supabase = await createClient();\n  const {\n    data: { user: authUser },\n  } = await supabase.auth.getUser();\n\n  if (!authUser) {\n    // Redireciona no servidor evitando hidratação desnecessária quando não autenticado\n    redirect('/auth/login');\n  }\n\n  // Obter registro completo do usuário (tabela public.users) usando Service Role no backend\n  const admin = createAdminClient();\n  let { data: userRow } = await admin\n    .from('users')\n    .select('*')\n    .eq('auth_user_id', authUser!.id)\n    .maybeSingle();\n\n  if (!userRow && authUser?.email) {\n    const { data: byEmail } = await admin\n      .from('users')\n      .select('*')\n      .eq('email', authUser.email)\n      .maybeSingle();\n    if (byEmail) userRow = byEmail;\n  }\n\n  if (!userRow) {\n    // Segurança: se não encontrou o registro, força login novamente\n    redirect('/auth/login');\n  }\n\n  // Menu conforme papel do usuário\n  const menuItems = [\n    { label: 'Dashboard', href: '/dashboard', icon: LayoutDashboard },\n    { label: 'Polos', href: '/dashboard/tenants', icon: Users },\n    ...(userRow?.role === 'admin' || userRow?.role === 'superadmin'\n      ? [{ label: 'Status Integração', href: '/dashboard/status-integracao', icon: MessageCircle }]\n      : []),\n    ...(userRow?.role === 'superadmin' ? [{ label: 'Admins', href: '/dashboard/admins', icon: Shield }] : []),\n    ...(userRow?.role === 'superadmin' ? [{ label: 'Formulários', href: '/dashboard/forms', icon: FileText }] : []),\n    { label: 'Alunos', href: '/dashboard/submissions', icon: Users },\n    { label: 'Mensagens', href: '/dashboard/messages', icon: MessageCircle },\n    { label: 'Templates', href: '/dashboard/templates', icon: FileText },\n    ...(userRow?.role === 'superadmin' ? [{ label: 'Configurações', href: '/dashboard/settings', icon: Settings }] : []),\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Sidebar fixa (sem hidratação) */}\n      <aside\n        className=\"fixed top-0 left-0 z-40 h-screen bg-card border-r border-border\"\n        style={{ width: '240px' }}\n      >\n        <div className=\"h-full px-3 py-4 overflow-y-auto\">\n          <div className=\"flex items-center mb-5 px-3\">\n            <Logo size=\"xl\" />\n          </div>\n          <ul className=\"space-y-2 font-medium\">\n            {menuItems.map((item) => (\n              <li key={item.href}>\n                <Link href={item.href} className=\"flex items-center p-2 rounded-lg hover:bg-muted group\">\n                  <item.icon className=\"w-5 h-5 text-muted-foreground group-hover:text-foreground\" />\n                  <span className=\"ml-3\">{item.label}</span>\n                </Link>\n              </li>\n            ))}\n          </ul>\n        </div>\n      </aside>\n\n      {/* Conteúdo principal com margem fixa para a sidebar */}\n      <div className=\"ml-60\">\n        {/* Topbar */}\n        <header className=\"sticky top-0 z-30 bg-card border-b border-border\">\n          <div className=\"px-4 py-3 flex items-center justify-between\">\n            {/* Sem botão de toggle por enquanto para reduzir hidratação */}\n            <div />\n            <div className=\"flex items-center gap-4\">\n              <DarkModeButton />\n              <div className=\"flex items-center gap-3\">\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-medium\">{userRow?.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">{userRow?.role}</p>\n                </div>\n                <LogoutButton />\n              </div>\n            </div>\n          </div>\n        </header>\n        <main>{children}</main>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\messages\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDisplayLabel' is defined but never used.","line":12,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDisplayValueByKey' is defined but never used.","line":12,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":69},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatCEP' is defined but never used.","line":13,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatRG' is defined but never used.","line":13,"column":47,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[837,840],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[837,840],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tenants' is assigned a value but never used.","line":20,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLimit' is assigned a value but never used.","line":33,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2364,2367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2364,2367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'extractPhone'. Either include it or remove the dependency array.","line":152,"column":23,"nodeType":"ArrayExpression","endLine":152,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [extractPhone, selectedSubsMemo]","fix":{"range":[6300,6318],"text":"[extractPhone, selectedSubsMemo]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'extractEmail'. Either include it or remove the dependency array.","line":156,"column":23,"nodeType":"ArrayExpression","endLine":156,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [extractEmail, selectedSubsMemo]","fix":{"range":[6482,6500],"text":"[extractEmail, selectedSubsMemo]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":242,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":242,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9851,9854],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9851,9854],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'normalizeText' is assigned a value but never used.","line":289,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":289,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'extractName' is assigned a value but never used.","line":295,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":295,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":316,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":316,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12605,12608],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12605,12608],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":350,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":350,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14244,14247],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14244,14247],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select } from \"@/components/ui/select\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { toast } from \"sonner\";\r\nimport { formatDateTime, formatDisplayLabel, formatDisplayValueByKey } from \"@/lib/utils\";\r\nimport { formatCEP, formatPhone as maskPhone, formatRG } from \"@/lib/masks\";\r\n\r\ntype Tenant = { id: string; name: string; slug: string };\r\ntype Template = { id: string; key: string; title: string; content: string; is_active: boolean };\r\ntype Submission = { id: string; tenant_id: string; data: any };\r\n\r\nexport default function MessagesPage() {\r\n  const [tenants, setTenants] = useState<Tenant[]>([]);\r\n  const [tenantId, setTenantId] = useState<string>(\"\");\r\n  const [channel, setChannel] = useState<\"whatsapp\" | \"email\">(\"whatsapp\");\r\n  const [templates, setTemplates] = useState<Template[]>([]);\r\n  const [selectedTemplate, setSelectedTemplate] = useState<string>(\"\");\r\n  const [message, setMessage] = useState<string>(\"\");\r\n  const [subject, setSubject] = useState<string>(\"\");\r\n  const [html, setHtml] = useState<string>(\"\");\r\n  const [recipientsManual, setRecipientsManual] = useState<string>(\"\");\r\n  const [search, setSearch] = useState<string>(\"\");\r\n  const [submissions, setSubmissions] = useState<Submission[]>([]);\r\n  // Paginação\r\n  const [page, setPage] = useState<number>(1);\r\n  const [limit, setLimit] = useState<number>(20);\r\n  const [total, setTotal] = useState<number>(0);\r\n  const [selectedSubmissionIds, setSelectedSubmissionIds] = useState<string[]>([]);\r\n  const [schedule, setSchedule] = useState<boolean>(false);\r\n  const [scheduleAt, setScheduleAt] = useState<string>(\"\");\r\n  const [processing, setProcessing] = useState<boolean>(false);\r\n  const [debouncedSearch, setDebouncedSearch] = useState<string>(\"\");\r\n  const [loadingSubmissions, setLoadingSubmissions] = useState<boolean>(false);\r\n\r\n  // Helpers para extrair valores por chaves exatas ou por substring\r\n  const getValueByKeys = (keys: string[], data: Record<string, unknown>) => {\r\n    for (const k of keys) {\r\n      const v = (data as any)?.[k];\r\n      if (v != null && String(v).trim() !== \"\") return String(v);\r\n    }\r\n    return \"\";\r\n  };\r\n  const getValueByContains = (substrings: string[], data: Record<string, unknown>) => {\r\n    const entries = Object.entries(data || {});\r\n    for (const [key, val] of entries) {\r\n      const lk = String(key).toLowerCase();\r\n      if (substrings.some(sub => lk.includes(sub))) {\r\n        const v = val != null ? String(val).trim() : '';\r\n        if (v) return v;\r\n      }\r\n    }\r\n    return \"\";\r\n  };\r\n  const extractPhone = (data: Record<string, unknown>) => (\r\n    getValueByKeys([\"whatsapp\",\"telefone\",\"phone\",\"celular\"], data) ||\r\n    getValueByContains([\"whats\",\"zap\",\"tel\",\"fone\",\"cel\",\"telefone\",\"celular\",\"phone\"], data)\r\n  );\r\n  const extractEmail = (data: Record<string, unknown>) => (\r\n    getValueByKeys([\"email\",\"contato_email\",\"e-mail\"], data) ||\r\n    getValueByContains([\"email\",\"e-mail\",\"mail\"], data)\r\n  );\r\n\r\n  useEffect(() => {\r\n    // Carregar tenants (RLS filtra automaticamente)\r\n    fetch(\"/api/tenants\").then(async (res) => {\r\n      const data = await res.json();\r\n      const ts: Tenant[] = data?.tenants || [];\r\n      setTenants(ts);\r\n      if (ts.length > 0) setTenantId(ts[0].id);\r\n    }).catch(() => toast.error(\"Erro ao carregar dados\"));\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    // Carregar templates globais (apenas admin/superadmin)\r\n    const controller = new AbortController();\r\n    fetch(`/api/templates`, { signal: controller.signal })\r\n      .then(async (res) => {\r\n        const payload = await res.json();\r\n        const items = (payload?.templates || []).map((t: {\r\n          id: string;\r\n          trigger_event: string;\r\n          name: string;\r\n          message_template: string;\r\n          is_active?: boolean;\r\n        }) => ({\r\n          id: t.id,\r\n          key: t.trigger_event,\r\n          title: t.name,\r\n          content: t.message_template,\r\n          is_active: !!t.is_active,\r\n        })) as Template[];\r\n        setTemplates(items.filter(t => t.is_active));\r\n      })\r\n      .catch(() => {});\r\n    return () => controller.abort();\r\n  }, []);\r\n\r\n  // Debounce da busca para evitar excesso de requisições\r\n  useEffect(() => {\r\n    const t = setTimeout(() => setDebouncedSearch(search.trim()), 300);\r\n    return () => clearTimeout(t);\r\n  }, [search]);\r\n\r\n  useEffect(() => {\r\n    // Buscar submissions com paginação. Quando a busca é vazia, lista geral; quando há termo, filtra no servidor.\r\n    const controller = new AbortController();\r\n    const q = new URLSearchParams();\r\n    const offset = (page - 1) * limit;\r\n    q.set(\"limit\", String(limit));\r\n    q.set(\"offset\", String(offset));\r\n    if (debouncedSearch) q.set(\"search\", debouncedSearch);\r\n\r\n    setLoadingSubmissions(true);\r\n    fetch(`/api/submissions?${q.toString()}`, { signal: controller.signal })\r\n      .then(async (res) => {\r\n        const payload = await res.json();\r\n        const list = payload?.submissions || [];\r\n        setSubmissions(list);\r\n        setTotal(Number(payload?.total ?? 0));\r\n      })\r\n      .catch(() => {})\r\n      .finally(() => setLoadingSubmissions(false));\r\n    return () => controller.abort();\r\n  }, [debouncedSearch, page, limit]);\r\n\r\n  // Ao mudar o termo de busca, sempre voltar para página 1\r\n  useEffect(() => {\r\n    setPage(1);\r\n  }, [debouncedSearch]);\r\n\r\n  // Mantém seleção apenas quando a lista muda\r\n\r\n  const manualList = useMemo(() => {\r\n    return recipientsManual\r\n      .split(/\\n|,|;|\\s+/)\r\n      .map(s => s.trim())\r\n      .filter(Boolean);\r\n  }, [recipientsManual]);\r\n\r\n  // Seleção atual e contagem de destinatários (para desabilitar botões quando vazio)\r\n  const selectedSubsMemo = useMemo(() => submissions.filter(s => selectedSubmissionIds.includes(s.id)), [submissions, selectedSubmissionIds]);\r\n  const selectedPhonesMemo = useMemo(() => selectedSubsMemo\r\n    .map(s => extractPhone(s?.data || {}))\r\n    .map(v => String(v).trim())\r\n    .filter(Boolean), [selectedSubsMemo]);\r\n  const selectedEmailsMemo = useMemo(() => selectedSubsMemo\r\n    .map(s => extractEmail(s?.data || {}))\r\n    .map(v => String(v).trim())\r\n    .filter(Boolean), [selectedSubsMemo]);\r\n  const recipientsCount = useMemo(() => {\r\n    return channel === 'whatsapp'\r\n      ? [...selectedPhonesMemo, ...manualList].filter(Boolean).length\r\n      : [...selectedEmailsMemo, ...manualList].filter(Boolean).length;\r\n  }, [channel, selectedPhonesMemo, selectedEmailsMemo, manualList]);\r\n\r\n  async function handleSend() {\r\n    try {\r\n      setProcessing(true);\r\n\r\n      const selectedSubs = submissions.filter(s => selectedSubmissionIds.includes(s.id));\r\n      // Extrai telefones e e-mails considerando variações comuns nos formulários\r\n      const phones = selectedSubs\r\n        .map(s => extractPhone(s?.data || {}))\r\n        .map(v => String(v).trim())\r\n        .filter(Boolean);\r\n      const emails = selectedSubs\r\n        .map(s => extractEmail(s?.data || {}))\r\n        .map(v => String(v).trim())\r\n        .filter(Boolean);\r\n\r\n      if (channel === \"whatsapp\") {\r\n        const body = {\r\n          tenant_id: tenantId,\r\n          to: [...phones, ...manualList].filter(Boolean),\r\n          template_key: selectedTemplate || undefined,\r\n          message: message || undefined,\r\n          variables: {},\r\n        };\r\n        const res = await fetch(\"/api/whatsapp/send\", {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify(body),\r\n        });\r\n        const payload = await res.json().catch(() => ({}));\r\n        if (!res.ok) throw new Error(payload?.error || \"Falha ao enviar WhatsApp\");\r\n        // Feedback mais claro: informa sucessos e falhas\r\n        const success = Number(payload?.success ?? 0);\r\n        const failures = Number(payload?.failures ?? 0);\r\n        if (success === 0) {\r\n          toast.error(`Nenhuma mensagem enviada. Falhas: ${failures}`);\r\n        } else if (failures > 0) {\r\n          toast.success(`WhatsApp enviado para ${success} destinatário(s). Falhas: ${failures}`);\r\n        } else {\r\n          toast.success(`WhatsApp enviado para ${success} destinatário(s).`);\r\n        }\r\n      } else {\r\n        const body = {\r\n          tenant_id: tenantId,\r\n          to: [...emails, ...manualList].filter(Boolean),\r\n          subject: subject || \"Mensagem\",\r\n          html: html || message,\r\n          template_key: selectedTemplate || undefined,\r\n          variables: {},\r\n        };\r\n        const res = await fetch(\"/api/emails/send\", {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify(body),\r\n        });\r\n        if (!res.ok) throw new Error(\"Falha ao enviar E-mail\");\r\n        toast.success(\"E-mail enviado\");\r\n      }\r\n    } catch (e: unknown) {\r\n      const msg = e instanceof Error ? e.message : \"Erro ao enviar\";\r\n      toast.error(msg);\r\n    } finally {\r\n      setProcessing(false);\r\n    }\r\n  }\r\n\r\n  async function handleSchedule() {\r\n    try {\r\n      if (!scheduleAt) { toast.error(\"Defina data/hora do agendamento\"); return; }\r\n      setProcessing(true);\r\n      const selectedSubs = submissions.filter(s => selectedSubmissionIds.includes(s.id));\r\n      const phones = selectedSubs\r\n        .map(s => extractPhone(s?.data || {}))\r\n        .map(v => String(v).trim())\r\n        .filter(Boolean);\r\n      const emails = selectedSubs\r\n        .map(s => extractEmail(s?.data || {})) \r\n        .map(v => String(v).trim())\r\n        .filter(Boolean);\r\n\r\n      const body: any = {\r\n        tenant_id: tenantId,\r\n        channel,\r\n        scheduled_for: scheduleAt,\r\n        variables: {},\r\n        metadata: {},\r\n      };\r\n      if (channel === \"whatsapp\") {\r\n        body.recipient_phones = [...phones, ...manualList].filter(Boolean);\r\n        body.template_key = selectedTemplate || undefined;\r\n        body.message = message || undefined;\r\n      } else {\r\n        body.to = [...emails, ...manualList].filter(Boolean);\r\n        body.subject = subject || \"Mensagem\";\r\n        body.html = html || message;\r\n        body.template_key = selectedTemplate || undefined;\r\n      }\r\n\r\n      const res = await fetch(\"/api/messages/schedule\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(body),\r\n      });\r\n      if (!res.ok) throw new Error(\"Falha ao agendar\");\r\n      toast.success(\"Agendado com sucesso\");\r\n    } catch (e: unknown) {\r\n      const msg = e instanceof Error ? e.message : \"Erro ao agendar\";\r\n      toast.error(msg);\r\n    } finally {\r\n      setProcessing(false);\r\n    }\r\n  }\r\n\r\n  async function handleProcessDue() {\r\n    try {\r\n      setProcessing(true);\r\n      const res = await fetch(\"/api/messages/process-scheduled\", { method: \"POST\" });\r\n      if (!res.ok) throw new Error(\"Falha ao processar agendamentos\");\r\n      const payload = await res.json();\r\n      toast.success(`Processados: ${payload?.processed ?? 0}`);\r\n    } catch (e: unknown) {\r\n      const msg = e instanceof Error ? e.message : \"Erro ao processar agendamentos\";\r\n      toast.error(msg);\r\n    } finally { setProcessing(false); }\r\n  }\r\n\r\n  // Normalização para comparação (remove acentos e coloca em minúsculas)\r\n  const normalizeText = (s: string) => s\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .toLowerCase();\r\n\r\n  // Extrator de nome (reutiliza helpers já usados no render)\r\n  const extractName = (data: Record<string, unknown>) => (\r\n    getValueByKeys([\"nome_completo\",\"nome\",\"name\"], data)\r\n    || getValueByContains([\"nome\",\"aluno\",\"name\"], data)\r\n  );\r\n\r\n  // Lista final é a própria resposta da API (paginação e busca já aplicadas)\r\n  const renderedSubmissions = submissions;\r\n\r\n  return (\r\n    <div className=\"p-4\">\r\n      <div className=\"flex items-center justify-between mb-3\">\r\n        <h1 className=\"text-xl font-semibold\">Mensagens</h1>\r\n        <Button variant=\"outline\" onClick={handleProcessDue} disabled={processing}>Executar agendamentos vencidos</Button>\r\n      </div>\r\n\r\n      <Card className=\"p-4 mb-4\">\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n          <div>\r\n            <Label>Canal</Label>\r\n            <Select\r\n              value={channel}\r\n              onChange={(e) => setChannel(e.target.value as any)}\r\n              className=\"mt-1\"\r\n            >\r\n              <option value=\"whatsapp\">WhatsApp</option>\r\n              <option value=\"email\">E-mail</option>\r\n            </Select>\r\n          </div>\r\n          <div className=\"flex items-end gap-2\">\r\n            <div className=\"flex items-center gap-2 mt-6\">\r\n              <Switch checked={schedule} onCheckedChange={setSchedule} />\r\n              <span>Agendar</span>\r\n            </div>\r\n            {schedule && (\r\n              <Input type=\"datetime-local\" value={scheduleAt} onChange={(e) => setScheduleAt(e.target.value)} />\r\n            )}\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      <Card className=\"p-4 mb-4\">\r\n        <div>\r\n          <Label>Buscar alunos</Label>\r\n          <Input placeholder=\"Nome, e-mail ou telefone\" autoComplete=\"off\" value={search} onChange={(e) => setSearch(e.target.value)} className=\"mt-1\" />\r\n          <div className=\"max-h-96 md:max-h-[480px] overflow-auto mt-2 border rounded\">\r\n            {loadingSubmissions && (\r\n              <div className=\"p-2 text-sm text-muted-foreground\">Carregando alunos...</div>\r\n            )}\r\n            {!loadingSubmissions && renderedSubmissions.length === 0 && (\r\n              <div className=\"p-2 text-sm text-muted-foreground\">Nenhum aluno encontrado.</div>\r\n            )}\r\n            {!loadingSubmissions && renderedSubmissions.map(s => {\r\n              // Extratores simples com chaves exatas e busca por substring\r\n              const getValueByKeys = (keys: string[], data: Record<string, unknown>) => {\r\n                for (const k of keys) {\r\n                  const v = (data as any)?.[k];\r\n                  if (v != null && String(v).trim() !== \"\") return String(v);\r\n                }\r\n                return \"\";\r\n              };\r\n              const getValueByContains = (substrings: string[], data: Record<string, unknown>) => {\r\n                const entries = Object.entries(data || {});\r\n                for (const [key, val] of entries) {\r\n                  const lk = String(key).toLowerCase();\r\n                  if (substrings.some(sub => lk.includes(sub))) {\r\n                    const v = val != null ? String(val).trim() : '';\r\n                    if (v) return v;\r\n                  }\r\n                }\r\n                return \"\";\r\n              };\r\n\r\n              const data = (s?.data || {}) as Record<string, unknown>;\r\n              const name = getValueByKeys([\"nome_completo\",\"nome\",\"name\"], data)\r\n                || getValueByContains([\"nome\",\"aluno\",\"name\"], data);\r\n              const phoneRaw = getValueByKeys([\"whatsapp\",\"telefone\",\"phone\",\"celular\"], data)\r\n                || getValueByContains([\"whats\",\"zap\",\"tel\",\"fone\",\"cel\",\"telefone\",\"celular\",\"phone\"], data);\r\n\r\n              const id = `submission-${s.id}`;\r\n              return (\r\n                <label key={s.id} htmlFor={id} className=\"flex items-center gap-2 p-2 border-b\">\r\n                  <input\r\n                    id={id}\r\n                    type=\"checkbox\"\r\n                    checked={selectedSubmissionIds.includes(s.id)}\r\n                    onChange={(e) => {\r\n                      setSelectedSubmissionIds(prev => e.target.checked ? [...prev, s.id] : prev.filter(id => id !== s.id));\r\n                    }}\r\n                  />\r\n                  <span className=\"text-sm\">\r\n                    <span className=\"font-bold\">{name || \"Aluno\"}</span>\r\n                    {phoneRaw && (\r\n                      <span className=\"font-bold\"> • WhatsApp: {maskPhone(phoneRaw)}</span>\r\n                    )}\r\n                  </span>\r\n                </label>\r\n              );\r\n            })}\r\n          </div>\r\n          {/* Controles de paginação */}\r\n          <div className=\"flex items-center justify-between mt-2\">\r\n            <div className=\"text-xs text-muted-foreground\">Página {Math.max(1, page)} de {Math.max(1, Math.ceil(total / limit) || 1)}</div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setPage((p) => Math.max(1, p - 1))}\r\n                disabled={page <= 1 || loadingSubmissions}\r\n              >Anterior</Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setPage((p) => p + 1)}\r\n                disabled={page >= Math.ceil(total / limit) || loadingSubmissions}\r\n              >Próxima</Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      {/* Card separado para destinatários manuais */}\r\n      <Card className=\"p-4 mb-4\">\r\n        <div>\r\n          <Label>Destinatários manuais ({channel === \"whatsapp\" ? \"telefones\" : \"e-mails\"})</Label>\r\n          <Textarea placeholder={channel === \"whatsapp\" ? \"5511999999999, 11999999999\" : \"email@dominio.com, outro@dominio.com\"} value={recipientsManual} onChange={(e) => setRecipientsManual(e.target.value)} className=\"mt-1\" rows={6} />\r\n        </div>\r\n      </Card>\r\n\r\n      <Card className=\"p-4\">\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n          <div>\r\n            <Label>Template (opcional)</Label>\r\n            <Select\r\n              value={selectedTemplate}\r\n              onChange={(e) => setSelectedTemplate(e.target.value)}\r\n              className=\"mt-1\"\r\n            >\r\n              <option value=\"\">Selecione</option>\r\n              {templates.map(t => (\r\n                <option key={t.id} value={t.key}>{t.title}</option>\r\n              ))}\r\n            </Select>\r\n            <div className=\"mt-2\">\r\n              <a href=\"/dashboard/templates\" className=\"text-xs text-blue-600 underline\">Gerenciar Templates</a>\r\n            </div>\r\n          </div>\r\n\r\n          {channel === \"email\" && (\r\n            <div>\r\n              <Label>Assunto</Label>\r\n              <Input value={subject} onChange={(e) => setSubject(e.target.value)} className=\"mt-1\" />\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {channel === \"email\" ? (\r\n          <div className=\"mt-4\">\r\n            <Label>HTML</Label>\r\n            <Textarea value={html} onChange={(e) => setHtml(e.target.value)} rows={8} className=\"mt-1\" />\r\n          </div>\r\n        ) : (\r\n          <div className=\"mt-4\">\r\n            <Label>Mensagem</Label>\r\n            <Textarea value={message} onChange={(e) => setMessage(e.target.value)} rows={6} className=\"mt-1\" />\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"flex gap-2 mt-4\">\r\n          <Button onClick={handleSend} disabled={processing || recipientsCount === 0}>Enviar agora</Button>\r\n          <Button variant=\"secondary\" onClick={handleSchedule} disabled={!schedule || processing || recipientsCount === 0}>Agendar</Button>\r\n        </div>\r\n        {recipientsCount === 0 && (\r\n          <p className=\"text-xs text-red-600 mt-1\">Selecione pelo menos 1 destinatário ou informe manualmente.</p>\r\n        )}\r\n        <p className=\"text-xs text-muted-foreground mt-2\">\r\n          Dica: você pode usar placeholders como {\"{{nome_completo}}\"}, {\"{{curso}}\"}, {\"{{valor}}\"} se utilizar templates.\r\n        </p>\r\n        <p className=\"text-xs text-muted-foreground\">Horário atual: {formatDateTime(new Date())}</p>\r\n      </Card>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1180,1183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1180,1183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMetrics'. Either include it or remove the dependency array.","line":46,"column":6,"nodeType":"ArrayExpression","endLine":46,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [month, year, selectedTenant, fetchMetrics]","fix":{"range":[1358,1387],"text":"[month, year, selectedTenant, fetchMetrics]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'paymentChartData' is assigned a value but never used.","line":92,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":92,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Users, Loader2, RefreshCw } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\n\r\ninterface Metrics {\r\n  totalSubmissions: number;\r\n  totalRevenue: number;\r\n  conversionRate: number;\r\n  activeForms: number;\r\n  submissionsByDay: Array<{ date: string; count: number }>;\r\n  revenueByDay: Array<{ date: string; amount: number }>;\r\n  formPerformance: Array<{\r\n    formId: string;\r\n    formTitle: string;\r\n    submissions: number;\r\n    conversions: number;\r\n    conversionRate: number;\r\n  }>;\r\n  paymentStats: {\r\n    approved: number;\r\n    pending: number;\r\n    failed: number;\r\n  };\r\n}\r\n\r\nexport default function DashboardPage() {\r\n  const [metrics, setMetrics] = useState<Metrics | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  // Filtro por mês/ano\r\n  const now = new Date();\r\n  const [month, setMonth] = useState(String(now.getMonth() + 1)); // 1-12\r\n  const [year, setYear] = useState(String(now.getFullYear()));\r\n  const [tenants, setTenants] = useState<any[]>([]);\r\n  const [selectedTenant, setSelectedTenant] = useState('');\r\n\r\n  useEffect(() => {\r\n    fetchTenants();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    fetchMetrics();\r\n  }, [month, year, selectedTenant]);\r\n\r\n  const fetchTenants = async () => {\r\n    try {\r\n      const response = await fetch('/api/tenants');\r\n      const data = await response.json();\r\n      if (response.ok) {\r\n        setTenants(data.tenants || []);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching tenants:', error);\r\n    }\r\n  };\r\n\r\n  const fetchMetrics = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const params = new URLSearchParams({ month, year });\r\n      if (selectedTenant) {\r\n        params.append('tenant_id', selectedTenant);\r\n      }\r\n\r\n      const response = await fetch(`/api/metrics?${params}`);\r\n      const data = await response.json();\r\n\r\n      if (response.ok) {\r\n        setMetrics(data);\r\n      } else {\r\n        toast.error(data.error || 'Erro ao carregar métricas');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching metrics:', error);\r\n      toast.error('Erro ao carregar métricas');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (loading && !metrics) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-brand-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const paymentChartData = [\r\n    { label: 'Aprovados', value: metrics?.paymentStats.approved || 0, color: '#10B981' },\r\n    { label: 'Pendentes', value: metrics?.paymentStats.pending || 0, color: '#F59E0B' },\r\n    { label: 'Falhou', value: metrics?.paymentStats.failed || 0, color: '#EF4444' },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">Dashboard</h1>\r\n          <p className=\"text-muted-foreground\">Visão geral e métricas do sistema</p>\r\n        </div>\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={fetchMetrics}\r\n          disabled={loading}\r\n        >\r\n          {loading ? (\r\n            <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n          ) : (\r\n            <RefreshCw className=\"h-4 w-4\" />\r\n          )}\r\n          <span className=\"ml-2\">Atualizar</span>\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <Card>\r\n        <CardContent className=\"pt-6\">\r\n          <div className=\"grid gap-4 md:grid-cols-3\">\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium mb-2 block\">Mês</label>\r\n              <select\r\n                value={month}\r\n                onChange={(e) => setMonth(e.target.value)}\r\n                className=\"w-full px-3 py-2 text-sm border rounded-md bg-card text-foreground focus:outline-none focus:ring-1 focus:ring-ring\"\r\n              >\r\n                <option value=\"1\">Janeiro</option>\r\n                <option value=\"2\">Fevereiro</option>\r\n                <option value=\"3\">Março</option>\r\n                <option value=\"4\">Abril</option>\r\n                <option value=\"5\">Maio</option>\r\n                <option value=\"6\">Junho</option>\r\n                <option value=\"7\">Julho</option>\r\n                <option value=\"8\">Agosto</option>\r\n                <option value=\"9\">Setembro</option>\r\n                <option value=\"10\">Outubro</option>\r\n                <option value=\"11\">Novembro</option>\r\n                <option value=\"12\">Dezembro</option>\r\n              </select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium mb-2 block\">Ano</label>\r\n              <select\r\n                value={year}\r\n                onChange={(e) => setYear(e.target.value)}\r\n                className=\"w-full px-3 py-2 text-sm border rounded-md bg-card text-foreground focus:outline-none focus:ring-1 focus:ring-ring\"\r\n              >\r\n                {Array.from({ length: 5 }, (_, i) => String(now.getFullYear() - i)).map((y) => (\r\n                  <option key={y} value={y}>{y}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium mb-2 block\">Polo</label>\r\n              <select\r\n                value={selectedTenant}\r\n                onChange={(e) => setSelectedTenant(e.target.value)}\r\n                className=\"w-full px-3 py-2 text-sm border rounded-md bg-card text-foreground focus:outline-none focus:ring-1 focus:ring-ring\"\r\n              >\r\n                <option value=\"\">Todos os Polos</option>\r\n                {tenants.map((tenant) => (\r\n                  <option key={tenant.id} value={tenant.id}>\r\n                    {tenant.name}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* KPI Cards - Apenas Total de Inscrições */}\r\n      <div className=\"grid gap-4 md:grid-cols-1\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total de Inscrições</CardTitle>\r\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{metrics?.totalSubmissions || 0}</div>\r\n            <p className=\"text-xs text-muted-foreground mt-1\">\r\n              Cadastros realizados no mês selecionado\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Demais métricas e gráficos ocultados conforme solicitação */}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SettingsIcon' is defined but never used.","line":9,"column":37,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tenants' is assigned a value but never used.","line":16,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[780,783],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[780,783],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[991,994],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[991,994],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1688,1691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1688,1691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1826,1829],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1826,1829],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchConfigurations'. Either include it or remove the dependency array.","line":61,"column":6,"nodeType":"ArrayExpression","endLine":61,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchConfigurations]","fix":{"range":[2108,2110],"text":"[fetchConfigurations]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchConfigurations'. Either include it or remove the dependency array.","line":65,"column":6,"nodeType":"ArrayExpression","endLine":65,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [activeTab, fetchConfigurations]","fix":{"range":[2170,2181],"text":"[activeTab, fetchConfigurations]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":194,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":194,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":316,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":316,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":348,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":348,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":380,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":380,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":719,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":719,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28537,28540],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28537,28540],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":768,"column":29,"nodeType":"JSXOpeningElement","endLine":773,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Loader2, Save, Settings as SettingsIcon, CreditCard, MessageCircle, Webhook, CheckCircle, XCircle, QrCode } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\n\r\nexport default function SettingsPage() {\r\n  const [activeTab, setActiveTab] = useState('mercadopago');\r\n  const [loading, setLoading] = useState(true);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [tenants, setTenants] = useState<any[]>([]);\r\n  const [role, setRole] = useState<'superadmin' | 'admin' | 'user' | ''>('');\r\n\r\n  // Mercado Pago\r\n  // Status do Mercado Pago via variáveis de ambiente\r\n  const [mpStatus, setMpStatus] = useState<any>(null);\r\n  // Formulário global para credenciais do Mercado Pago (somente superadmin edita)\r\n  const [mpGlobalConfig, setMpGlobalConfig] = useState({\r\n    id: '',\r\n    access_token: '',\r\n    public_key: '',\r\n    webhook_secret: '',\r\n    is_production: false,\r\n    is_active: true,\r\n    masked_access_token: '',\r\n    masked_public_key: '',\r\n    masked_webhook_secret: '',\r\n  });\r\n\r\n  // WhatsApp\r\n  const [whatsappConfig, setWhatsappConfig] = useState({\r\n    id: '',\r\n    instance_name: '',\r\n    api_url: '',\r\n    api_key: '',\r\n    is_active: true,\r\n  });\r\n  const [whatsappTestLoading, setWhatsappTestLoading] = useState(false);\r\n  const [whatsappTestResult, setWhatsappTestResult] = useState<any>(null);\r\n  const [whatsappQrLoading, setWhatsappQrLoading] = useState(false);\r\n  const [whatsappQrData, setWhatsappQrData] = useState<any>(null);\r\n\r\n  // n8n\r\n  const [n8nConfig, setN8nConfig] = useState({\r\n    id: '',\r\n    webhook_url: '',\r\n    auth_token: '',\r\n    timeout_seconds: 30,\r\n    max_retries: 3,\r\n    is_active: true,\r\n  });\r\n\r\n  useEffect(() => {\r\n    fetchTenants();\r\n    fetchConfigurations();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    fetchConfigurations();\r\n  }, [activeTab]);\r\n\r\n  // Sem dependência de tenant para Mercado Pago (global)\r\n\r\n  const fetchTenants = async () => {\r\n    try {\r\n      const response = await fetch('/api/tenants');\r\n      const data = await response.json();\r\n      if (response.ok) {\r\n        setTenants(data.tenants || []);\r\n        // Guardar papel do usuário para controle de visibilidade das abas\r\n        if (data.role) {\r\n          setRole(data.role);\r\n          // Para admins, manter apenas WhatsApp e ajustar a aba ativa\r\n          if (data.role === 'admin') {\r\n            setActiveTab('whatsapp');\r\n          }\r\n        }\r\n        // Sem dependência de tenant para configurações globais\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching tenants:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Mercado Pago não depende de tenant: nenhuma seleção padrão necessária\r\n\r\n  const handleTestWhatsApp = async () => {\r\n    setWhatsappTestLoading(true);\r\n    setWhatsappTestResult(null);\r\n\r\n    try {\r\n      const response = await fetch('/api/settings/whatsapp/test', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          api_url: whatsappConfig.api_url,\r\n          api_key: whatsappConfig.api_key,\r\n          instance_name: whatsappConfig.instance_name,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n      \r\n      if (response.ok && data.success) {\r\n        setWhatsappTestResult({\r\n          success: true,\r\n          message: data.message,\r\n          instances: data.instances,\r\n          total_instances: data.total_instances,\r\n          connected_instances: data.connected_instances,\r\n          connection_state: data.connection_state ?? null,\r\n        });\r\n        toast.success(data.message);\r\n      } else {\r\n        setWhatsappTestResult({\r\n          success: false,\r\n          error: data.error || 'Erro ao testar conexão',\r\n          instances: data.instances || [],\r\n        });\r\n        toast.error(data.error || 'Erro ao testar conexão');\r\n      }\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Erro ao testar conexão';\r\n      setWhatsappTestResult({\r\n        success: false,\r\n        error: errorMessage,\r\n        instances: [],\r\n      });\r\n      toast.error('Erro ao testar conexão');\r\n    } finally {\r\n      setWhatsappTestLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleShowWhatsAppQr = async () => {\r\n    setWhatsappQrLoading(true);\r\n    setWhatsappQrData(null);\r\n\r\n    try {\r\n      const response = await fetch('/api/settings/whatsapp/qrcode', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          api_url: whatsappConfig.api_url,\r\n          api_key: whatsappConfig.api_key,\r\n          instance_name: whatsappConfig.instance_name,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (response.ok && data.success) {\r\n        setWhatsappQrData(data);\r\n        if (data.qrcode_base64) {\r\n          toast.success('QR Code carregado. Escaneie para conectar.');\r\n        } else if (String(data.state || '').toLowerCase() === 'open') {\r\n          toast.info('Instância já conectada — não há QR Code disponível.');\r\n        } else {\r\n          toast.success(data.message || 'QR Code disponível.');\r\n        }\r\n      } else {\r\n        setWhatsappQrData({ success: false, error: data.error || 'Falha ao obter QR Code' });\r\n        toast.error(data.error || 'Falha ao obter QR Code');\r\n      }\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Erro ao obter QR Code';\r\n      setWhatsappQrData({ success: false, error: errorMessage });\r\n      toast.error('Erro ao obter QR Code');\r\n    } finally {\r\n      setWhatsappQrLoading(false);\r\n    }\r\n  };\r\n\r\n  // Mercado Pago global: não há função de salvar credenciais via UI\r\n\r\n  // Testar status de integração (global)\r\n  const handleTestMercadoPago = async () => {\r\n    try {\r\n      const resp = await fetch(`/api/integration/mercadopago/status`);\r\n      const data = await resp.json();\r\n      if (resp.ok) {\r\n        setMpStatus(data);\r\n        toast.success('Teste executado.');\r\n      } else {\r\n        toast.error(data.error || 'Falha no teste');\r\n      }\r\n    } catch (err) {\r\n      toast.error('Falha ao testar preferência');\r\n    }\r\n  };\r\n\r\n  const fetchConfigurations = async () => {\r\n    try {\r\n      setLoading(true);\r\n\r\n      if (activeTab === 'mercadopago') {\r\n        // Carregar status global\r\n        const stResp = await fetch(`/api/integration/mercadopago/status`);\r\n        const stData = await stResp.json();\r\n        setMpStatus(stResp.ok ? stData : null);\r\n\r\n        // Carregar configuração global (não expõe valor completo dos tokens)\r\n        const cfgResp = await fetch('/api/settings/mercadopago-global');\r\n        const cfgData = await cfgResp.json();\r\n        if (cfgResp.ok && cfgData.config) {\r\n          setMpGlobalConfig((prev) => ({\r\n            ...prev,\r\n            id: cfgData.config.id || '',\r\n            is_production: !!cfgData.config.is_production,\r\n            is_active: cfgData.config.is_active !== false,\r\n            masked_access_token: cfgData.config.masked_access_token || '',\r\n            masked_public_key: cfgData.config.masked_public_key || '',\r\n            masked_webhook_secret: cfgData.config.masked_webhook_secret || '',\r\n          }));\r\n        } else {\r\n          setMpGlobalConfig((prev) => ({\r\n            ...prev,\r\n            id: '',\r\n            is_production: false,\r\n            is_active: true,\r\n            masked_access_token: '',\r\n            masked_public_key: '',\r\n            masked_webhook_secret: '',\r\n          }));\r\n        }\r\n      } else if (activeTab === 'whatsapp') {\r\n        const response = await fetch('/api/settings/whatsapp');\r\n        const data = await response.json();\r\n        if (response.ok && data.config) {\r\n          // Mapear campos do backend (instance_id/api_base_url/token) para os inputs da UI\r\n          setWhatsappConfig({\r\n            id: data.config.id || '',\r\n            instance_name: data.config.instance_id || '',\r\n            api_url: data.config.api_base_url || '',\r\n            api_key: data.config.token || '',\r\n            is_active: data.config.is_active !== false,\r\n          });\r\n        } else {\r\n          setWhatsappConfig({\r\n            id: '',\r\n            instance_name: '',\r\n            api_url: '',\r\n            api_key: '',\r\n            is_active: true,\r\n          });\r\n        }\r\n      } else if (activeTab === 'n8n') {\r\n        const response = await fetch('/api/settings/n8n');\r\n        const data = await response.json();\r\n        if (response.ok && data.config) {\r\n          setN8nConfig({\r\n            id: data.config.id || '',\r\n            webhook_url: data.config.enrollment_webhook_url || '',\r\n            auth_token: data.config.enrollment_webhook_token || '',\r\n            timeout_seconds: Math.round((data.config.timeout_ms ?? 30000) / 1000),\r\n            max_retries: data.config.retries ?? 3,\r\n            is_active: data.config.is_active !== false,\r\n          });\r\n        } else {\r\n          setN8nConfig({\r\n            id: '',\r\n            webhook_url: '',\r\n            auth_token: '',\r\n            timeout_seconds: 30,\r\n            max_retries: 3,\r\n            is_active: true,\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching config:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Mercado Pago agora é baseado em variáveis de ambiente; não há formulário de salvamento\r\n  const handleSaveMercadoPagoGlobal = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const response = await fetch('/api/settings/mercadopago-global', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          access_token: mpGlobalConfig.access_token,\r\n          public_key: mpGlobalConfig.public_key,\r\n          webhook_secret: mpGlobalConfig.webhook_secret,\r\n          is_production: mpGlobalConfig.is_production,\r\n          is_active: mpGlobalConfig.is_active,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n      if (response.ok && data.success) {\r\n        toast.success('Credenciais do Mercado Pago salvas com sucesso!');\r\n        // Limpar campos sensíveis após salvar\r\n        setMpGlobalConfig((prev) => ({\r\n          ...prev,\r\n          access_token: '',\r\n          public_key: '',\r\n          webhook_secret: '',\r\n        }));\r\n        fetchConfigurations();\r\n      } else {\r\n        toast.error(data.error || 'Erro ao salvar credenciais');\r\n      }\r\n    } catch (error) {\r\n      toast.error('Erro ao salvar credenciais');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveWhatsApp = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const method = whatsappConfig.id ? 'PATCH' : 'POST';\r\n      const url = whatsappConfig.id\r\n        ? `/api/settings/whatsapp/${whatsappConfig.id}`\r\n        : '/api/settings/whatsapp';\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          ...whatsappConfig,\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast.success('Configuração do WhatsApp salva com sucesso!');\r\n        fetchConfigurations();\r\n      } else {\r\n        const data = await response.json();\r\n        toast.error(data.error || 'Erro ao salvar configuração');\r\n      }\r\n    } catch (error) {\r\n      toast.error('Erro ao salvar configuração');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveN8n = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const method = n8nConfig.id ? 'PATCH' : 'POST';\r\n      const url = n8nConfig.id\r\n        ? `/api/settings/n8n/${n8nConfig.id}`\r\n        : '/api/settings/n8n';\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          ...n8nConfig,\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast.success('Configuração do n8n salva com sucesso!');\r\n        fetchConfigurations();\r\n      } else {\r\n        const data = await response.json();\r\n        toast.error(data.error || 'Erro ao salvar configuração');\r\n      }\r\n    } catch (error) {\r\n      toast.error('Erro ao salvar configuração');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  // Abas de configurações: para admins, exibir apenas WhatsApp\r\n  const tabs = role === 'admin'\r\n    ? [{ id: 'whatsapp', label: 'WhatsApp', icon: MessageCircle }]\r\n    : [\r\n        { id: 'mercadopago', label: 'Mercado Pago', icon: CreditCard },\r\n        { id: 'whatsapp', label: 'WhatsApp', icon: MessageCircle },\r\n        { id: 'n8n', label: 'n8n/Moodle', icon: Webhook },\r\n      ];\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-brand-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6\">\r\n      {role !== 'admin' && (\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold\">Configurações</h1>\r\n            <p className=\"text-muted-foreground\">Configure integrações e webhooks</p>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n\r\n      {/* Tabs */}\r\n      {tabs.length > 1 && (\r\n        <div className=\"flex gap-2 border-b\">\r\n          {tabs.map((tab) => (\r\n            <button\r\n              key={tab.id}\r\n              onClick={() => setActiveTab(tab.id)}\r\n              className={`flex items-center gap-2 px-4 py-3 font-medium transition-colors ${\r\n                activeTab === tab.id\r\n                  ? 'border-b-2 border-brand-primary text-brand-primary'\r\n                  : 'text-muted-foreground hover:text-foreground'\r\n              }`}\r\n            >\r\n              <tab.icon className=\"h-4 w-4\" />\r\n              {tab.label}\r\n            </button>\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {/* Mercado Pago Tab */}\r\n      {activeTab === 'mercadopago' && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Configuração do Mercado Pago</CardTitle>\r\n            <CardDescription>\r\n              Integração global. Cadastre as credenciais abaixo ou valide o status.\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-4\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <div className=\"p-4 border rounded\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <span>Access Token (MP_ACCESS_TOKEN)</span>\r\n                    <Badge variant={mpStatus?.has_mp_access_token ? 'default' : 'destructive'}>\r\n                      {mpStatus?.has_mp_access_token ? 'Configurado' : 'Faltando'}\r\n                    </Badge>\r\n                  </div>\r\n                  {mpStatus?.masked_mp_access_token && (\r\n                    <code className=\"mt-2 block text-xs bg-white dark:bg-gray-800 p-2 rounded\">\r\n                      {mpStatus.masked_mp_access_token}\r\n                    </code>\r\n                  )}\r\n                  {mpGlobalConfig.masked_access_token && (\r\n                    <p className=\"mt-2 text-[11px] text-muted-foreground\">Banco: {mpGlobalConfig.masked_access_token}</p>\r\n                  )}\r\n                </div>\r\n                <div className=\"p-4 border rounded\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <span>APP_URL</span>\r\n                    <Badge variant={mpStatus?.has_app_url ? 'default' : 'destructive'}>\r\n                      {mpStatus?.has_app_url ? 'Configurado' : 'Faltando'}\r\n                    </Badge>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"p-4 border rounded\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span>Teste de Preferência</span>\r\n                  <Badge variant={mpStatus?.preference_test?.success ? 'default' : 'destructive'}>\r\n                    {mpStatus?.preference_test?.success ? 'Token válido' : 'Falhou'}\r\n                  </Badge>\r\n                </div>\r\n                {mpStatus?.preference_test && !mpStatus.preference_test.success && mpStatus.preference_test.error && (\r\n                  <p className=\"mt-2 text-xs text-muted-foreground\">Erro: {mpStatus.preference_test.error}</p>\r\n                )}\r\n                <div className=\"pt-4\">\r\n                  <Button\r\n                    onClick={handleTestMercadoPago}\r\n                    className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n                  >\r\n                    Re-testar\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n\r\n              {role === 'superadmin' && (\r\n                <form onSubmit={handleSaveMercadoPagoGlobal} className=\"space-y-4\">\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                      <Label htmlFor=\"mp_access_token\">Access Token *</Label>\r\n                      <Input\r\n                        id=\"mp_access_token\"\r\n                        type=\"password\"\r\n                        value={mpGlobalConfig.access_token}\r\n                        onChange={(e) => setMpGlobalConfig({ ...mpGlobalConfig, access_token: e.target.value })}\r\n                        placeholder=\"Insira o access token do Mercado Pago\"\r\n                        required\r\n                      />\r\n                      {mpGlobalConfig.masked_access_token && (\r\n                        <p className=\"text-xs text-muted-foreground\">Salvo: {mpGlobalConfig.masked_access_token}</p>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                      <Label htmlFor=\"mp_public_key\">Public Key (opcional)</Label>\r\n                      <Input\r\n                        id=\"mp_public_key\"\r\n                        type=\"password\"\r\n                        value={mpGlobalConfig.public_key}\r\n                        onChange={(e) => setMpGlobalConfig({ ...mpGlobalConfig, public_key: e.target.value })}\r\n                        placeholder=\"PUBLIC_KEY\"\r\n                      />\r\n                      {mpGlobalConfig.masked_public_key && (\r\n                        <p className=\"text-xs text-muted-foreground\">Salvo: {mpGlobalConfig.masked_public_key}</p>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                      <Label htmlFor=\"mp_webhook_secret\">Webhook Secret (opcional)</Label>\r\n                      <Input\r\n                        id=\"mp_webhook_secret\"\r\n                        type=\"password\"\r\n                        value={mpGlobalConfig.webhook_secret}\r\n                        onChange={(e) => setMpGlobalConfig({ ...mpGlobalConfig, webhook_secret: e.target.value })}\r\n                        placeholder=\"Segredo para validar webhooks\"\r\n                      />\r\n                      {mpGlobalConfig.masked_webhook_secret && (\r\n                        <p className=\"text-xs text-muted-foreground\">Salvo: {mpGlobalConfig.masked_webhook_secret}</p>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center gap-4\">\r\n                    <label className=\"flex items-center gap-2\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={mpGlobalConfig.is_production}\r\n                        onChange={(e) => setMpGlobalConfig({ ...mpGlobalConfig, is_production: e.target.checked })}\r\n                      />\r\n                      Produção\r\n                    </label>\r\n                    <label className=\"flex items-center gap-2\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={mpGlobalConfig.is_active}\r\n                        onChange={(e) => setMpGlobalConfig({ ...mpGlobalConfig, is_active: e.target.checked })}\r\n                      />\r\n                      Ativo\r\n                    </label>\r\n                  </div>\r\n\r\n                  <div className=\"pt-2\">\r\n                    <Button type=\"submit\" disabled={submitting} className=\"bg-brand-primary hover:bg-brand-primary/90\">\r\n                      {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                      <Save className=\"mr-2 h-4 w-4\" />\r\n                      Salvar Credenciais\r\n                    </Button>\r\n                  </div>\r\n                </form>\r\n              )}\r\n\r\n              <div className=\"mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-md\">\r\n                <h4 className=\"font-semibold mb-2\">URL do Webhook:</h4>\r\n                <code className=\"text-sm bg-white dark:bg-gray-800 p-2 rounded block\">\r\n                  {typeof window !== 'undefined' ? window.location.origin : ''}/api/webhooks/mercadopago\r\n                </code>\r\n                <p className=\"text-xs text-muted-foreground mt-2\">\r\n                  Configure esta URL nas notificações IPN do Mercado Pago. Você pode salvar as credenciais globalmente pelo painel (somente superadmin). Caso não haja configuração no banco, será usado MP_ACCESS_TOKEN do ambiente.\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* WhatsApp Tab */}\r\n      {activeTab === 'whatsapp' && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Configuração do WhatsApp (Evolution API)</CardTitle>\r\n            <CardDescription>\r\n              Configure a Evolution API para enviar mensagens automáticas via WhatsApp\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <form onSubmit={handleSaveWhatsApp} className=\"space-y-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"instance_name\">Nome da Instância *</Label>\r\n                <Input\r\n                  id=\"instance_name\"\r\n                  value={whatsappConfig.instance_name}\r\n                  onChange={(e) => setWhatsappConfig({ ...whatsappConfig, instance_name: e.target.value })}\r\n                  placeholder=\"minha-instancia\"\r\n                  required\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  Nome da instância configurada na Evolution API\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"api_url\">URL da API *</Label>\r\n                <Input\r\n                  id=\"api_url\"\r\n                  value={whatsappConfig.api_url}\r\n                  onChange={(e) => setWhatsappConfig({ ...whatsappConfig, api_url: e.target.value })}\r\n                  placeholder=\"https://evolution.seudominio.com\"\r\n                  required\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  URL base da sua Evolution API\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"api_key\">API Key *</Label>\r\n                <Input\r\n                  id=\"api_key\"\r\n                  type=\"password\"\r\n                  value={whatsappConfig.api_key}\r\n                  onChange={(e) => setWhatsappConfig({ ...whatsappConfig, api_key: e.target.value })}\r\n                  placeholder=\"B6D711FCDE4D4FD5936544120E713976\"\r\n                  required\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  Chave de autenticação da Evolution API\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={whatsappConfig.is_active}\r\n                  onChange={(e) => setWhatsappConfig({ ...whatsappConfig, is_active: e.target.checked })}\r\n                />\r\n                <span>Ativo</span>\r\n              </div>\r\n\r\n              {/* Área de Teste */}\r\n              <div className=\"pt-4 border-t\">\r\n                <h4 className=\"font-semibold mb-3\">Testar Conexão</h4>\r\n                <p className=\"text-sm text-muted-foreground mb-3\">\r\n                  Teste a conexão com a Evolution API e visualize as instâncias disponíveis.\r\n                </p>\r\n                \r\n                <Button\r\n                  type=\"button\"\r\n                  onClick={handleTestWhatsApp}\r\n                  disabled={whatsappTestLoading || !whatsappConfig.api_url || !whatsappConfig.api_key}\r\n                  variant=\"outline\"\r\n                  className=\"mb-4\"\r\n                >\r\n                  {whatsappTestLoading ? (\r\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                  ) : (\r\n                    <MessageCircle className=\"mr-2 h-4 w-4\" />\r\n                  )}\r\n                  Testar Conexão\r\n                </Button>\r\n\r\n                <Button\r\n                  type=\"button\"\r\n                  onClick={handleShowWhatsAppQr}\r\n                  disabled={whatsappQrLoading || !whatsappConfig.api_url || !whatsappConfig.api_key || !whatsappConfig.instance_name}\r\n                  variant=\"outline\"\r\n                  className=\"mb-4 ml-2\"\r\n                >\r\n                  {whatsappQrLoading ? (\r\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                  ) : (\r\n                    <QrCode className=\"mr-2 h-4 w-4\" />\r\n                  )}\r\n                  Mostrar QR Code\r\n                </Button>\r\n\r\n                {/* Resultados do Teste */}\r\n                {whatsappTestResult && (\r\n                  <div className={`p-4 rounded-md ${whatsappTestResult.success ? 'bg-green-50 dark:bg-green-900/20 border border-green-200' : 'bg-red-50 dark:bg-red-900/20 border border-red-200'}`}>\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      {whatsappTestResult.success ? (\r\n                        <CheckCircle className=\"h-5 w-5 text-green-600\" />\r\n                      ) : (\r\n                        <XCircle className=\"h-5 w-5 text-red-600\" />\r\n                      )}\r\n                      <span className={`font-semibold ${whatsappTestResult.success ? 'text-green-800' : 'text-red-800'}`}>\r\n                        {whatsappTestResult.success ? 'Conexão bem-sucedida!' : 'Erro na conexão'}\r\n                      </span>\r\n                    </div>\r\n                    \r\n                    {whatsappTestResult.success ? (\r\n                      <div className=\"space-y-2\">\r\n                        <p className=\"text-sm text-gray-700 dark:text-gray-300\">\r\n                          {whatsappTestResult.message}\r\n                        </p>\r\n                        <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                          <div>\r\n                            <span className=\"font-medium\">Total de Instâncias:</span>\r\n                            <span className=\"ml-2\">{whatsappTestResult.total_instances}</span>\r\n                          </div>\r\n                          <div>\r\n                            <span className=\"font-medium\">Conectadas:</span>\r\n                            <span className=\"ml-2 text-green-600\">{whatsappTestResult.connected_instances}</span>\r\n                          </div>\r\n                        </div>\r\n                        \r\n                        {whatsappTestResult.instances && whatsappTestResult.instances.length > 0 && (\r\n                          <div className=\"mt-3\">\r\n                            <h5 className=\"font-medium mb-2\">Instâncias Encontradas:</h5>\r\n                            <div className=\"space-y-2 max-h-40 overflow-y-auto\">\r\n                              {whatsappTestResult.instances.map((instance: any, index: number) => (\r\n                                <div key={index} className=\"flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded border\">\r\n                                  <div>\r\n                                    <div className=\"font-medium text-sm\">{instance.name}</div>\r\n                                    <div className=\"text-xs text-gray-500\">{instance.number}</div>\r\n                                  </div>\r\n                                  {(() => {\r\n                                    const connectionLabel = (instance.connectionStatus ?? instance.status ?? 'unknown');\r\n                                    const statusLabel = (instance.status ?? 'unknown');\r\n                                    const conn = String(connectionLabel).toLowerCase();\r\n                                    const isConnected = conn === 'open' || conn === 'connected';\r\n                                    return (\r\n                                      <div className=\"flex items-center gap-2\">\r\n                                        <div className={`px-2 py-1 rounded text-xs font-medium ${\r\n                                          isConnected ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'\r\n                                        }`}>\r\n                                          Conexão: {connectionLabel}\r\n                                        </div>\r\n                                        <div className=\"px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100\">\r\n                                          Status: {statusLabel}\r\n                                        </div>\r\n                                      </div>\r\n                                    );\r\n                                  })()}\r\n                                </div>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    ) : (\r\n                      <p className=\"text-sm text-red-700 dark:text-red-300\">\r\n                        {whatsappTestResult.error}\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                )}\r\n\r\n                {/* QR Code da Instância */}\r\n                {whatsappQrData && (\r\n                  <div className={`mt-4 p-4 rounded-md ${whatsappQrData.success ? 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200' : 'bg-red-50 dark:bg-red-900/20 border border-red-200'}`}>\r\n                    {whatsappQrData.success ? (\r\n                      <div>\r\n                        <div className=\"flex items-center gap-2 mb-2\">\r\n                          <QrCode className=\"h-5 w-5 text-blue-600\" />\r\n                          <span className=\"font-semibold text-blue-800\">QR Code</span>\r\n                        </div>\r\n                        {whatsappQrData.qrcode_base64 ? (\r\n                          <div className=\"flex flex-col items-start\">\r\n                            <img\r\n                              src={`data:image/png;base64,${whatsappQrData.qrcode_base64}`}\r\n                              alt=\"QR Code WhatsApp\"\r\n                              className=\"border rounded p-2 bg-white dark:bg-gray-800\"\r\n                              style={{ maxWidth: 240 }}\r\n                            />\r\n                            <p className=\"mt-2 text-xs text-muted-foreground\">Escaneie este QR Code no WhatsApp para conectar.</p>\r\n                          </div>\r\n                        ) : (\r\n                          <p className=\"text-sm text-gray-700 dark:text-gray-300\">\r\n                            {whatsappQrData.message || 'Instância já conectada — QR Code não disponível.'}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                    ) : (\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <XCircle className=\"h-5 w-5 text-red-600\" />\r\n                        <p className=\"text-sm text-red-700 dark:text-red-300\">{whatsappQrData.error}</p>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"pt-4\">\r\n                <Button\r\n                  type=\"submit\"\r\n                  disabled={submitting}\r\n                  className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n                >\r\n                  {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                  <Save className=\"mr-2 h-4 w-4\" />\r\n                  Salvar Configuração\r\n                </Button>\r\n              </div>\r\n            </form>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* n8n Tab */}\r\n      {activeTab === 'n8n' && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Configuração n8n/Moodle</CardTitle>\r\n            <CardDescription>\r\n              Configure o webhook para enviar dados automaticamente para n8n (matrícula Moodle)\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <form onSubmit={handleSaveN8n} className=\"space-y-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"webhook_url\">URL do Webhook *</Label>\r\n                <Input\r\n                  id=\"webhook_url\"\r\n                  value={n8nConfig.webhook_url}\r\n                  onChange={(e) => setN8nConfig({ ...n8nConfig, webhook_url: e.target.value })}\r\n                  placeholder=\"https://n8n.seudominio.com/webhook/...\"\r\n                  required\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  URL do webhook do n8n que receberá os dados\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"auth_token\">Token de Autenticação (opcional)</Label>\r\n                <Input\r\n                  id=\"auth_token\"\r\n                  type=\"password\"\r\n                  value={n8nConfig.auth_token}\r\n                  onChange={(e) => setN8nConfig({ ...n8nConfig, auth_token: e.target.value })}\r\n                  placeholder=\"Bearer token...\"\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  Token para autenticação Bearer (se necessário)\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"timeout_seconds\">Timeout (segundos)</Label>\r\n                  <Input\r\n                    id=\"timeout_seconds\"\r\n                    type=\"number\"\r\n                    value={n8nConfig.timeout_seconds}\r\n                    onChange={(e) => setN8nConfig({ ...n8nConfig, timeout_seconds: parseInt(e.target.value) })}\r\n                    min=\"5\"\r\n                    max=\"120\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"max_retries\">Tentativas Máximas</Label>\r\n                  <Input\r\n                    id=\"max_retries\"\r\n                    type=\"number\"\r\n                    value={n8nConfig.max_retries}\r\n                    onChange={(e) => setN8nConfig({ ...n8nConfig, max_retries: parseInt(e.target.value) })}\r\n                    min=\"0\"\r\n                    max=\"10\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={n8nConfig.is_active}\r\n                  onChange={(e) => setN8nConfig({ ...n8nConfig, is_active: e.target.checked })}\r\n                />\r\n                <span>Ativo</span>\r\n              </div>\r\n\r\n              <div className=\"pt-4\">\r\n                <Button\r\n                  type=\"submit\"\r\n                  disabled={submitting}\r\n                  className=\"bg-brand-primary hover:bg-brand-primary/90\"\r\n                >\r\n                  {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                  <Save className=\"mr-2 h-4 w-4\" />\r\n                  Salvar Configuração\r\n                </Button>\r\n              </div>\r\n\r\n              <div className=\"mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-md\">\r\n                <h4 className=\"font-semibold mb-2\">Payload enviado:</h4>\r\n                <pre className=\"text-xs bg-white dark:bg-gray-800 p-3 rounded overflow-x-auto\">\r\n{`{\r\n  \"submission_id\": \"uuid\",\r\n  \"tenant_id\": \"uuid\",\r\n  \"tenant_name\": \"Nome do Polo\",\r\n  \"student_data\": {\r\n    \"nome\": \"João Silva\",\r\n    \"email\": \"joao@example.com\",\r\n    ...\r\n  },\r\n  \"payment_amount\": 150.00,\r\n  \"payment_date\": \"2025-11-05T...\",\r\n  \"form_title\": \"Inscrição 2025\"\r\n}`}\r\n                </pre>\r\n              </div>\r\n            </form>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\status-integracao\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":40,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1260,1263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1260,1263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { AlertCircle, CheckCircle, Loader2 } from 'lucide-react';\r\n\r\ntype StatusResponse = {\r\n  env: { app_url_configured: boolean; mp_token_configured: boolean };\r\n  app_url: string | null;\r\n  app_url_error?: string | null;\r\n  mp_token_masked: string;\r\n  test_preference: {\r\n    success: boolean;\r\n    id?: string;\r\n    init_point?: string;\r\n    error?: string;\r\n    detail?: string;\r\n    meta?: { status?: number; code?: string; blocked_by?: string };\r\n  };\r\n};\r\n\r\nexport default function IntegrationStatusPage() {\r\n  const [loading, setLoading] = useState(false);\r\n  const [status, setStatus] = useState<StatusResponse | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const runCheck = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    setStatus(null);\r\n    try {\r\n      const res = await fetch('/api/integration/mercadopago/status');\r\n      const data = await res.json();\r\n      if (!res.ok) {\r\n        setError(data?.error || 'Falha ao verificar integração');\r\n      } else {\r\n        setStatus(data);\r\n      }\r\n    } catch (e: any) {\r\n      setError('Erro inesperado ao verificar integração');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-4xl mx-auto\">\r\n      <div className=\"mb-6\">\r\n        <h1 className=\"text-2xl font-semibold\">Status da Integração — Mercado Pago</h1>\r\n        <p className=\"text-sm text-muted-foreground\">Página para admins verificarem configuração e acesso à API.</p>\r\n      </div>\r\n\r\n      <div className=\"flex gap-3 mb-6\">\r\n        <Button onClick={runCheck} disabled={loading}>\r\n          {loading ? (\r\n            <span className=\"inline-flex items-center gap-2\"><Loader2 className=\"h-4 w-4 animate-spin\" /> Verificando...</span>\r\n          ) : (\r\n            'Verificar integração'\r\n          )}\r\n        </Button>\r\n      </div>\r\n\r\n      {error && (\r\n        <div className=\"mb-6 flex items-center gap-2 text-destructive\">\r\n          <AlertCircle className=\"h-5 w-5\" />\r\n          <span>{error}</span>\r\n        </div>\r\n      )}\r\n\r\n      {status && (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Variáveis de Ambiente</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              <div className=\"flex items-center gap-2\">\r\n                {status.env.app_url_configured ? (\r\n                  <CheckCircle className=\"h-5 w-5 text-emerald-600\" />\r\n                ) : (\r\n                  <AlertCircle className=\"h-5 w-5 text-destructive\" />\r\n                )}\r\n                <div>\r\n                  <div className=\"text-sm\">APP_URL</div>\r\n                  <div className=\"text-xs text-muted-foreground break-all\">{status.app_url || 'não configurado'}</div>\r\n                  {status.app_url_error && (\r\n                    <div className=\"text-xs text-destructive\">{status.app_url_error}</div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                {status.env.mp_token_configured ? (\r\n                  <CheckCircle className=\"h-5 w-5 text-emerald-600\" />\r\n                ) : (\r\n                  <AlertCircle className=\"h-5 w-5 text-destructive\" />\r\n                )}\r\n                <div>\r\n                  <div className=\"text-sm\">MP_ACCESS_TOKEN</div>\r\n                  <div className=\"text-xs text-muted-foreground\">{status.mp_token_masked}</div>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Teste de Preferência</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              {status.test_preference?.success ? (\r\n                <div className=\"flex items-start gap-2\">\r\n                  <CheckCircle className=\"h-5 w-5 text-emerald-600 mt-0.5\" />\r\n                  <div className=\"text-sm\">\r\n                    Preferência criada com sucesso. ID: {status.test_preference.id}\r\n                    <div className=\"text-xs break-all text-muted-foreground\">{status.test_preference.init_point}</div>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div className=\"flex items-start gap-2\">\r\n                  <AlertCircle className=\"h-5 w-5 text-destructive mt-0.5\" />\r\n                  <div>\r\n                    <div className=\"text-sm\">{status.test_preference?.error || 'Falha ao criar preferência'}</div>\r\n                    {status.test_preference?.detail && (\r\n                      <div className=\"text-xs text-muted-foreground\">{status.test_preference.detail}</div>\r\n                    )}\r\n                    {status.test_preference?.meta && (\r\n                      <div className=\"text-xs text-muted-foreground\">\r\n                        {Object.entries(status.test_preference.meta)\r\n                          .filter(([, v]) => v !== undefined && v !== null)\r\n                          .map(([k, v]) => `${k}: ${v}`)\r\n                          .join(' | ')}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\submissions\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Filter' is defined but never used.","line":25,"column":50,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDisplayValue' is defined but never used.","line":27,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":60},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[997,1000],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[997,1000],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":66,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2130,2133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2130,2133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3626,3629],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3626,3629],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":192,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6562,6565],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6562,6565],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":193,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6611,6614],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6611,6614],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":206,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":206,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7067,7070],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7067,7070],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":222,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7741,7744],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7741,7744],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchSubmissions'. Either include it or remove the dependency array.","line":266,"column":6,"nodeType":"ArrayExpression","endLine":266,"endColumn":57,"suggestions":[{"desc":"Update the dependencies array to be: [searchTerm, paymentStatusFilter, selectedTenantId, fetchSubmissions]","fix":{"range":[9398,9449],"text":"[searchTerm, paymentStatusFilter, selectedTenantId, fetchSubmissions]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":360,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":360,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12413,12416],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12413,12416],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Eye, Trash2, Loader2, Search, Download, Filter, File as FileIcon, FileText, FileImage, FileSpreadsheet, Link as LinkIcon } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { formatDate, formatDisplayLabel, formatDisplayValue, formatDisplayValueByKey, formatPhone } from '@/lib/utils';\r\n\r\ninterface Submission {\r\n  id: string;\r\n  data: Record<string, any>;\r\n  payment_status: string;\r\n  payment_amount: number | null;\r\n  created_at: string;\r\n  tenants: {\r\n    id: string;\r\n    name: string;\r\n    slug: string;\r\n  };\r\n  form_definitions: {\r\n    id: string;\r\n    name: string;\r\n  };\r\n}\r\n\r\ninterface Tenant {\r\n  id: string;\r\n  name: string;\r\n  slug: string;\r\n}\r\n\r\nexport default function SubmissionsPage() {\r\n  const [submissions, setSubmissions] = useState<Submission[]>([]);\r\n  const [total, setTotal] = useState(0);\r\n  const [loading, setLoading] = useState(true);\r\n  const [selectedSubmission, setSelectedSubmission] = useState<Submission | null>(null);\r\n  const [viewDialogOpen, setViewDialogOpen] = useState(false);\r\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\r\n  const [deletingSubmission, setDeletingSubmission] = useState<Submission | null>(null);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [showDocumentColumn, setShowDocumentColumn] = useState(true);\r\n\r\n  // Helpers locais para metadados de arquivo\r\n  type FileMeta = { name: string; size?: number; type?: string; url?: string; storagePath?: string };\r\n\r\n  const isFileMeta = (v: any): v is FileMeta => {\r\n    return v && typeof v === 'object' && 'name' in v && (('type' in v) || ('size' in v));\r\n  };\r\n\r\n  const getExtension = (name?: string) => {\r\n    if (!name) return '';\r\n    const parts = name.split('.');\r\n    return parts.length > 1 ? parts.pop()!.toLowerCase() : '';\r\n  };\r\n\r\n  const detectFileType = (meta?: FileMeta) => {\r\n    const mime = meta?.type?.toLowerCase() || '';\r\n    const ext = getExtension(meta?.name);\r\n    if (mime.includes('pdf') || ext === 'pdf') return 'pdf';\r\n    if (mime.includes('image/') || ['png','jpg','jpeg','gif','webp'].includes(ext)) return 'image';\r\n    if (mime.includes('sheet') || ['xls','xlsx','csv'].includes(ext)) return 'xls';\r\n    if (mime.includes('word') || ['doc','docx'].includes(ext)) return 'doc';\r\n    return 'other';\r\n  };\r\n\r\n  const formatBytes = (bytes?: number) => {\r\n    if (!bytes || bytes <= 0) return '-';\r\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\r\n    const i = Math.floor(Math.log(bytes) / Math.log(1024));\r\n    const value = bytes / Math.pow(1024, i);\r\n    return `${value.toFixed(value >= 100 ? 0 : value >= 10 ? 1 : 2)} ${sizes[i]}`;\r\n  };\r\n\r\n  const pickIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'pdf':\r\n        return FileText;\r\n      case 'doc':\r\n        return FileText;\r\n      case 'image':\r\n        return FileImage;\r\n      case 'xls':\r\n        return FileSpreadsheet;\r\n      default:\r\n        return FileIcon;\r\n    }\r\n  };\r\n\r\n  const findFirstFileMeta = (data: Record<string, any>): FileMeta | null => {\r\n    for (const key of Object.keys(data || {})) {\r\n      const val = data[key];\r\n      if (isFileMeta(val)) return val as FileMeta;\r\n      // Caso alguns projetos salvem como array\r\n      if (Array.isArray(val)) {\r\n        const first = val.find((v) => isFileMeta(v));\r\n        if (first) return first as FileMeta;\r\n      }\r\n    }\r\n    return null;\r\n  };\r\n\r\n  // Componente que resolve Signed URL e exibe href com domínio do Supabase\r\n  type IconType = React.ComponentType<{ className?: string }>;\r\n  const DocumentAnchor = ({\r\n    storagePath,\r\n    label,\r\n    Icon,\r\n    className,\r\n    title,\r\n  }: {\r\n    storagePath: string;\r\n    label: string;\r\n    Icon: IconType;\r\n    className?: string;\r\n    title?: string;\r\n  }) => {\r\n    const [href, setHref] = useState<string | null>(null);\r\n    const [loadingHref, setLoadingHref] = useState<boolean>(false);\r\n\r\n    useEffect(() => {\r\n      let active = true;\r\n      (async () => {\r\n        setLoadingHref(true);\r\n        let found: string | null = null;\r\n        try {\r\n          // 1) Tenta rota autenticada (funciona mesmo sem SERVICE ROLE, desde que usuário esteja logado)\r\n          const resAuth = await fetch(`/api/upload/signed-url?path=${encodeURIComponent(storagePath)}&format=json`);\r\n          if (resAuth.ok) {\r\n            const json = await resAuth.json();\r\n            found = json?.signedUrl || null;\r\n          }\r\n        } catch {}\r\n        if (!found) {\r\n          try {\r\n            // 2) Fallback: rota pública usando SERVICE ROLE\r\n            const resPublic = await fetch(`/api/public/upload/signed-url?path=${encodeURIComponent(storagePath)}&format=json`);\r\n            if (resPublic.ok) {\r\n              const json = await resPublic.json();\r\n              found = json?.signedUrl || null;\r\n            }\r\n          } catch {}\r\n        }\r\n        if (active) {\r\n          if (found) setHref(found);\r\n          setLoadingHref(false);\r\n        }\r\n      })();\r\n      return () => { active = false; };\r\n    }, [storagePath]);\r\n\r\n    // 3) Último recurso: redireciono para as rotas (uma delas deve resolver no servidor)\r\n    const fallbackPublic = `/api/public/upload/signed-url?path=${encodeURIComponent(storagePath)}`;\r\n    const fallbackAuth = `/api/upload/signed-url?path=${encodeURIComponent(storagePath)}`;\r\n    const linkHref = href || fallbackAuth || fallbackPublic;\r\n    return (\r\n      <a\r\n        href={linkHref}\r\n        target=\"_blank\"\r\n        rel=\"noopener noreferrer\"\r\n        className={`${className ?? ''} cursor-pointer ${loadingHref ? 'opacity-80' : ''}`}\r\n        title={title}\r\n        role=\"link\"\r\n        tabIndex={0}\r\n      >\r\n        <Icon className=\"h-4 w-4\" />\r\n        <span className=\"text-sm truncate max-w-[180px]\">{label}</span>\r\n      </a>\r\n    );\r\n  };\r\n\r\n  // Busca a primeira string que pareça uma URL de arquivo (registros antigos sem metadados)\r\n  const findFirstFileUrlString = (data: Record<string, any>): string | null => {\r\n    const isUrl = (s: any) => typeof s === 'string' && /^https?:\\/\\//.test(s);\r\n    for (const key of Object.keys(data || {})) {\r\n      const val = data[key];\r\n      if (isUrl(val)) return String(val);\r\n      if (Array.isArray(val)) {\r\n        const first = val.find((v) => isUrl(v));\r\n        if (first) return String(first);\r\n      }\r\n    }\r\n    return null;\r\n  };\r\n\r\n  // Detecta nome do aluno considerando variações de chave\r\n  const findStudentName = (data: Record<string, any>): string => {\r\n    const candidatesExact = ['nome_completo', 'nome', 'name', 'aluno', 'student_name'];\r\n    for (const k of candidatesExact) {\r\n      if (data?.[k]) return String(data[k]);\r\n    }\r\n    // Fallback: busca por chaves que contenham \"nome\" ou \"aluno\"\r\n    for (const key of Object.keys(data || {})) {\r\n      const lk = key.toLowerCase();\r\n      if ((lk.includes('nome') || lk.includes('aluno') || lk.includes('name')) && typeof data[key] === 'string' && data[key].trim()) {\r\n        return String(data[key]).trim();\r\n      }\r\n    }\r\n    return '';\r\n  };\r\n\r\n  // Detecta whatsapp/telefone considerando variações\r\n  const findWhatsapp = (data: Record<string, any>): string => {\r\n    const candidatesExact = ['whatsapp', 'telefone', 'phone', 'celular', 'telefone_whatsapp'];\r\n    for (const k of candidatesExact) {\r\n      if (data?.[k]) return String(data[k]);\r\n    }\r\n    // Fallback: busca por chaves relacionadas\r\n    for (const key of Object.keys(data || {})) {\r\n      const lk = key.toLowerCase();\r\n      if ((lk.includes('whats') || lk.includes('zap') || lk.includes('tel') || lk.includes('cel')) && typeof data[key] === 'string' && data[key].trim()) {\r\n        return String(data[key]).trim();\r\n      }\r\n    }\r\n    return '';\r\n  };\r\n\r\n  // Filtros\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [paymentStatusFilter, setPaymentStatusFilter] = useState('');\r\n  const [role, setRole] = useState<'superadmin' | 'admin' | 'user' | ''>('');\r\n  const [tenants, setTenants] = useState<Tenant[]>([]);\r\n  const [selectedTenantId, setSelectedTenantId] = useState<string>('');\r\n\r\n  // Carregar dados do usuário e polos (apenas para superadmin)\r\n  useEffect(() => {\r\n    const loadUserAndTenants = async () => {\r\n      try {\r\n        const res = await fetch('/api/users/me');\r\n        const data = await res.json();\r\n        const userRole = data?.user?.role ?? '';\r\n        setRole(userRole);\r\n        if (userRole === 'superadmin') {\r\n          const tRes = await fetch('/api/tenants');\r\n          const tData = await tRes.json();\r\n          if (tRes.ok) setTenants(tData?.tenants || []);\r\n        }\r\n      } catch (err) {\r\n        console.warn('Não foi possível carregar usuário/tenants', err);\r\n      }\r\n    };\r\n    loadUserAndTenants();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    fetchSubmissions();\r\n  }, [searchTerm, paymentStatusFilter, selectedTenantId]);\r\n\r\n  const fetchSubmissions = async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      const params = new URLSearchParams();\r\n      if (searchTerm) params.append('search', searchTerm);\r\n      if (paymentStatusFilter) params.append('payment_status', paymentStatusFilter);\r\n      if (selectedTenantId) params.append('tenant_id', selectedTenantId);\r\n      // Evitar retorno em cache e garantir atualização pós-exclusão\r\n      params.append('_ts', String(Date.now()));\r\n\r\n      const response = await fetch(`/api/submissions?${params.toString()}` , {\r\n        cache: 'no-store',\r\n        headers: { 'Cache-Control': 'no-cache' },\r\n      });\r\n      const data = await response.json();\r\n\r\n      if (response.ok) {\r\n        setSubmissions(data.submissions || []);\r\n        setTotal(data.total || 0);\r\n      } else {\r\n        toast.error(data.error || 'Erro ao carregar submissões');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching submissions:', error);\r\n      toast.error('Erro ao carregar submissões');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleViewSubmission = (submission: Submission) => {\r\n    setSelectedSubmission(submission);\r\n    setViewDialogOpen(true);\r\n  };\r\n\r\n  const handleDelete = async () => {\r\n    if (!deletingSubmission) return;\r\n\r\n    setSubmitting(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/submissions/${deletingSubmission.id}`, {\r\n        method: 'DELETE',\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast.success('Submissão deletada com sucesso!');\r\n        // Remover da lista local imediatamente (UX mais responsiva)\r\n        const deletedId = deletingSubmission.id;\r\n        setSubmissions((prev) => prev.filter((s) => s.id !== deletedId));\r\n        setTotal((prev) => Math.max(prev - 1, 0));\r\n        setDeleteDialogOpen(false);\r\n        setDeletingSubmission(null);\r\n        // Revalidar lista no servidor para consistência\r\n        await fetchSubmissions();\r\n      } else {\r\n        const data = await response.json();\r\n        toast.error(data.error || 'Erro ao deletar submissão');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error deleting submission:', error);\r\n      toast.error('Erro ao deletar submissão');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const exportToXLS = () => {\r\n    if (submissions.length === 0) {\r\n      toast.error('Nenhuma submissão para exportar');\r\n      return;\r\n    }\r\n\r\n    // Coletar todos os campos únicos\r\n    const allFields = new Set<string>();\r\n    submissions.forEach((sub) => {\r\n      Object.keys(sub.data).forEach((key) => allFields.add(key));\r\n    });\r\n\r\n    // Cabeçalhos da planilha (sem coluna de ID)\r\n    const headers = [\r\n      'Polo',\r\n      'Formulário',\r\n      'Nome Completo',\r\n      'Whatsapp',\r\n      ...Array.from(allFields).map((f) => formatDisplayLabel(f)),\r\n      'Status Pagamento',\r\n      'Valor',\r\n      'Data Submissão',\r\n    ];\r\n\r\n    const escapeHtml = (str: any) => String(str)\r\n      .replace(/&/g, '&amp;')\r\n      .replace(/</g, '&lt;')\r\n      .replace(/>/g, '&gt;');\r\n\r\n    const rowsHtml = submissions.map((sub) => {\r\n      const nomeCompleto = findStudentName(sub.data);\r\n      const whatsapp = findWhatsapp(sub.data);\r\n      const cells = [\r\n        sub.tenants.name,\r\n        sub.form_definitions.name,\r\n        nomeCompleto,\r\n        whatsapp ? formatDisplayValueByKey('whatsapp', whatsapp) : '',\r\n        ...Array.from(allFields).map((field) => {\r\n          const value = sub.data[field];\r\n          return formatDisplayValueByKey(field, value ?? '');\r\n        }),\r\n        getPaymentStatusLabel(sub.payment_status),\r\n        sub.payment_amount != null ? sub.payment_amount : '',\r\n        formatDate(sub.created_at),\r\n      ];\r\n      return `<tr>${cells.map((c) => `<td>${escapeHtml(c)}</td>`).join('')}</tr>`;\r\n    }).join('');\r\n\r\n    const tableHtml = `\r\n      <html xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\" xmlns=\"http://www.w3.org/TR/REC-html40\">\r\n        <head>\r\n          <meta charset=\"utf-8\" />\r\n        </head>\r\n        <body>\r\n          <table border=\"1\">\r\n            <thead><tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr></thead>\r\n            <tbody>\r\n              ${rowsHtml}\r\n            </tbody>\r\n          </table>\r\n        </body>\r\n      </html>`;\r\n\r\n    const blob = new Blob([tableHtml], { type: 'application/vnd.ms-excel' });\r\n    const link = document.createElement('a');\r\n    link.href = URL.createObjectURL(blob);\r\n    link.download = `submissions_${new Date().toISOString().split('T')[0]}.xls`;\r\n    link.click();\r\n\r\n    toast.success('XLS exportado com sucesso!');\r\n  };\r\n\r\n  const getPaymentStatusColor = (status: string) => {\r\n    const colors: Record<string, 'default' | 'success' | 'destructive' | 'secondary'> = {\r\n      PENDENTE: 'destructive',\r\n      PAGO: 'success',\r\n      CANCELADO: 'secondary',\r\n      NAO_APLICAVEL: 'default',\r\n    };\r\n    return colors[status] || 'default';\r\n  };\r\n\r\n  const getPaymentStatusLabel = (status: string) => {\r\n    const labels: Record<string, string> = {\r\n      PENDENTE: 'Pendente',\r\n      PAGO: 'Pago',\r\n      CANCELADO: 'Cancelado',\r\n      NAO_APLICAVEL: 'N/A',\r\n    };\r\n    return labels[status] || status;\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-brand-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">Submissões</h1>\r\n          <p className=\"text-muted-foreground\">Gerencie as inscrições e submissões de formulários</p>\r\n        </div>\r\n        <Button\r\n          onClick={exportToXLS}\r\n          variant=\"outline\"\r\n          disabled={submissions.length === 0}\r\n        >\r\n          <Download className=\"mr-2 h-4 w-4\" />\r\n          Exportar XLS\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filtros */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Filtros</CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label>Buscar</Label>\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder=\"Nome, email...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-10\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label>Status Pagamento</Label>\r\n              <select\r\n                value={paymentStatusFilter}\r\n                onChange={(e) => setPaymentStatusFilter(e.target.value)}\r\n                className=\"w-full px-3 py-2 text-sm border rounded-md\"\r\n              >\r\n                <option value=\"\">Todos</option>\r\n                <option value=\"PENDENTE\">Pendente</option>\r\n                <option value=\"PAGO\">Pago</option>\r\n                <option value=\"CANCELADO\">Cancelado</option>\r\n                <option value=\"NAO_APLICAVEL\">N/A</option>\r\n              </select>\r\n            </div>\r\n\r\n            {role === 'superadmin' && (\r\n              <div className=\"space-y-2\">\r\n                <Label>Polo</Label>\r\n                <select\r\n                  value={selectedTenantId}\r\n                  onChange={(e) => setSelectedTenantId(e.target.value)}\r\n                  className=\"w-full px-3 py-2 text-sm border rounded-md\"\r\n                >\r\n                  <option value=\"\">Todos</option>\r\n                  {tenants.map((t) => (\r\n                    <option key={t.id} value={t.id}>{t.name}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label>Coluna Documento</Label>\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <input\r\n                  id=\"doc-column\"\r\n                  type=\"checkbox\"\r\n                  checked={showDocumentColumn}\r\n                  onChange={(e) => setShowDocumentColumn(e.target.checked)}\r\n                />\r\n                <label htmlFor=\"doc-column\" className=\"cursor-pointer\">Mostrar coluna “Documento”</label>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-end\">\r\n              <Button\r\n                variant=\"outline\"\r\n                onClick={() => {\r\n                  setSearchTerm('');\r\n                  setPaymentStatusFilter('');\r\n                  setSelectedTenantId('');\r\n                }}\r\n              >\r\n                Limpar Filtros\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Tabela */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Lista de Submissões</CardTitle>\r\n          <CardDescription>\r\n            {total} {total === 1 ? 'submissão encontrada' : 'submissões encontradas'}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {submissions.length === 0 ? (\r\n            <div className=\"text-center py-12\">\r\n              <p className=\"text-muted-foreground\">Nenhuma submissão encontrada.</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"overflow-x-auto\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>Polo</TableHead>\r\n                    <TableHead>Aluno</TableHead>\r\n                    <TableHead>Whatsapp</TableHead>\r\n                    {showDocumentColumn && <TableHead>Documento</TableHead>}\r\n                    <TableHead>Pagamento</TableHead>\r\n                    <TableHead>Data</TableHead>\r\n                    <TableHead className=\"text-right\">Ações</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {submissions.map((submission) => {\r\n                    // Exibir somente o nome do aluno (coluna \"Aluno\")\r\n                    const studentName = findStudentName(submission.data);\r\n                    const whatsappRaw = findWhatsapp(submission.data);\r\n                    const fileMeta = findFirstFileMeta(submission.data);\r\n                    const fileUrlString = findFirstFileUrlString(submission.data);\r\n\r\n                    return (\r\n                      <TableRow key={submission.id}>\r\n                        <TableCell>\r\n                          <Badge variant=\"outline\">{submission.tenants.name}</Badge>\r\n                        </TableCell>\r\n                        <TableCell className=\"max-w-xs truncate\">{studentName || '-'}</TableCell>\r\n                        <TableCell className=\"max-w-xs truncate\">{whatsappRaw ? formatPhone(whatsappRaw) : '-'}</TableCell>\r\n                        {showDocumentColumn && (\r\n                          <TableCell>\r\n                            {fileMeta ? (() => {\r\n                              const t = detectFileType(fileMeta);\r\n                              const Icon = pickIcon(t);\r\n                              const label = fileMeta.name || 'Arquivo';\r\n                              const sizeLabel = formatBytes(fileMeta.size);\r\n\r\n                              // Caso exista storagePath, resolvemos Signed URL com domínio do Supabase via DocumentAnchor\r\n                              if (fileMeta.storagePath) {\r\n                                return (\r\n                                  <div className=\"flex items-center gap-2\">\r\n                                    <DocumentAnchor\r\n                                      storagePath={fileMeta.storagePath}\r\n                                      Icon={Icon}\r\n                                      label={label}\r\n                                      title={`${label} • ${sizeLabel}`}\r\n                                      className=\"inline-flex items-center gap-2 text-brand-primary underline\"\r\n                                    />\r\n                                  </div>\r\n                                );\r\n                              }\r\n\r\n                              // Se não houver storagePath mas houver URL, exibe link direto\r\n                              if (fileMeta.url) {\r\n                                // Tenta extrair storagePath de URL pública antiga do Supabase para também usar Signed URL\r\n                                const basePath = '/storage/v1/object/public/form-submissions/';\r\n                                const idx = fileMeta.url.indexOf(basePath);\r\n                                if (idx >= 0) {\r\n                                  const storageRel = fileMeta.url.substring(idx + basePath.length);\r\n                                  if (storageRel) {\r\n                                    return (\r\n                                      <div className=\"flex items-center gap-2\">\r\n                                        <DocumentAnchor\r\n                                          storagePath={storageRel}\r\n                                          Icon={Icon}\r\n                                          label={label}\r\n                                          title={`${label} • ${sizeLabel}`}\r\n                                          className=\"inline-flex items-center gap-2 text-brand-primary underline\"\r\n                                        />\r\n                                      </div>\r\n                                    );\r\n                                  }\r\n                                }\r\n\r\n                                return (\r\n                                  <div className=\"flex items-center gap-2\">\r\n                                    <a\r\n                                      href={fileMeta.url}\r\n                                      target=\"_blank\"\r\n                                      rel=\"noopener noreferrer\"\r\n                                      className=\"inline-flex items-center gap-2 text-brand-primary underline\"\r\n                                      title={`${label} • ${sizeLabel}`}\r\n                                    >\r\n                                      <Icon className=\"h-4 w-4\" />\r\n                                      <span className=\"text-sm truncate max-w-[180px]\">{label}</span>\r\n                                    </a>\r\n                                  </div>\r\n                                );\r\n                              }\r\n\r\n                              // Sem URL\r\n                              return (\r\n                                <div className=\"flex items-center gap-2\">\r\n                                  <Icon className=\"h-4 w-4 text-muted-foreground\" />\r\n                                  <span className=\"text-sm truncate max-w-[180px]\" title={`${label} • ${sizeLabel}`}>{label}</span>\r\n                                </div>\r\n                              );\r\n                            })() : fileUrlString ? (() => {\r\n                              const cleanUrl = fileUrlString.split('#')[0];\r\n                              const fileNameFromUrl = (cleanUrl.split('?')[0].split('/').pop() || 'Documento');\r\n\r\n                              // Se URL pública antiga do Supabase, extrai storagePath e usa DocumentAnchor\r\n                              const basePath = '/storage/v1/object/public/form-submissions/';\r\n                              const idx = cleanUrl.indexOf(basePath);\r\n                              if (idx >= 0) {\r\n                                const storageRel = cleanUrl.substring(idx + basePath.length);\r\n                                if (storageRel) {\r\n                                  const pseudoMeta: FileMeta = { name: fileNameFromUrl };\r\n                                  const t = detectFileType(pseudoMeta);\r\n                                  const Icon = pickIcon(t);\r\n                                  return (\r\n                                    <DocumentAnchor\r\n                                      storagePath={storageRel}\r\n                                      Icon={Icon}\r\n                                      label={fileNameFromUrl}\r\n                                      title={fileNameFromUrl}\r\n                                      className=\"inline-flex items-center gap-2 text-brand-primary underline\"\r\n                                    />\r\n                                  );\r\n                                }\r\n                              }\r\n\r\n                              // Caso contrário, mantém link direto\r\n                              const pseudoMeta: FileMeta = { name: fileNameFromUrl };\r\n                              const t = detectFileType(pseudoMeta);\r\n                              const Icon = pickIcon(t);\r\n                              return (\r\n                                <a\r\n                                  href={cleanUrl}\r\n                                  target=\"_blank\"\r\n                                  rel=\"noopener noreferrer\"\r\n                                  className=\"inline-flex items-center gap-2 text-brand-primary underline\"\r\n                                  title={fileNameFromUrl}\r\n                                >\r\n                                  <Icon className=\"h-4 w-4\" />\r\n                                  <span className=\"text-sm truncate max-w-[180px]\">{fileNameFromUrl}</span>\r\n                                </a>\r\n                              );\r\n                            })() : (\r\n                              <Badge variant=\"destructive\" className=\"text-xs\">Arquivo ausente — reenvio necessário</Badge>\r\n                            )}\r\n                          </TableCell>\r\n                        )}\r\n                        <TableCell>\r\n                          <Badge variant={getPaymentStatusColor(submission.payment_status)}>\r\n                            {getPaymentStatusLabel(submission.payment_status)}\r\n                          </Badge>\r\n                        </TableCell>\r\n                        <TableCell>{formatDate(submission.created_at)}</TableCell>\r\n                        <TableCell className=\"text-right space-x-2\">\r\n                          <Button\r\n                            variant=\"outline\"\r\n                            size=\"icon\"\r\n                            onClick={() => handleViewSubmission(submission)}\r\n                          >\r\n                            <Eye className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={() => {\r\n                              setDeletingSubmission(submission);\r\n                              setDeleteDialogOpen(true);\r\n                            }}\r\n                          >\r\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\r\n                          </Button>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    );\r\n                  })}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Dialog Ver Detalhes */}\r\n      <Dialog open={viewDialogOpen} onOpenChange={setViewDialogOpen}>\r\n        <DialogContent className=\"sm:max-w-3xl max-h-[90vh] overflow-y-auto p-6\">\r\n          <DialogHeader>\r\n            <DialogTitle>Detalhes da Submissão</DialogTitle>\r\n            <DialogDescription>\r\n            {selectedSubmission?.form_definitions.name} • {selectedSubmission?.tenants.name}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-6\">\r\n            {selectedSubmission && (\r\n              <>\r\n                <div className=\"grid grid-cols-2 gap-6\">\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Status Pagamento</Label>\r\n                    <div className=\"mt-1\">\r\n                      <Badge variant={getPaymentStatusColor(selectedSubmission.payment_status)}>\r\n                        {getPaymentStatusLabel(selectedSubmission.payment_status)}\r\n                      </Badge>\r\n                    </div>\r\n                  </div>\r\n                  {selectedSubmission.payment_amount && (\r\n                    <div>\r\n                      <Label className=\"text-muted-foreground\">Valor</Label>\r\n                      <p className=\"mt-1 font-semibold\">\r\n                        R$ {selectedSubmission.payment_amount.toFixed(2)}\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Data Submissão</Label>\r\n                    <p className=\"mt-1\">{formatDate(selectedSubmission.created_at)}</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"space-y-4\">\r\n                  <h3 className=\"font-semibold text-lg\">Dados do Formulário</h3>\r\n                  {Object.entries(selectedSubmission.data).map(([key, value]) => {\r\n                    const isString = typeof value === 'string';\r\n                    const valStr = isString ? value : '';\r\n                    const isUrlString = isString && /^https?:\\/\\//.test(valStr);\r\n                    const cleanUrl = isString ? valStr.split('#')[0] : '';\r\n                    const fileNameFromUrl = isString ? (cleanUrl.split('?')[0].split('/').pop() || '') : '';\r\n\r\n                    // Caso 1: metadados de arquivo (objeto)\r\n                    if (isFileMeta(value)) {\r\n                      const meta = value;\r\n                      const typeLabel = detectFileType(meta);\r\n                      const Icon = pickIcon(typeLabel);\r\n                      const sizeLabel = formatBytes(meta.size);\r\n                      const label = meta.name || 'Documento';\r\n                      return (\r\n                        <div key={key} className=\"grid grid-cols-2 md:grid-cols-3 gap-3 py-1\">\r\n                          <Label className=\"text-muted-foreground pr-2\">\r\n                            {formatDisplayLabel(key)}:\r\n                          </Label>\r\n                          <div className=\"col-span-1 md:col-span-2 font-medium break-words\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              {meta.storagePath ? (\r\n                                <DocumentAnchor\r\n                                  storagePath={meta.storagePath}\r\n                                  Icon={Icon}\r\n                                  label={label}\r\n                                  title={`${label} • ${typeLabel.toUpperCase()} • ${sizeLabel}`}\r\n                                  className=\"inline-flex items-center\"\r\n                                />\r\n                              ) : meta.url ? (\r\n                                (() => {\r\n                                  const basePath = '/storage/v1/object/public/form-submissions/';\r\n                                  const idx = meta.url.indexOf(basePath);\r\n                                  if (idx >= 0) {\r\n                                    const storageRel = meta.url.substring(idx + basePath.length);\r\n                                    if (storageRel) {\r\n                                      return (\r\n                                        <DocumentAnchor\r\n                                          storagePath={storageRel}\r\n                                          Icon={Icon}\r\n                                          label={label}\r\n                                          title={`${label} • ${typeLabel.toUpperCase()} • ${sizeLabel}`}\r\n                                          className=\"inline-flex items-center\"\r\n                                        />\r\n                                      );\r\n                                    }\r\n                                  }\r\n                                  return (\r\n                                    <a href={meta.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"inline-flex items-center\">\r\n                                      <Icon className=\"h-4 w-4\" />\r\n                                    </a>\r\n                                  );\r\n                                })()\r\n                              ) : (\r\n                                <Icon className=\"h-4 w-4 text-muted-foreground\" />\r\n                              )}\r\n                              <span className=\"truncate\" title={`${label} • ${typeLabel.toUpperCase()} • ${sizeLabel}`}>{label}</span>\r\n                            </div>\r\n                            <p className=\"text-xs text-muted-foreground mt-1\">Tipo: {typeLabel.toUpperCase()} • Tamanho: {sizeLabel}</p>\r\n                          </div>\r\n                        </div>\r\n                      );\r\n                    }\r\n\r\n                    // Caso 2: string com URL de arquivo (sem metadados estruturados)\r\n                    if (isUrlString) {\r\n                      const basePath = '/storage/v1/object/public/form-submissions/';\r\n                      const idx = valStr.indexOf(basePath);\r\n                      const storageRel = idx >= 0 ? valStr.substring(idx + basePath.length) : '';\r\n                      return (\r\n                        <div key={key} className=\"grid grid-cols-2 md:grid-cols-3 gap-3 py-1\">\r\n                          <Label className=\"text-muted-foreground pr-2\">\r\n                            {formatDisplayLabel(key)}:\r\n                          </Label>\r\n                          <div className=\"col-span-1 md:col-span-2 font-medium break-words\">\r\n                            {storageRel ? (\r\n                              <span className=\"text-brand-primary underline inline-flex items-center gap-2\">\r\n                                <DocumentAnchor\r\n                                  storagePath={storageRel}\r\n                                  Icon={LinkIcon}\r\n                                  label={fileNameFromUrl || 'Abrir documento'}\r\n                                  title={fileNameFromUrl || 'Abrir documento'}\r\n                                  className=\"inline-flex items-center gap-2\"\r\n                                />\r\n                              </span>\r\n                            ) : (\r\n                              <a\r\n                                href={valStr}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                className=\"text-brand-primary underline inline-flex items-center gap-2\"\r\n                              >\r\n                                <LinkIcon className=\"h-4 w-4\" />\r\n                                {fileNameFromUrl || 'Abrir documento'}\r\n                              </a>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      );\r\n                    }\r\n\r\n                    // Caso 3: valor comum\r\n                    return (\r\n                      <div key={key} className=\"grid grid-cols-2 md:grid-cols-3 gap-3 py-1\">\r\n                        <Label className=\"text-muted-foreground pr-2\">\r\n                          {formatDisplayLabel(key)}:\r\n                        </Label>\r\n                        <div className=\"col-span-1 md:col-span-2 font-medium break-words\">\r\n                          <p>{formatDisplayValueByKey(key, value)}</p>\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setViewDialogOpen(false)}>\r\n              Fechar\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Dialog Deletar */}\r\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Confirmar Exclusão</DialogTitle>\r\n            <DialogDescription>\r\n              Tem certeza que deseja deletar esta submissão? Esta ação não pode ser desfeita.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <DialogFooter>\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={() => setDeleteDialogOpen(false)}\r\n              disabled={submitting}\r\n            >\r\n              Cancelar\r\n            </Button>\r\n            <Button\r\n              variant=\"destructive\"\r\n              onClick={handleDelete}\r\n              disabled={submitting}\r\n            >\r\n              {submitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n              Deletar\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\app\\dashboard\\templates\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":50,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":50,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1811,1814],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1811,1814],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3150,3153],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3150,3153],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":114,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":114,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4343,4346],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4343,4346],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":127,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4610,4613],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4610,4613],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4661,4664],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4661,4664],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4999,5002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4999,5002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":140,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5193,5196],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5193,5196],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5411,5414],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5411,5414],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":149,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5598,5601],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5598,5601],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":195,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":195,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7611,7614],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7611,7614],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7941,7944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7941,7944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":251,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9490,9493],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9490,9493],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":262,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":262,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9845,9848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9845,9848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":278,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":278,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10578,10581],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10578,10581],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":288,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10908,10911],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10908,10911],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":350,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":350,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13299,13302],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13299,13302],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":364,"column":79,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[14273,14379],"text":"Observação: &quot;polo\" e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[14273,14379],"text":"Observação: &ldquo;polo\" e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[14273,14379],"text":"Observação: &#34;polo\" e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[14273,14379],"text":"Observação: &rdquo;polo\" e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":364,"column":84,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo&quot; e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo&ldquo; e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo&#34; e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo&rdquo; e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":364,"column":88,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e &quot;valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e &ldquo;valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e &#34;valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e &rdquo;valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":364,"column":94,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e \"valor&quot; são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e \"valor&ldquo; são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e \"valor&#34; são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[14273,14379],"text":"Observação: \"polo\" e \"valor&rdquo; são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":473,"column":72,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são &quot;payment_approved\" (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são &ldquo;payment_approved\" (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são &#34;payment_approved\" (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são &rdquo;payment_approved\" (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":473,"column":89,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved&quot; (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved&ldquo; (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved&#34; (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved&rdquo; (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":473,"column":104,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e &quot;payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e &ldquo;payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e &#34;payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e &rdquo;payment_approved_email\" (E-mail).\r\n      "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":1,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":473,"column":127,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e \"payment_approved_email&quot; (E-mail).\r\n      "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e \"payment_approved_email&ldquo; (E-mail).\r\n      "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e \"payment_approved_email&#34; (E-mail).\r\n      "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[19814,19961],"text":"\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e \"payment_approved_email&rdquo; (E-mail).\r\n      "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":26,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select } from \"@/components/ui/select\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { toast } from \"sonner\";\r\n\r\ntype Template = {\r\n  id: string;\r\n  tenant_id: string;\r\n  key: string; // trigger_event/key\r\n  title: string;\r\n  content: string;\r\n  variables: string[];\r\n  is_active: boolean;\r\n  created_at?: string;\r\n  updated_at?: string;\r\n};\r\n\r\nconst PRESET_KEYS = [\r\n  { value: \"payment_approved\", label: \"Pagamento aprovado (WhatsApp)\" },\r\n  { value: \"payment_approved_email\", label: \"Pagamento aprovado (E-mail)\" },\r\n  { value: \"payment_reminder\", label: \"Lembrete de pagamento (WhatsApp)\" },\r\n  { value: \"welcome\", label: \"Boas-vindas (WhatsApp)\" },\r\n  { value: \"manual\", label: \"Manual (WhatsApp/E-mail)\" },\r\n];\r\n\r\nfunction extractVariables(content: string): string[] {\r\n  const vars = new Set<string>();\r\n  const regex = /{{\\s*([a-zA-Z0-9_\\.]+)\\s*}}/g;\r\n  let match;\r\n  while ((match = regex.exec(content)) !== null) {\r\n    vars.add(match[1]);\r\n  }\r\n  return Array.from(vars);\r\n}\r\n\r\nexport default function TemplatesPage() {\r\n  const router = useRouter();\r\n  const [loading, setLoading] = useState<boolean>(true);\r\n  const [templates, setTemplates] = useState<Template[]>([]);\r\n  const [filterOnlyPayment, setFilterOnlyPayment] = useState<boolean>(true);\r\n  // Forms (para sugerir placeholders)\r\n  const [forms, setForms] = useState<any[]>([]);\r\n  const [selectedFormId, setSelectedFormId] = useState<string>(\"\");\r\n\r\n  // Create form state\r\n  const [newTitle, setNewTitle] = useState<string>(\"\");\r\n  const [newKey, setNewKey] = useState<string>(PRESET_KEYS[0].value);\r\n  const [newActive, setNewActive] = useState<boolean>(true);\r\n  const [newContent, setNewContent] = useState<string>(\"Olá {{nome_completo}}! Seu pagamento foi confirmado. Curso: {{curso}}. Polo: {{polo}}. Valor: {{valor}}.\");\r\n\r\n  // Edit state per template id\r\n  const [editing, setEditing] = useState<Record<string, boolean>>({});\r\n  const [editState, setEditState] = useState<Record<string, Partial<Template>>>({});\r\n\r\n  const filteredTemplates = useMemo(() => {\r\n    if (!filterOnlyPayment) return templates;\r\n    return templates.filter((t) => t.key === \"payment_approved\" || t.key === \"payment_approved_email\");\r\n  }, [templates, filterOnlyPayment]);\r\n\r\n  const keyAlreadyExists = useMemo(() => {\r\n    return templates.some((t) => t.key === newKey);\r\n  }, [templates, newKey]);\r\n\r\n  useEffect(() => {\r\n    setLoading(true);\r\n    fetch(`/api/templates`)\r\n      .then(async (r) => {\r\n        if (!r.ok) throw new Error(await r.text());\r\n        return r.json();\r\n      })\r\n      .then((payload) => {\r\n        const items = payload?.templates || [];\r\n        const mapped: Template[] = items.map((t: any) => ({\r\n          id: t.id,\r\n          tenant_id: t.tenant_id,\r\n          key: t.trigger_event ?? t.key,\r\n          title: t.name ?? t.title,\r\n          content: t.message_template ?? t.content,\r\n          variables: t.variables ?? [],\r\n          is_active: !!t.is_active,\r\n          created_at: t.created_at,\r\n        }));\r\n        setTemplates(mapped);\r\n      })\r\n      .catch((err) => {\r\n        console.error(\"Erro ao carregar templates\", err);\r\n        toast.error(\"Erro\", { description: \"Não foi possível carregar os templates.\" });\r\n      })\r\n      .finally(() => setLoading(false));\r\n  }, []);\r\n\r\n  // Carregar formulários para superadmin/admin (apenas nomes e campos)\r\n  useEffect(() => {\r\n    const loadForms = async () => {\r\n      try {\r\n        const r = await fetch('/api/forms');\r\n        if (!r.ok) return; // Não bloquear a página se não carregar\r\n        const payload = await r.json();\r\n        const list = payload?.forms || [];\r\n        setForms(list);\r\n      } catch (e) {\r\n        console.warn('Não foi possível carregar formulários para sugestão de placeholders');\r\n      }\r\n    };\r\n    loadForms();\r\n  }, []);\r\n\r\n  const selectedForm = useMemo(() => forms.find((f: any) => String(f.id) === String(selectedFormId)), [forms, selectedFormId]);\r\n\r\n  const suggestedPlaceholders = useMemo(() => {\r\n    const f = selectedForm;\r\n    if (!f?.form_fields) return [] as string[];\r\n    const names = (f.form_fields || [])\r\n      .filter((fld: any) => fld.is_active !== false)\r\n      .map((fld: any) => String(fld.name || \"\").trim())\r\n      .filter(Boolean);\r\n    // variáveis especiais sempre disponíveis no pós-pagamento\r\n    const special = ['polo', 'valor'];\r\n    return Array.from(new Set([...names, ...special]));\r\n  }, [selectedForm]);\r\n\r\n  // Heurística simples para escolher campos típicos\r\n  function pickFieldName(fields: any[], patterns: RegExp[], preferType?: string): string | undefined {\r\n    if (!fields) return undefined;\r\n    // 1) tentar por tipo\r\n    if (preferType) {\r\n      const byType = fields.find((f: any) => String(f.type).toLowerCase() === preferType);\r\n      if (byType?.name) return byType.name;\r\n    }\r\n    // 2) tentar por padrões em name/label\r\n    for (const p of patterns) {\r\n      const hit = fields.find((f: any) => p.test(String(f.name)) || p.test(String(f.label)));\r\n      if (hit?.name) return hit.name;\r\n    }\r\n    // 3) fallback: primeiro campo texto\r\n    const textField = fields.find((f: any) => String(f.type).toLowerCase() === 'text');\r\n    if (textField?.name) return textField.name;\r\n    return undefined;\r\n  }\r\n\r\n  function applyAutoFixPlaceholders() {\r\n    const fields = selectedForm?.form_fields || [];\r\n    const nameField = pickFieldName(fields, [/nome_completo/i, /nome/i, /name/i]);\r\n    const courseField = pickFieldName(fields, [/curso/i, /course/i]);\r\n    // telefone pode ser usado no disparo de WhatsApp, mas não é necessário no conteúdo\r\n    const baseSaudacao = `Olá {{${nameField || 'nome_completo'}}}! Seu pagamento foi confirmado.`;\r\n    const cursoParte = courseField ? ` Curso: {{${courseField}}}.` : '';\r\n    const extras = ` Polo: {{polo}}. Valor: {{valor}}.`;\r\n    const content = `${baseSaudacao}${cursoParte}${extras}`;\r\n    setNewContent(content);\r\n    toast.info('Placeholders ajustados', { description: 'Conteúdo atualizado com os campos do formulário selecionado.' });\r\n  }\r\n\r\n  async function onCreateTemplate() {\r\n    const variables = extractVariables(newContent);\r\n    try {\r\n      const r = await fetch(`/api/templates`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          name: newTitle || \"\",\r\n          trigger_event: newKey,\r\n          message_template: newContent,\r\n          is_active: newActive,\r\n          variables,\r\n        }),\r\n      });\r\n      if (!r.ok) {\r\n        const msg = await r.text();\r\n        throw new Error(msg);\r\n      }\r\n      toast.success(\"Template criado\", { description: \"O template foi criado com sucesso.\" });\r\n      // reset básico\r\n      setNewTitle(\"\");\r\n      setNewKey(PRESET_KEYS[0].value);\r\n      setNewActive(true);\r\n      setNewContent(\"Olá {{nome_completo}}! Seu pagamento foi confirmado. Curso: {{curso}}. Polo: {{polo}}. Valor: {{valor}}.\");\r\n      // reload\r\n      const refreshed = await fetch(`/api/templates`);\r\n      const payload = await refreshed.json();\r\n      const items = payload?.templates || [];\r\n      setTemplates(items.map((t: any) => ({\r\n        id: t.id,\r\n        tenant_id: t.tenant_id,\r\n        key: t.trigger_event ?? t.key,\r\n        title: t.name ?? t.title,\r\n        content: t.message_template ?? t.content,\r\n        variables: t.variables ?? [],\r\n        is_active: !!t.is_active,\r\n        created_at: t.created_at,\r\n      })));\r\n    } catch (err: any) {\r\n      console.error(\"Erro ao criar template\", err);\r\n      toast.error(\"Erro\", { description: err?.message || \"Falha ao criar template.\" });\r\n    }\r\n  }\r\n\r\n  function startEdit(t: Template) {\r\n    setEditing((prev) => ({ ...prev, [t.id]: true }));\r\n    setEditState((prev) => ({\r\n      ...prev,\r\n      [t.id]: {\r\n        title: t.title,\r\n        key: t.key,\r\n        is_active: t.is_active,\r\n        content: t.content,\r\n      },\r\n    }));\r\n  }\r\n\r\n  function cancelEdit(id: string) {\r\n    setEditing((prev) => ({ ...prev, [id]: false }));\r\n    setEditState((prev) => ({ ...prev, [id]: {} }));\r\n  }\r\n\r\n  async function saveEdit(t: Template) {\r\n    const changes = editState[t.id] || {};\r\n    const content = String(changes.content ?? t.content);\r\n    const variables = extractVariables(content);\r\n    try {\r\n      const r = await fetch(`/api/templates/${t.id}`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          title: changes.title ?? t.title,\r\n          trigger_event: changes.key ?? t.key,\r\n          content,\r\n          is_active: changes.is_active ?? t.is_active,\r\n          variables,\r\n        }),\r\n      });\r\n      if (!r.ok) throw new Error(await r.text());\r\n      toast.success(\"Template atualizado\", { description: \"Alterações salvas com sucesso.\" });\r\n      // reload\r\n      const refreshed = await fetch(`/api/templates`);\r\n      const payload = await refreshed.json();\r\n      const items = payload?.templates || [];\r\n      setTemplates(items.map((t: any) => ({\r\n        id: t.id,\r\n        tenant_id: t.tenant_id,\r\n        key: t.trigger_event ?? t.key,\r\n        title: t.name ?? t.title,\r\n        content: t.message_template ?? t.content,\r\n        variables: t.variables ?? [],\r\n        is_active: !!t.is_active,\r\n        created_at: t.created_at,\r\n      })));\r\n      cancelEdit(t.id);\r\n    } catch (err: any) {\r\n      console.error(\"Erro ao atualizar template\", err);\r\n      toast.error(\"Erro\", { description: err?.message || \"Falha ao salvar alterações.\" });\r\n    }\r\n  }\r\n\r\n  async function deleteTemplate(t: Template) {\r\n    if (!confirm(`Tem certeza que deseja excluir o template \"${t.title}\"?`)) return;\r\n    try {\r\n      const r = await fetch(`/api/templates/${t.id}`, { method: \"DELETE\" });\r\n      if (!r.ok) throw new Error(await r.text());\r\n      toast.success(\"Template excluído\", { description: \"O template foi removido.\" });\r\n      // reload\r\n      const refreshed = await fetch(`/api/templates`);\r\n      const payload = await refreshed.json();\r\n      const items = payload?.templates || [];\r\n      setTemplates(items.map((t: any) => ({\r\n        id: t.id,\r\n        tenant_id: t.tenant_id,\r\n        key: t.trigger_event ?? t.key,\r\n        title: t.name ?? t.title,\r\n        content: t.message_template ?? t.content,\r\n        variables: t.variables ?? [],\r\n        is_active: !!t.is_active,\r\n        created_at: t.created_at,\r\n      })));\r\n    } catch (err: any) {\r\n      console.error(\"Erro ao excluir template\", err);\r\n      toast.error(\"Erro\", { description: err?.message || \"Falha ao excluir template.\" });\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h1 className=\"text-2xl font-semibold\">Templates</h1>\r\n        <Link href={`/dashboard/messages`} className=\"text-sm text-blue-600 underline\">\r\n          Ir para Mensagens\r\n        </Link>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Filtros</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Switch checked={filterOnlyPayment} onCheckedChange={setFilterOnlyPayment} />\r\n            <Label>Mostrar apenas templates de pós-pagamento</Label>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Criar novo template</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <Label>Título</Label>\r\n              <Input value={newTitle} onChange={(e) => setNewTitle(e.target.value)} placeholder=\"Ex.: Pagamento Aprovado\" />\r\n            </div>\r\n            <div>\r\n              <Label>Disparo/Chave</Label>\r\n              <Select\r\n                value={newKey}\r\n                onChange={(e) => setNewKey(e.target.value)}\r\n                className=\"mt-1\"\r\n              >\r\n                {PRESET_KEYS.map((k) => (\r\n                  <option key={k.value} value={k.value}>{k.label}</option>\r\n                ))}\r\n              </Select>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Switch checked={newActive} onCheckedChange={setNewActive} />\r\n              <Label>Ativo</Label>\r\n            </div>\r\n            <div className=\"md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 border rounded p-3\">\r\n              <div className=\"md:col-span-1\">\r\n                <Label>Formulário de referência (opcional)</Label>\r\n                <Select\r\n                  value={selectedFormId}\r\n                  onChange={(e) => setSelectedFormId(e.target.value)}\r\n                  className=\"mt-1\"\r\n                >\r\n                  <option value=\"\">Selecionar…</option>\r\n                  {forms.map((f: any) => (\r\n                    <option key={f.id} value={f.id}>{f.name} {f.tenants?.name ? `(${f.tenants.name})` : '(Global)'}</option>\r\n                  ))}\r\n                </Select>\r\n                <p className=\"text-xs text-muted-foreground mt-2\">Sugestão rápida: escolha o formulário usado na cobrança para preencher os placeholders corretos.</p>\r\n              </div>\r\n              <div className=\"md:col-span-2\">\r\n                <Label>Placeholders sugeridos</Label>\r\n                <div className=\"text-sm mt-1\">\r\n                  {suggestedPlaceholders.length > 0 ? suggestedPlaceholders.join(', ') : 'Selecione um formulário para ver sugestões.'}\r\n                </div>\r\n                <div className=\"mt-2\">\r\n                  <Button variant=\"secondary\" onClick={applyAutoFixPlaceholders} disabled={!selectedFormId}>Corrigir placeholders automaticamente</Button>\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground mt-2\">Observação: \"polo\" e \"valor\" são variáveis especiais do fluxo de pós-pagamento e sempre estão disponíveis.</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"md:col-span-2\">\r\n              <Label>Conteúdo</Label>\r\n              <Textarea\r\n                value={newContent}\r\n                onChange={(e) => setNewContent(e.target.value)}\r\n                rows={8}\r\n                placeholder=\"Use placeholders como {{nome_completo}}, {{curso}}, {{polo}}, {{valor}}\"\r\n              />\r\n              <p className=\"text-xs text-muted-foreground mt-2\">\r\n                Placeholders detectados: {extractVariables(newContent).join(\", \") || \"nenhum\"}\r\n              </p>\r\n            </div>\r\n            <div>\r\n              <Button onClick={onCreateTemplate} disabled={keyAlreadyExists}>Criar template</Button>\r\n              {keyAlreadyExists && (\r\n                <p className=\"text-xs text-red-600 mt-1\">Já existe um template global com essa chave. Edite o existente ou escolha outra chave.</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Templates existentes</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {loading ? (\r\n            <p>Carregando...</p>\r\n          ) : filteredTemplates.length === 0 ? (\r\n            <p>Nenhum template encontrado.</p>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {filteredTemplates.map((t) => (\r\n                <div key={t.id} className=\"border rounded p-4\">\r\n                  {!editing[t.id] ? (\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-5 gap-2 items-start\">\r\n                      <div className=\"md:col-span-2\">\r\n                        <p className=\"font-medium\">{t.title}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">Chave: {t.key}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">Ativo: {t.is_active ? \"Sim\" : \"Não\"}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">Placeholders: {t.variables?.join(\", \") || \"-\"}</p>\r\n                      </div>\r\n                      <div className=\"md:col-span-3\">\r\n                        <pre className=\"text-sm whitespace-pre-wrap\">{t.content}</pre>\r\n                      </div>\r\n                      <div className=\"flex gap-2 mt-2 md:mt-0\">\r\n                        <Button variant=\"secondary\" onClick={() => startEdit(t)}>Editar</Button>\r\n                        <Button variant=\"destructive\" onClick={() => deleteTemplate(t)}>Excluir</Button>\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                          <Label>Título</Label>\r\n                          <Input\r\n                            value={String(editState[t.id]?.title ?? t.title)}\r\n                            onChange={(e) => setEditState((prev) => ({ ...prev, [t.id]: { ...prev[t.id], title: e.target.value } }))}\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Disparo/Chave</Label>\r\n                          <Select\r\n                            value={String(editState[t.id]?.key ?? t.key)}\r\n                            onChange={(e) => setEditState((prev) => ({ ...prev, [t.id]: { ...prev[t.id], key: e.target.value } }))}\r\n                            className=\"mt-1\"\r\n                          >\r\n                            {PRESET_KEYS.map((k) => (\r\n                              <option key={k.value} value={k.value}>{k.label}</option>\r\n                            ))}\r\n                          </Select>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Switch\r\n                            checked={Boolean(editState[t.id]?.is_active ?? t.is_active)}\r\n                            onCheckedChange={(v) => setEditState((prev) => ({ ...prev, [t.id]: { ...prev[t.id], is_active: v } }))}\r\n                          />\r\n                          <Label>Ativo</Label>\r\n                        </div>\r\n                        <div className=\"md:col-span-2\">\r\n                          <Label>Conteúdo</Label>\r\n                          <Textarea\r\n                            value={String(editState[t.id]?.content ?? t.content)}\r\n                            onChange={(e) => setEditState((prev) => ({ ...prev, [t.id]: { ...prev[t.id], content: e.target.value } }))}\r\n                            rows={8}\r\n                          />\r\n                          <p className=\"text-xs text-muted-foreground mt-2\">\r\n                            Placeholders detectados: {extractVariables(String(editState[t.id]?.content ?? t.content)).join(\", \") || \"nenhum\"}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex gap-2\">\r\n                        <Button onClick={() => saveEdit(t)}>Salvar</Button>\r\n                        <Button variant=\"secondary\" onClick={() => cancelEdit(t.id)}>Cancelar</Button>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <div className=\"text-xs text-muted-foreground\">\r\n        Dica: Os templates de pós-pagamento usados automaticamente são \"payment_approved\" (WhatsApp) e \"payment_approved_email\" (E-mail).\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\matte\\Desktop\\saas iwe\\IWE\\frontend\\lib\\mercadopago.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":73,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":79,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":79,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Biblioteca de inicialização do Mercado Pago (uso exclusivo em rotas server)\n// Não use tokens em código client. Leia sempre de variáveis de ambiente.\n\nimport { MercadoPagoConfig, Preference } from 'mercadopago';\nimport { createAdminClient } from '@/lib/supabase/admin';\n\nfunction getMandatoryEnv(name: string): string {\n  const value = process.env[name];\n  if (!value || value.trim() === '') {\n    throw new Error(`${name} não configurado. Defina em .env.local ou variáveis do ambiente de produção.`);\n  }\n  return value;\n}\n\nexport function getAppUrl(): string {\n  // Prefira APP_URL (server) e caia para NEXT_PUBLIC_APP_URL (client) somente se necessário\n  const serverUrl = process.env.APP_URL || process.env.NEXT_PUBLIC_APP_URL;\n  if (!serverUrl) {\n    throw new Error('APP_URL/NEXT_PUBLIC_APP_URL não configurado.');\n  }\n  return serverUrl.replace(/\\/$/, '');\n}\n\nexport function getPreferenceClient(): Preference {\n  const accessToken = getMandatoryEnv('MP_ACCESS_TOKEN');\n  const client = new MercadoPagoConfig({ accessToken });\n  return new Preference(client);\n}\n\n// Busca o access_token do Mercado Pago para um tenant específico na tabela mercadopago_configs.\n// Retorna null se não houver configuração ativa para o tenant.\nexport async function getAccessTokenForTenant(tenantId: string): Promise<string | null> {\n  const admin = createAdminClient();\n  const { data: cfg, error } = await admin\n    .from('mercadopago_configs')\n    .select('access_token, is_active')\n    .eq('tenant_id', tenantId)\n    .order('updated_at', { ascending: false })\n    .limit(1)\n    .maybeSingle();\n\n  if (error) {\n    console.error('[MP] Erro ao buscar configuração do tenant:', error.message);\n  }\n\n  if (!cfg) return null;\n  if (cfg.is_active === false) return null;\n  return cfg.access_token ?? null;\n}\n\n// Busca credenciais globais salvas no banco (escopo 'global').\nexport async function getGlobalAccessToken(): Promise<string | null> {\n  const admin = createAdminClient();\n  const { data: cfg, error } = await admin\n    .from('mercadopago_global_configs')\n    .select('access_token, is_active')\n    .eq('scope', 'global')\n    .limit(1)\n    .maybeSingle();\n  if (error) {\n    console.error('[MP] Erro ao buscar configuração global:', error.message);\n  }\n  if (!cfg) return null;\n  if (cfg.is_active === false) return null;\n  return cfg.access_token ?? null;\n}\n\n// Cria um client Preference priorizando credenciais globais; depois tenant; por fim variável de ambiente.\nexport async function getPreferenceClientForTenant(tenantId?: string): Promise<Preference> {\n  let token: string | null = null;\n  try {\n    token = await getGlobalAccessToken();\n  } catch (_err) {\n    console.warn('[MP] Falha ao obter token global, tentando tenant/env');\n  }\n  if (!token && tenantId) {\n    try {\n      token = await getAccessTokenForTenant(tenantId);\n    } catch (_err) {\n      console.warn('[MP] Falha ao obter token do tenant, usando fallback de ambiente');\n    }\n  }\n  const accessToken = token ?? getMandatoryEnv('MP_ACCESS_TOKEN');\n  const client = new MercadoPagoConfig({ accessToken });\n  return new Preference(client);\n}\n\nexport function maskToken(token?: string): string {\n  if (!token) return '**********';\n  const visible = 6;\n  return token.length > visible\n    ? `${token.slice(0, visible)}***`\n    : '**********';\n}","usedDeprecatedRules":[]}]
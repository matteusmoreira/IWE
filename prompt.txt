Quero que voc√™ desenvolva um **SaaS de educa√ß√£o multi-tenant (polos)**, com **formul√°rio p√∫blico, checkout Mercado Pago, status de pagamento, integra√ß√£o via n8n com Moodle**, e **disparo autom√°tico de WhatsApp** (Evolution API).
O sistema precisa ter **dashboard moderno, 100% responsivo, modo escuro**, e seguir as **cores do Manual da Marca IWE**.

---

## üéØ Objetivo de Neg√≥cio

Fluxo completo:

1. Usu√°rio acessa um **formul√°rio p√∫blico** (definido pelo admin do polo);
2. Preenche e √© redirecionado ao **checkout do Mercado Pago**;
3. Ap√≥s o pagamento, o sistema recebe o **webhook do MP**, marca o status **Pago** e dispara:

   * WhatsApp autom√°tico via **Evolution API**;
   * Webhook de sa√≠da para o **n8n**, que cria o usu√°rio no **Moodle** e faz a matr√≠cula;
4. Admins e superadmin acompanham no **dashboard** (filtrar, editar, excluir, exportar CSV);
5. Sistema √© **multi-tenant (polos)**, com **superadmin / admin / usu√°rio**.

---

## üß© Pap√©is e Permiss√µes

* **Superadmin**: CRUD de polos (tenants), admins, templates, auditoria, m√©tricas gerais.
* **Admin (polo)**: criar/editar formul√°rios, templates WhatsApp, configura√ß√µes de integra√ß√£o (MP, Evolution, n8n), visualizar e gerenciar alunos.
* **Usu√°rio (aluno)**: s√≥ preenche o formul√°rio p√∫blico e faz o pagamento.

---

## üèóÔ∏è Estrutura Multi-tenant

* Entidade **Tenant (Polo)**: `id`, `name`, `slug`, `status`, `created_at`.
* Todos os registros chave (formul√°rios, submissions, configs, mensagens) t√™m `tenant_id`.
* Superadmin enxerga tudo; admin apenas os tenants vinculados.

---

## üß± Entidades Principais

* **User**: `id`, `name`, `email`, `phone`, `role` (superadmin/admin), `password_hash`, `is_active`.
* **Tenant**: conforme acima.
* **AdminTenant**: rela√ß√£o N:N (um admin pode gerir v√°rios polos).
* **FormDefinition**: `id`, `tenant_id`, `name`, `slug_public_url`, `redirect_url_after_flow`, `is_active`.
* **FormField**: `id`, `form_definition_id`, `label`, `name`, `type` (text/email/phone/select/date/file/checkbox), `required`, `options` (JSON), `order`.
* **Submission**: `id`, `tenant_id`, `form_definition_id`, `data` (JSON), `polo`, `payment_status` (PENDENTE|PAGO), `payment_provider` (mercadopago), `payment_reference`, `payment_external_id`, `created_at`, `updated_at`.
* **PaymentEvent**: para idempot√™ncia de webhooks MP.
* **WhatsConfig** (por tenant): `api_base_url`, `instance_id`, `token`, `default_sender`, `is_active`.
* **MessageTemplate** (por tenant): `id`, `key`, `title`, `content` (placeholders `{{nome}}`, `{{curso}}`, `{{polo}}`, etc).
* **MessageLog**: hist√≥rico de disparos WhatsApp.
* **ScheduleJob**: agendamento de disparos.
* **OutboundWebhookConfig** (por tenant): `enrollment_webhook_url`, `enrollment_webhook_token`, `timeout_ms`, `retries`.
* **EnrollmentLog**: `id`, `tenant_id`, `submission_id`, `status` (QUEUED|DONE|FAILED), `request_payload`, `response_payload`, `error`, `created_at`.

---

## üí≥ Fluxo de Pagamento (Mercado Pago)

1. Usu√°rio envia formul√°rio ‚Üí cria `Submission` com status **PENDENTE**.
2. Cria `Preference` no Mercado Pago (`metadata: { submission_id, tenant_id }`).
3. Redireciona para checkout do MP.
4. Webhook do MP (`POST /webhooks/mercadopago`):

   * Verifica assinatura e idempot√™ncia.
   * Se `approved`, marca `Submission.payment_status = PAGO`.
   * Dispara:

     * Mensagem WhatsApp autom√°tica (Evolution API);
     * Webhook para o n8n com dados do usu√°rio.
   * Atualiza `PaymentEvent` e `EnrollmentLog`.

---

## ü§ñ Integra√ß√£o via n8n (Moodle)

**Fluxo:**

* Ap√≥s marcar `PAGO`, o sistema envia `POST` para a URL configurada em `enrollment_webhook_url` do tenant, com token `enrollment_webhook_token`.

**Payload exemplo:**

```json
{
  "event": "payment.approved",
  "timestamp": "2025-11-04T23:15:00Z",
  "tenant": { "id": "polo-mg", "name": "Polo Minas Gerais" },
  "submission": {
    "id": "subm_123",
    "payment_status": "PAGO",
    "data": {
      "nome_completo": "Maria Silva",
      "email": "maria@email.com",
      "telefone": "55999999999",
      "curso": "Teologia B√°sica",
      "polo": "Minas Gerais"
    }
  },
  "redirect_url_after_flow": "https://site.com.br/obrigado"
}
```

**n8n:**

1. Recebe o webhook;
2. Separa nome em primeiro/sobrenome;
3. Chama API do Moodle (`core_user_create_users` e `enrol_manual_enrol_users`);
4. Retorna JSON com status;
5. O sistema registra o resultado em `EnrollmentLog`.

---

## üí¨ Integra√ß√£o WhatsApp (Evolution API)

* Config por tenant: `api_base_url`, `instance_id`, `token`.
* Ao receber pagamento **PAGO**, dispara mensagem com template configurado.
* Mensagem usa placeholders din√¢micos:
  ‚ÄúOl√° {{nome_completo}}, seu pagamento foi confirmado! Bem-vindo ao curso {{curso}} no polo {{polo}}.‚Äù
* Admin pode testar, editar e criar templates no painel.
* Logs de disparos em `MessageLog`.

---

## üñ•Ô∏è Dashboard e UI

### Layout

* **Responsivo e moderno**, com **dark mode** por classe `.dark`.
* **Cores (Manual da Marca IWE)**:

  * Prim√°ria: `#141B4D`
  * Neutra clara: `#DBE2E9`
  * Acento (alertas e destaques): `#E73C3E`
* **Tipografia**: Montserrat.
* **Tokens CSS**:

  ```css
  :root {
    --brand-primary: #141B4D;
    --brand-muted: #DBE2E9;
    --brand-accent: #E73C3E;
    --bg: #ffffff;
    --fg: #0f1222;
    --chip-paid-bg: #e6ffed;
    --chip-pending-bg: #fff7e6;
  }
  .dark {
    --bg: #0A0C1A;
    --fg: #E9ECF5;
    --brand-muted: #1f2438;
  }
  ```

### Telas

1. **Login / Recuperar senha**
2. **Dashboard principal** (cards: total cadastros, pagos, convers√£o, por polo)
3. **Submissions** (alunos)

   * Colunas din√¢micas dos campos do formul√°rio
   * Filtros (polo, status, per√≠odo, busca)
   * A√ß√µes: Editar / Excluir / Exportar CSV
4. **Form Builder**

   * Drag & drop para criar campos (text/email/telefone/select)
   * Slug p√∫blico e URL de redirecionamento p√≥s-pagamento
5. **Configura√ß√µes do Polo**

   * Aba ‚ÄúPagamentos‚Äù ‚Üí Mercado Pago
   * Aba ‚ÄúWhatsApp‚Äù ‚Üí Evolution API
   * Aba ‚ÄúIntegra√ß√µes‚Äù ‚Üí webhook do n8n
6. **Templates WhatsApp**

   * CRUD + teste
7. **Disparos**

   * Selecionar usu√°rios, enviar mensagem manual ou agendar
8. **Auditoria**

   * Hist√≥rico de a√ß√µes
9. **Superadmin**

   * Gest√£o de polos e admins.

---

## ‚öôÔ∏è API (REST + JWT + Swagger)

Principais rotas:

* `POST /api/v1/auth/login`
* `GET /api/v1/tenants`
* `GET /api/v1/forms/{tenantId}`
* `POST /api/v1/forms`
* `POST /forms/{tenantSlug}/{formSlug}/submit`
* `POST /webhooks/mercadopago`
* `POST /api/v1/whatsapp/send`
* `POST /api/v1/whatsapp/schedule`
* `POST /webhooks/out/enrollment` (para o n8n)
* `GET /api/v1/submissions`
* `PATCH /api/v1/submissions/{id}`

---

## üîê Seguran√ßa

* JWT Auth e Row-Level Security (`tenant_id`).
* Valida√ß√£o e sanitiza√ß√£o de campos do formul√°rio.
* Webhooks assinados e verificados (Mercado Pago + sa√≠da n8n).
* Retry/backoff para falhas em chamadas externas.
* AuditLog com IP, usu√°rio e a√ß√£o.
* Rate limiting em rotas p√∫blicas.

---

## üß† Stack Sugerida

* **Backend:** Supabase
* **Frontend:** Next.js + React + Tailwind + shadcn/ui
* **Documenta√ß√£o API:** Swagger/OpenAPI

---

## ‚úÖ Crit√©rios de Aceite (DoD)

1. Superadmin cria um **Polo** e um **Admin** vinculado.
2. Admin cria um **formul√°rio p√∫blico** e define `redirect_url_after_flow`.
3. Usu√°rio acessa o link, preenche e √© redirecionado ao **checkout Mercado Pago**.
4. Ap√≥s pagar, webhook marca como **PAGO**.
5. Dispara WhatsApp autom√°tico (Evolution API).
6. Envia webhook de sa√≠da para o **n8n**, que cria o aluno no Moodle.
7. Dashboard mostra o aluno com status atualizado.
8. Admin pode editar, excluir, exportar CSV, filtrar por polo/status.
9. Superadmin visualiza todos os polos.
10. Layout segue **cores IWE**, **modo escuro funcional**, e **100% responsivo**.

---

Implemente todo o sistema com base nestas especifica√ß√µes, mantendo c√≥digo limpo, seguro e preparado para escalar.
